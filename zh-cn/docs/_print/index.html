<!doctype html><html lang=zh-cn class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.91.2">
<link rel=canonical type=text/html href=/zh-cn/docs/>
<meta name=robots content="noindex, nofollow">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>文档 | Clusterpedia.io</title>
<meta name=description content>
<meta property="og:title" content="文档">
<meta property="og:description" content="Clusterpedia 的官网">
<meta property="og:type" content="website">
<meta property="og:url" content="/zh-cn/docs/"><meta property="og:site_name" content="Clusterpedia.io">
<meta itemprop=name content="文档">
<meta itemprop=description content="Clusterpedia 的官网"><meta name=twitter:card content="summary">
<meta name=twitter:title content="文档">
<meta name=twitter:description content="Clusterpedia 的官网">
<link rel=preload href=/scss/main.min.73045c8236ac0eff5872b331509c9baa375a47c43567fa214b7e8cd464d45073.css as=style>
<link href=/scss/main.min.73045c8236ac0eff5872b331509c9baa375a47c43567fa214b7e8cd464d45073.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script>
<link href=https://cdn.bootcdn.net/ajax/libs/asciinema-player/2.6.1/asciinema-player.min.css rel=stylesheet>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NZQPMJ4HH3"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-NZQPMJ4HH3',{anonymize_ip:!1})}</script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/zh-cn/>
<span class=navbar-logo><svg id="Graph" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><g id="Cpedia_-_Graph_-_Color_Dark" data-name="Cpedia - Graph - Color Dark"><rect id="Frame" width="512" height="512" fill="none"/><path id="Secondary" d="M476 221.051A274.908 274.908.0 00428.269 256 282.438 282.438.0 01395.7 220.752a322.971 322.971.0 0156.3-41.27zM362.4 256a334.139 334.139.0 00-53.2 92.145A329.953 329.953.0 00295.32 394.6a322.932 322.932.0 00-7.587 69.4h48a274.957 274.957.0 016.4-58.813 282.32 282.32.0 0114.238-45.835 285.94 285.94.0 0139.323-68.1A330.2 330.2.0 01362.4 256zM169.865 405.189a274.9 274.9.0 016.4 58.811h48a322.893 322.893.0 00-7.589-69.4 282.46 282.46.0 00-46.811 10.589zM179.94 300.03A333.961 333.961.0 00149.6 256a330 330 0 00-33.291-35.248A322.915 322.915.0 0060 179.482L36 221.051A274.964 274.964.0 0183.733 256a282.3 282.3.0 0132.576 35.248 286.331 286.331.0 0122.054 32.768 286.3 286.3.0 0117.264 35.339A330.144 330.144.0 01202.8 348.148 334.156 334.156.0 00179.94 300.03zM169.865 106.811a274.966 274.966.0 01-54.132-23.862l-24 41.569a322.934 322.934.0 0063.894 28.127 282.241 282.241.0 0014.238-45.834zm186.507 45.836a322.994 322.994.0 0063.895-28.129l-24-41.569a275.02 275.02.0 01-54.133 23.864A282.293 282.293.0 01295.32 117.4a286.278 286.278.0 01-39.307 2.716h-.1a286.366 286.366.0 01-39.237-2.718 330.245 330.245.0 01-13.88 46.455 334.129 334.129.0 0053.1 4.263h.115a333.931 333.931.0 0053.187-4.261 329.92 329.92.0 0047.174-11.208z" fill="#1b1c1d"/><path id="Primary" d="M211.993 256l22-38.1h44l22 38.1-22 38.105h-44zM342.134 106.813A274.957 274.957.0 01335.733 48h-48a322.932 322.932.0 007.587 69.4 282.293 282.293.0 0046.814-10.587zM428.269 256A282.438 282.438.0 01395.7 220.752a285.92 285.92.0 01-39.323-68.105A329.92 329.92.0 01309.2 163.854 334.125 334.125.0 00362.4 256a330.2 330.2.0 0033.3 35.248 322.971 322.971.0 0056.3 41.27l24-41.569A274.908 274.908.0 01428.269 256zM149.6 256a333.961 333.961.0 0030.34-44.03 334.156 334.156.0 0022.86-48.118 330.245 330.245.0 0013.88-46.455A322.893 322.893.0 00224.267 48h-48a274.9 274.9.0 01-6.4 58.811 282.241 282.241.0 01-14.238 45.834 286.3 286.3.0 01-17.264 35.339 286.331 286.331.0 01-22.054 32.768A330 330 0 01149.6 256zm-65.867.0A274.964 274.964.0 0136 290.949l24 41.569a322.915 322.915.0 0056.309-41.27A282.3 282.3.0 0083.733 256zM255.9 343.885a334.129 334.129.0 00-53.1 4.263 330.144 330.144.0 00-47.171 11.207 322.934 322.934.0 00-63.894 28.127l24 41.569a274.966 274.966.0 0154.132-23.862A282.46 282.46.0 01216.678 394.6a286.366 286.366.0 0139.237-2.718h.1A286.278 286.278.0 01295.32 394.6a329.953 329.953.0 0113.88-46.456 334.028 334.028.0 00-53.187-4.26zm86.236 61.3a275.027 275.027.0 0154.133 23.864l24-41.569a322.991 322.991.0 00-63.895-28.13 282.32 282.32.0 00-14.24 45.837z" fill="#33de72"/></g></svg></span><span class=font-weight-bold>Clusterpedia.io</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/zh-cn/about/><span>关于</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/zh-cn/blog/><i class="fas fa-blog"></i><span>博客</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/zh-cn/docs/><i class="fas fa-book"></i><span class=active>文档</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=https://github.com/clusterpedia-io/clusterpedia target=_blank><i class="fab fa-github"></i><span>GitHub</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=https://cloud-native.slack.com/messages/clusterpedia target=_blank><i class="fab fa-slack"></i><span>Slack</span></a>
</li>
<li class="nav-item dropdown mr-4 d-none d-lg-block">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中文 Chinese
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/docs/>English</a>
</div>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/offline-search-index.f552868f8be240a4ea8cec7150f7a297.json data-offline-search-base-href=/ data-offline-search-max-results=10>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/zh-cn/docs/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>文档</h1>
<ul>
<li>1: <a href=#pg-273a1d3f87830cbffaaf95a64d1ab7e6>安装</a></li>
<ul>
<li>1.1: <a href=#pg-9c8311e1b4822b2005012bd9c3815fa7>使用 kubectl apply</a></li>
<li>1.2: <a href=#pg-8aa1a9a3bda410f713c9c386ab4e389b>使用 Helm</a></li>
<li>1.3: <a href=#pg-600ec9bf13955a06b6a5f5bdc2d718ac>配置</a></li>
<ul>
<li>1.3.1: <a href=#pg-bc917736d18b8a8273b54276076451f5>配置存储层</a></li>
</ul>
</ul>
<li>2: <a href=#pg-dd948255948d6b59b32c471abcb62997>概念</a></li>
<ul>
<li>2.1: <a href=#pg-911128911953cea7ceaaad409a1badf1>PediaCluster</a></li>
<li>2.2: <a href=#pg-90ee9ed4f8367758c09e96dc82d2a800>公共的集群资源同步配置(ClusterSyncResources)</a></li>
<li>2.3: <a href=#pg-40243a331b263af5e1b61fd771638878>聚合资源(Collection Resource)</a></li>
<li>2.4: <a href=#pg-d8808d404dd9644ce0c0ae679468c3a2>集群自动接入策略(ClusterImportPolicy)</a></li>
</ul>
<li>3: <a href=#pg-ec5a5e9379174e59d723f74f5206953c>使用</a></li>
<ul>
<li>3.1: <a href=#pg-926b93f86224309ec4277c2c1b97fe8c>集群接入</a></li>
<li>3.2: <a href=#pg-3fe23ba64b8bbae5fab0c8696ae005cb>接入多云平台</a></li>
<li>3.3: <a href=#pg-64bebf7ca20899cc843d095cee1d0313>同步集群资源</a></li>
<li>3.4: <a href=#pg-bbba5e1deb968130546edf7495679ad0>访问 Clusterpedia</a></li>
<li>3.5: <a href=#pg-48ab5663f4f8c240e7bf89c5454f249f>资源检索</a></li>
<ul>
<li>3.5.1: <a href=#pg-ec8e2360424d04fb82dc27fbc4824983>多集群检索</a></li>
<li>3.5.2: <a href=#pg-d30ab8cb55be590100ae14cd7d8c1d47>指定集群检索</a></li>
<li>3.5.3: <a href=#pg-83e3a820b19f3a40c674f197775a60c8>聚合资源检索</a></li>
</ul>
</ul>
<li>4: <a href=#pg-0d0c1b75726c3db95b8a2a8ee29102a0>高级功能</a></li>
<ul>
<li>4.1: <a href=#pg-749921d4b7631dc83a7704cfc21dd956>多集群 kube-state-metrics</a></li>
<li>4.2: <a href=#pg-3f7581a2a6289f53ebfc75ee37b2d8d4>自定义存储层插件</a></li>
</ul>
<li>5: <a href=#pg-56dc2b1c45b2c6b0983526530ba75d01>特性功能</a></li>
<ul>
<li>5.1: <a href=#pg-95ce10af379e7ffb7ad12d9d7acb553b>返回剩余资源数量</a></li>
<li>5.2: <a href=#pg-e22aa1b93a45ad065cfcba03e6c25c76>原生 SQL 查询</a></li>
<li>5.3: <a href=#pg-b7b57e793e57798cc9bab1005a83932a>独立健康检查连接</a></li>
<li>5.4: <a href=#pg-13a0f1b8db8e55183af8d01c55d9e128>资源字段裁剪</a></li>
<li>5.5: <a href=#pg-3c4a7ba07443cd53a3dd0494f5a0ac77>同步所有的自定义资源</a></li>
<li>5.6: <a href=#pg-9dba7c100e86bba867d7df2e6a4ae266>同步所有的资源</a></li>
</ul>
<li>6: <a href=#pg-c9da5865a77748e4db7d4db31200b34f>版本日志</a></li>
<ul>
</ul>
</ul>
<div class=content>
</div>
</div>
<div class=td-content>
<h1 id=pg-273a1d3f87830cbffaaf95a64d1ab7e6>1 - 安装</h1>
</div>
<div class=td-content>
<h1 id=pg-9c8311e1b4822b2005012bd9c3815fa7>1.1 - 使用 kubectl apply</h1>
<h2 id=安装>安装</h2>
<p>Clusterpedia 的安装分为两个部分：</p>
<ul>
<li><a href=#%E5%AE%89%E8%A3%85%E5%AD%98%E5%82%A8%E7%BB%84%E4%BB%B6>安装存储组件</a></li>
<li><a href=#%E5%AE%89%E8%A3%85-clusterpedia>安装 Clusterpedia</a></li>
</ul>
<blockquote>
<p>用户如果使用已有的存储组件（MySQL 或者 PostgreSQL），则直接跳过安装存储组件。</p>
</blockquote>
<p>拉取项目：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git clone https://github.com/clusterpedia-io/clusterpedia.git
<span style=color:#204a87>cd</span> clusterpedia
git checkout v0.7.0
</code></pre></div><h3 id=安装存储组件>安装存储组件</h3>
<p>Clusterpedia 安装时提供了 <strong>MySQL 8.0</strong> 和 <strong>PostgreSQL 12</strong> 两种存储组件以供选择。</p>
<blockquote>
<p>用户如果使用已有的存储组件（MySQL 或者 PostgreSQL），则直接<a href=#%E5%AE%89%E8%A3%85-clusterpedia>跳过</a>存储组件安装。</p>
</blockquote>
<ul class="nav nav-tabs" id=tabset-zh-cndocsinstallationkubectl-apply-1 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tabset-zh-cndocsinstallationkubectl-apply-1-0 role=tab aria-controls=tabset-zh-cndocsinstallationkubectl-apply-1-0 aria-selected=true>PostgreSQL</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#tabset-zh-cndocsinstallationkubectl-apply-1-1 role=tab aria-controls=tabset-zh-cndocsinstallationkubectl-apply-1-1>MySQL</a></li></ul>
<div class=tab-content id=tabset-zh-cndocsinstallationkubectl-apply-1><div id=tabset-zh-cndocsinstallationkubectl-apply-1-0 class="tab-pane show active" role=tabpanel aria-labelledby=tabset-zh-cndocsinstallationkubectl-apply-1-0>
<p><p><strong>进入所选存储组件的安装目录</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>cd</span> ./deploy/internalstorage/postgres
</code></pre></div></div>
<div id=tabset-zh-cndocsinstallationkubectl-apply-1-1 class=tab-pane role=tabpanel aria-labelledby=tabset-zh-cndocsinstallationkubectl-apply-1-1>
<p><p><strong>进入所选存储组件的安装目录</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>cd</span> ./deploy/internalstorage/mysql
</code></pre></div></div></div>
<p><strong>存储组件使用 Local PV 的方式存储数据，部署时需要指定 Local PV 所在节点</strong></p>
<blockquote>
<p>用户可以选择自己提供 PV</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>STORAGE_NODE_NAME</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;节点名称&gt;
sed <span style=color:#4e9a06>&#34;s|__NODE_NAME__|</span><span style=color:#000>$STORAGE_NODE_NAME</span><span style=color:#4e9a06>|g&#34;</span> <span style=color:#4e9a06>`</span>grep __NODE_NAME__ -rl ./templates<span style=color:#4e9a06>`</span> &gt; clusterpedia_internalstorage_pv.yaml
</code></pre></div><p><strong>部署存储组件</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f .

<span style=color:#8f5902;font-style:italic># 跳回 Clusterpedia 项目根目录</span>
<span style=color:#204a87>cd</span> ../../../
</code></pre></div><h3 id=安装-clusterpedia>安装 Clusterpedia</h3>
<p>存储组件部署完成后，便可安装 Clusterpedia。</p>
<p><strong>如果选择使用已存在的存储组件，则需要参考 <a href=../configurate/configurate-internalstorage>配置存储层</a> 来将存储组件对接到<code>默认存储层</code>中。</strong></p>
<blockquote>
<p>在 clusterpedia 项目根目录下进行操作。</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 部署 Clusterpedia CRD 与组件</span>
kubectl apply -f ./deploy
</code></pre></div><h3 id=安装完成>安装完成</h3>
<p>检查组件 Pods 运行是否正常。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl -n clusterpedia-system get pods
</code></pre></div><h3 id=部署集群自动接入策略--clusterimportpolicy>部署集群自动接入策略 —— ClusterImportPolicy</h3>
<p>0.4.0 后，Clusterpedia 提供了更加友好的接入多云平台的方式。</p>
<p>用户通过创建 <code>ClusterImportPolicy</code> 来自动发现多云平台中纳管的集群，并将这些集群自动同步为 <code>PediaCluster</code>，用户不需要根据纳管的集群来手动去维护 <code>PediaCluster</code> 了。</p>
<p>我们在 <a href=https://github.com/clusterpedia-io/clusterpedia/tree/main/deploy/clusterimportpolicy>Clusterpedia 仓库</a> 中维护了各个多云平台的 <code>ClusterImportPolicy</code>。
<strong>大家也提交用于对接其他多云平台的 <code>ClusterImportPolicy</code>。</strong></p>
<p>用户在安装 Clusterpedia 后，创建合适的 <code>ClusterImportPolicy</code> 即可，用户也可以根据自己的需求来<a href=../../usage/interfacing-to-multi-cloud-platforms#%E6%96%B0%E5%BB%BA-clusterimportpolicy>创建新的 <code>ClusterImportPolicy</code></a></p>
<p>具体可以参考 <a href=../../usage/interfacing-to-multi-cloud-platforms>接入多云平台</a></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get clusterimportpolicy
</code></pre></div><h2 id=卸载>卸载</h2>
<h3 id=删除-clusterimportpolicy>删除 ClusterImportPolicy</h3>
<p>如果用户部署了 ClusterImportPolicy 那么需要先清理 ClusterImportPolicy 资源</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get clusterimportpolicy
</code></pre></div><h3 id=清理-pediacluster>清理 PediaCluster</h3>
<p>在卸载 Clusterpedia 前，需要查看环境中是否还存在 PediaCluster 资源，如果存在那么需要删除这些资源。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get pediacluster
</code></pre></div><h3 id=卸载-clusterpedia>卸载 Clusterpedia</h3>
<p>PediaCluster 资源清理完成后，卸载 Clusterpedia 相关组件。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># delete compontents</span>
kubectl delete -f ./deploy/clusterpedia_apiserver_apiservice.yaml
kubectl delete -f ./deploy/clusterpedia_apiserver_deployment.yaml
kubectl delete -f ./deploy/clusterpedia_clustersynchro_manager_deployment.yaml
kubectl delete -f ./deploy/clusterpedia_controller_manager_deployment.yaml
kubectl delete -f ./deploy/clusterpedia_apiserver_rbac.yaml

<span style=color:#8f5902;font-style:italic># delete crds</span>
kubectl delete -f ./deploy/cluster.clusterpedia.io_clustersyncresources.yaml
kubectl delete -f ./deploy/cluster.clusterpedia.io_pediaclusers.yaml
kubectl delete -f ./deploy/policy.clusterpedia.io_clusterimportpolicies.yaml
kubectl delete -f ./deploy/policy.clusterpedia.io_pediaclusterlifecycles.yaml
</code></pre></div><h3 id=卸载存储组件>卸载存储组件</h3>
<p>根据选择的存储组件类型，来移除相关的资源。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl delete -f ./deploy/internalstorage/&lt;storage type&gt;
</code></pre></div><h4 id=清理-local-pv-以及数据>清理 Local PV 以及数据</h4>
<p>存储组件卸载后，PV 和相应的数据会依然遗留在节点中，我们需要手动清理。</p>
<p>通过 Local PV 资源详情，来查看挂载的节点。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get pv clusterpedia-internalstorage-&lt;storage type&gt;
</code></pre></div><p>得知数据保存的节点后，删除 Local PV。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl delete pv clusterpedia-internalstorage-&lt;storage type&gt;
</code></pre></div><p>登录数据所在节点，清理数据。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 遗留数据所在节点</span>
rm -rf /var/local/clusterpedia/internalstorage/&lt;storage type&gt;
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-8aa1a9a3bda410f713c9c386ab4e389b>1.2 - 使用 Helm</h1>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-600ec9bf13955a06b6a5f5bdc2d718ac>1.3 - 配置</h1>
</div>
<div class=td-content>
<h1 id=pg-bc917736d18b8a8273b54276076451f5>1.3.1 - 配置存储层</h1>
<p>Clusterpedia 的<code>默认存储层</code>支持 <strong>MySQL</strong> 和 <strong>PostgreSQL</strong> 两种存储组件。</p>
<p>用户在安装 Clusterpedia 时，可以使用已存在的存储组件，
不过需要创建相应的<a href=#%E9%BB%98%E8%AE%A4%E5%AD%98%E5%82%A8%E5%B1%82%E9%85%8D%E7%BD%AE><code>默认存储层</code>配置（ConfigMap）</a>和<a href=#%E9%85%8D%E7%BD%AE%E5%AD%98%E5%82%A8%E7%BB%84%E4%BB%B6%E5%AF%86%E7%A0%81-secret>存储组件密码 Secret</a>。</p>
<h2 id=默认存储层配置>默认存储层配置</h2>
<p>用户需要在 <code>clusterpedia-system</code> 命名空间下创建 <code>clusterpedia-internalstorage</code> ConfigMap。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># internalstorage configmap example</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterpedia-internalstorage</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterpedia-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>internalstorage-config.yaml</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>    type: &#34;mysql&#34;
</span><span style=color:#8f5902;font-style:italic>    host: &#34;clusterpedia-internalstorage-mysql&#34;
</span><span style=color:#8f5902;font-style:italic>    port: 3306
</span><span style=color:#8f5902;font-style:italic>    user: root
</span><span style=color:#8f5902;font-style:italic>    database: &#34;clusterpedia&#34;
</span><span style=color:#8f5902;font-style:italic>    connPool:
</span><span style=color:#8f5902;font-style:italic>      maxIdleConns: 10
</span><span style=color:#8f5902;font-style:italic>      maxOpenConns: 100
</span><span style=color:#8f5902;font-style:italic>      connMaxLifetime: 1h
</span><span style=color:#8f5902;font-style:italic>    log:
</span><span style=color:#8f5902;font-style:italic>      slowThreshold: &#34;100ms&#34;
</span><span style=color:#8f5902;font-style:italic>      logger:
</span><span style=color:#8f5902;font-style:italic>        filename: /var/log/clusterpedia/internalstorage.log
</span><span style=color:#8f5902;font-style:italic>        maxbackups: 3</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></code></pre></div><p>internalstorage config 支持以下基本字段:</p>
<table>
<thead>
<tr>
<th>field</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>type</code></td>
<td>存储组件的类型，支持 &ldquo;postgres&rdquo; 和 &ldquo;mysql&rdquo;</td>
</tr>
<tr>
<td><code>host</code></td>
<td>存储组件地址，可以使用 IP 或者 Service Name</td>
</tr>
<tr>
<td><code>port</code></td>
<td>存储组件端口</td>
</tr>
<tr>
<td><code>user</code></td>
<td>存储组件用户</td>
</tr>
<tr>
<td><code>password</code></td>
<td>存储组件密码</td>
</tr>
<tr>
<td><code>database</code></td>
<td>Clusterpedia 所使用的 database</td>
</tr>
</tbody>
</table>
<p><strong>存储组件的访问密码，最好存放在 Secret，参考 <a href=#%E9%85%8D%E7%BD%AE%E5%AD%98%E5%82%A8%E7%BB%84%E4%BB%B6%E5%AF%86%E7%A0%81-secret>配置存储组件密码 Secret</a></strong></p>
<h3 id=数据库连接池配置>数据库连接池配置</h3>
<table>
<thead>
<tr>
<th>field</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>connPool.maxIdleConns</code></td>
<td>空闲连接池中的最大数量，默认为 10</td>
</tr>
<tr>
<td><code>connPool.maxOpenConns</code></td>
<td>打开的数据库连接的最大数量，默认为 100</td>
</tr>
<tr>
<td><code>connPool.connMaxLifetime</code></td>
<td>连接可以复用的最大时间，默认为 1h</td>
</tr>
</tbody>
</table>
<p>根据用户的当前环境，合理设置数据库连接池</p>
<h3 id=日志配置>日志配置</h3>
<p>支持配置存储层日志，通过 <code>log</code> 字段来开启日志打印慢 SQL 和错误</p>
<table>
<thead>
<tr>
<th>field</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>log.stdout</code></td>
<td>打印日志到标准输出</td>
</tr>
<tr>
<td><code>log.colorful</code></td>
<td>是否开启彩色打印</td>
</tr>
<tr>
<td><code>log.slowThreshold</code></td>
<td>设置慢 SQL 阀值，例如 &ldquo;100ms&rdquo;</td>
</tr>
<tr>
<td><code>log.level</code></td>
<td>设置日志级别，支持 Slient, Error, Warn, Info</td>
</tr>
<tr>
<td><code>log.logger</code></td>
<td>日志轮滚配置</td>
</tr>
</tbody>
</table>
<p>开启日志打印后，如果 <code>log.stdout</code> 不为 true，则将日志输出到 <em>/var/log/clusterpedia/internalstorage.log</em> 文件中</p>
<h4 id=日志轮滚配置>日志轮滚配置</h4>
<p>将存储层的日志保存到文件中，并且可以配置日志文件的轮滚</p>
<table>
<thead>
<tr>
<th>field</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>log.logger.filename</code></td>
<td>日志文件路径, 默认为 <em>/var/log/clusterpedia/internalstorage.log</em></td>
</tr>
<tr>
<td><code>log.logger.maxsize</code></td>
<td>触发日志轮滚的最大文件大小，单位为 MB</td>
</tr>
<tr>
<td><code>log.logger.maxage</code></td>
<td>轮滚的旧日志的最大存活时间</td>
</tr>
<tr>
<td><code>log.logger.maxbackups</code></td>
<td>轮滚的旧日志的最大数量</td>
</tr>
<tr>
<td><code>log.logger.localtime</code></td>
<td>是否为本地时间，默认为 UTC</td>
</tr>
<tr>
<td><code>log.logger.compress</code></td>
<td>是否将轮滚的日志文件进行压缩，默认不进行压缩</td>
</tr>
</tbody>
</table>
<h4 id=关闭日志打印>关闭日志打印</h4>
<p>在 internalstorage config 不填写 <code>log</code> 字段，便会忽略日志打印，例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;mysql&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;clusterpedia-internalstorage-mysql&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3306</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>root</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;clusterpedia&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=更多配置>更多配置</h3>
<p>默认存储层还提供了有关 MySQL 和 PostgreSQL 的更多配置，可以参考 <a href=https://github.com/clusterpedia-io/clusterpedia/blob/main/pkg/storage/internalstorage/config.go>internalstorage/config.go</a></p>
<h2 id=配置存储组件密码-secret>配置存储组件密码 Secret</h2>
<p>Clusterpedia 的安装 yaml 会从 <code>internalstorage-password</code> 的 Secret 中获取密码。</p>
<p>将存储组件的密码配置到 Secret 中</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl -n clusterpedia-system create secret generic <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    internalstorage-password --from-literal<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;存储组件访问密码&gt;
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-dd948255948d6b59b32c471abcb62997>2 - 概念</h1>
</div>
<div class=td-content>
<h1 id=pg-911128911953cea7ceaaad409a1badf1>2.1 - PediaCluster</h1>
<p>Clusterpedia 中使用 <code>PediaCluster</code> 资源来代表一个需要同步资源的集群。</p>
<blockquote>
<p>Clusterpedia 需要非常友好的对接到其他多云平台中，而多云平台可能会使用 <code>Cluster</code> 资源来代表纳管的集群，为了避免冲突 Clusterpedia 使用 PediaCluster。</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get pediacluster
NAME        APISERVER                        VERSION            STATUS
demo1       https://10.6.101.100:6443        v1.22.3-aliyun.1   Healthy
demo2       https://10.6.101.100:6443        v1.21.0            Healthy
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster.clusterpedia.io/v1alpha2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PediaCluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>demo1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>apiserver</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://10.6.101.100:6443</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kubeconfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>caData</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>tokenData</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>certData</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>keyData</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncAllCustomResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncResourcesRefName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>PediaCluster 有两个作用</p>
<ul>
<li>配置集群的认证信息</li>
<li>配置同步的资源</li>
</ul>
<p>配置集群认证信息可以参考 <a href=../../usage/import-clusters>集群接入</a></p>
<p>有三个字段可以配置同步的资源：</p>
<ul>
<li><code>spec.syncResources</code> 配置该集群需要同步的资源</li>
<li><code>spec.syncAllCustomResources</code> 同步所有的自定义资源</li>
<li><code>spec.syncResourcesRefName</code> 引用 <a href=../cluster-sync-resources>公共的集群资源同步配置</a></li>
</ul>
<p>具体配置同步资源，可以参考 <a href=../../usage/sync-resources>同步集群资源</a></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-90ee9ed4f8367758c09e96dc82d2a800>2.2 - 公共的集群资源同步配置(ClusterSyncResources)</h1>
<p>Clusterpedia 提供了公共的集群资源同步配置 ——  <strong>ClusterSyncResources</strong>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get clustersyncresources
</code></pre></div><p>ClusterSyncResources 的 <code>spec.syncResources</code> 字段和 PediaCluster 的 <code>spec.syncResources</code> 配置方式相同，可以参考 <a href=../../usage/sync-resources>同步集群资源</a></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster.clusterpedia.io/v1alpha2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClusterSyncResources</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>global-base</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>pods</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;apps&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>未来会支持 <code>spec.syncAllCustomResources</code> 字段来支持设置同步所有的自定义资源</p>
<p>任何 <strong>PediaCluster</strong> 都可以通过 <code>spec.syncResourcesRefName</code> 引用相同的 <code>ClusterSyncResources</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster.clusterpedia.io/v1alpha2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PediaCluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>demo1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncResourcesRefName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;global-base&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><strong>当我们修改 ClusterSyncResources 时，所有引用它的 PediaCluster 内同步的资源都会发生相应的修改。</strong></p>
<p>如果 <strong>PediaCluster</strong> 同时设置了 <code>spec.syncResourcesRefName</code> 和 <code>spec.syncResources</code>，那么会取两者的并集</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster.clusterpedia.io/v1alpha2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PediaCluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>demo1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncResourcesRefName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;global-base&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>pods</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>configmaps</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>上例中，clusterpedia 会同步 demo1 集群中 pods 和 configmaps，以及 apps group 下的所有资源。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-40243a331b263af5e1b61fd771638878>2.3 - 聚合资源(Collection Resource)</h1>
<p>Clusterpedia 为了能够一次性获取多个类型的资源，在单个资源类型的基础上提供了一种新的资源 —— <code>聚合资源（Collection Resource）</code>。</p>
<p><code>聚合资源</code>是由不同的资源类型组合而成，可以对这些资源类型进行统一的检索和分页。</p>
<p><strong>具体支持哪些聚合资源是由<code>存储层</code>来决定的</strong>，例如 <code>默认存储层</code> 支持 <code>any</code>，<code>workloads</code> 和 <code>kuberesources</code> 两种聚合资源。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get collectionresources
</code></pre></div><pre tabindex=0><code># 输出:
NAME            RESOURCES
any             * 
workloads       deployments.apps,daemonsets.apps,statefulsets.apps
kuberesources   .*,*.admission.k8s.io,*.admissionregistration.k8s.io,*.apiextensions.k8s.io,*.apps,*.authentication.k8s.io,*.authorization.k8s.io,*.autoscaling,*.batch,*.certificates.k8s.io,*.coordination.k8s.io,*.discovery.k8s.io,*.events.k8s.io,*.extensions,*.flowcontrol.apiserver.k8s.io,*.imagepolicy.k8s.io,*.internal.apiserver.k8s.io,*.networking.k8s.io,*.node.k8s.io,*.policy,*.rbac.authorization.k8s.io,*.scheduling.k8s.io,*.storage.k8s.io
</code></pre><p><code>any</code> 表示任意的资源，用户在使用时需要传递想要组合的 groups 或者 resources，具体使用可以参考 <a href=../../usage/search/collection-resource#any-collectionresource>使用 Any CollectionResource</a></p>
<p><code>kuberesources</code> 包含了所有 kube 的内置资源，我们可以通过 <code>kuberesources</code> 来对所有的内置资源进行统一的过滤和检索。</p>
<p><strong>以 yaml 形式查看支持的<code>聚合资源</code></strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get collectionresources -o yaml
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># 输出：</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>items</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterpedia.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CollectionResource</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>any</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resourceTypes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterpedia.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CollectionResource</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>workloads</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resourceTypes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>deployments</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>daemonsets</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>statefulsets</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterpedia.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CollectionResource</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kuberesources</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resourceTypes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>admission.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>admissionregistration.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apiextensions.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authentication.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authorization.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>autoscaling</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>batch</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>certificates.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>coordination.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>discovery.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>events.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>extensions</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>flowcontrol.apiserver.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>imagepolicy.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>internal.apiserver.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>node.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rbac.authorization.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>scheduling.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>List</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resourceVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selfLink</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>可以看到 <code>workloads</code> 包含了 <code>deployments</code>，<code>daemonsets</code>， <code>statefulsets</code> 三种资源。</p>
<p>而 <code>kuberesources</code> 则包含了 kube 内置的所有资源。</p>
<p>更多关于<code>聚合资源</code>的操作可以查看 <a href=../../usage/search/collection-resource>聚合资源检索</a></p>
<h2 id=自定义聚合资源>自定义聚合资源</h2>
<p>Clusterpedia 计划提供两种方式来让用户随意组合想要查询的资源类型</p>
<ul>
<li><strong><code>Any CollectionResource</code></strong> —— 使用聚合资源 <code>any</code></li>
<li><strong><code>CustomCollectionResource</code></strong> —— 自定义聚合资源</li>
</ul>
<p>0.4 中，Clusterpedia 提供了 any collectionresource 来让用户通过传递 <code>groups</code> 和 <code>resources</code> 参数来组合不同类型的资源。</p>
<p>不过需要注意 any collectionresource 不能使用 kubectl 来获取，具体使用可以参考 <a href=../../usage/search/collection-resource/use-any-collection-resource>使用 Any CollectionResource</a></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get collectionresources any
Error from server <span style=color:#ce5c00;font-weight:700>(</span>BadRequest<span style=color:#ce5c00;font-weight:700>)</span>: url query - <span style=color:#4e9a06>`</span>groups<span style=color:#4e9a06>`</span> or <span style=color:#4e9a06>`</span>resources<span style=color:#4e9a06>`</span> is required
</code></pre></div><p><strong>自定义聚合资源</strong>允许用户通过 <code>kubectl apply collectionresource &lt;collectionresource name></code> 来创建或者更新一个 Collection Resource，用户随意的配置 Collection Resource 的资源类型</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterpedia.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CollectionResource</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>workloads</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>resourceTypes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>deployments</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>daemonsets</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>statefulsets</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>batch</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cronjobs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><strong>当前还未支持自定义聚合资源</strong></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d8808d404dd9644ce0c0ae679468c3a2>2.4 - 集群自动接入策略(ClusterImportPolicy)</h1>
<p>自定义资源 <code>ClusterImportPolicy</code> 定义了某种类型的资源应该如何转换成 <code>PediaCluster</code>，这样 clusterpedia 便可以根据某种资源来自动的创建、更新和删除 <a href=../pediacluster>PediaCluster</a></p>
<p>首先需要在 <code>ClusterImportPolicy</code> 资源中定义监听（想要转换的）的资源类型，我们将被监听的资源称为 <strong>Source</strong> 资源。</p>
<p>当一个 <strong>Source</strong> 资源被创建或者删除时，<em>ClusterImportPolicy Controller</em> 会创建相应 <code>PediaClusterLifecycle</code> 资源。
而 <code>PediaClusterLifecycle</code> 会根据具体的 <strong>Source</strong> 资源来创建，更新以及删除 <code>PediaCluster</code>。</p>
<p>在创建和更新 <code>PediaCluster</code> 时，<strong>Source</strong> 资源可能会将集群的认证信息（例如 CA，Token 等）保存在其他资源中，我们将这些涉及到的其他资源统称为 <strong>References</strong> 资源。</p>
<blockquote>
<p>对于 <code>ClusterImportPolicy</code> 和 <code>PediaClusterLifecycle</code> 的调协由 <strong>Clusterpedia Controller Manager</strong> 内的 <em>ClusterImportPolicy Controller</em> 和 <em>PediaClusterLifecycle Controller</em> 负责</p>
<p><code>ClusterImportPolicy</code> 和 <code>PediaCusterLifecycle</code> 资源结构的更新可能会比较频繁，为了避免对 <em>cluster.clusterpedia.io</em> group 带来不必要的影响，所以放在 <em>policy.clusterpedia.io</em> group 中,
未来 1.0 发布时，可能会迁移到 <em>cluster.clusterpedia.io</em> 中。</p>
</blockquote>
<h2 id=clusterimportpolicy>ClusterImportPolicy</h2>
<p>一个完整 <code>ClusterImportPolicy</code> 示例如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy.clusterpedia.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClusterImportPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mcp</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>source</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cluster.example.io&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusters</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>selectorTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>references</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>namespaceTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;{{ .source.spec.authSecretRef.namespace }}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>nameTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;{{ .source.spec.authSecretRef.name }}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authSecret</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>nameTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;mcp-{{ .source.metadata.name }}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>    spec:
</span><span style=color:#8f5902;font-style:italic>      apiserver: &#34;{{ .source.spec.apiEndpoint }}&#34;
</span><span style=color:#8f5902;font-style:italic>      caData: &#34;{{ .references.authSecret.data.ca }}&#34;
</span><span style=color:#8f5902;font-style:italic>      tokenData: &#34;{{ .references.authSecret.data.token }}&#34;
</span><span style=color:#8f5902;font-style:italic>      syncResources:
</span><span style=color:#8f5902;font-style:italic>        - group: &#34;&#34;
</span><span style=color:#8f5902;font-style:italic>          resources:
</span><span style=color:#8f5902;font-style:italic>          - &#34;pods&#34;
</span><span style=color:#8f5902;font-style:italic>        - group: &#34;apps&#34;
</span><span style=color:#8f5902;font-style:italic>          resources:
</span><span style=color:#8f5902;font-style:italic>          - &#34;*&#34;</span><span style=color:#f8f8f8;text-decoration:underline>    
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>creationCondition</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>    {{ if ne .source.spec.apiEndpoint &#34;&#34; }}
</span><span style=color:#8f5902;font-style:italic>      {{ range .source.status.conditions }}
</span><span style=color:#8f5902;font-style:italic>        {{ if eq .type &#34;Ready&#34; }}
</span><span style=color:#8f5902;font-style:italic>          {{ if eq .status &#34;True&#34; }} true {{ end }}
</span><span style=color:#8f5902;font-style:italic>        {{ end }}
</span><span style=color:#8f5902;font-style:italic>      {{ end }}
</span><span style=color:#8f5902;font-style:italic>    {{ end }}</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></code></pre></div><p>主要分为三部分</p>
<ul>
<li><code>spec.source</code> 和 <code>spec.references</code> 分别定义 <strong>Source</strong> 资源和 <strong>References</strong> 资源</li>
<li><code>spec.nameTemplate</code> 定义生成的 <code>PediaClusterLifecycle</code> 和 <code>PediaCluster</code> 的名称，可以根据 <strong>Source</strong> 资源进行渲染</li>
<li><code>spec.template</code> 和 <code>spec.creationCondition</code> 定义资源转换策略。</li>
</ul>
<p><strong>references，template，creationCondition 内的模板均支持由 <a href=https://github.com/Masterminds/sprig>sprig</a> 提供的 70 多种模版函数</strong>，<a href=http://masterminds.github.io/sprig/>Sprig Function Documentation</a></p>
<h2 id=source-和-references-资源>Source 和 References 资源</h2>
<p>在 <code>ClusterImportPolicy</code> 资源中我们首先需要定义的就是 <strong>Source</strong> 资源类型以及 <strong>References</strong> 资源</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy.clusterpedia.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClusterImportPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>multi-cluster-polatform</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>source</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;example.io&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusters</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>versions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>selectorTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>      </span><span style=color:#f8f8f8;text-decoration:underline>      </span>{{<span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>if eq .source.metadata.namespace &#34;default&#34; }} true {{ end }}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>references</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>versions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>namespaceTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;{{ .source.spec.secretRef.namespace }}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>nameTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;{{ .source.spec.secretRef.name }}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secret</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><strong>Source</strong> 资源通过 <code>spec.source.group</code> 和 <code>spec.source.resource</code> 指定了资源组和资源名称。我们也可以使用 <code>spec.source.versions</code> 来限制 <strong>Source</strong> 的资源版本，默认是不会对 <strong>Source</strong> 资源版本进行限制</p>
<blockquote>
<p><strong>一种 Source 资源只能有一个负责转换该资源的 <code>ClusterImportPolicy</code> 资源</strong></p>
</blockquote>
<p>用户也可以通过 <code>spec.source.selectorTemplate</code> 字段来过滤 <strong>Source</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy.clusterpedia.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClusterImportPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubevela</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>source</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>selectorTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>      {{ if eq .source.metadata.namespace &#34;vela-system&#34; }}
</span><span style=color:#8f5902;font-style:italic>        {{ if .source.metadata.labels }}
</span><span style=color:#8f5902;font-style:italic>          {{ eq (index .source.metadata.labels &#34;cluster.core.oam.dev/cluster-credential-type&#34;) &#34;X509Certificate&#34; }}
</span><span style=color:#8f5902;font-style:italic>        {{ end }}
</span><span style=color:#8f5902;font-style:italic>      {{ end }}</span><span style=color:#f8f8f8;text-decoration:underline>      
</span></code></pre></div><p><strong>source</strong> 资源可以通过 <code>{{ .source.&lt;field> }}</code> 来用于其他的模版字段</p>
<p><code>spec.references</code> 中定义了在转换过程中涉及到的资源，我们需要指定资源的类型，以及通过 namespace 和 name 模版来获取具体的 <strong>reference</strong> 资源。我们也可以和 <strong>Source</strong> 资源一样对 Reference 资源的版本进行限制。</p>
<p>除此之外还要为 <strong>reference</strong> 资源设置一个 key，这个 key 会以 <code>{{ .references.&lt;key> }}</code> 的方式来让后续模版字段使用</p>
<p><em><code>spec.references</code> 中后面的项也可以通过 <code>.references.&lt;key></code> 来引用前面的项</em></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>references</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>a.example.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>aresource</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespaceTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;{{ .source.spec.aNamespace }}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>nameTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;{{ .source.spec.aName }}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>refA</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>b.example.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bresource</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespaceTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;{{ .references.refA.spec.bNamespace }}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>nameTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;{{ .references.refA.spec.bName }}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>refB</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=pediaclusterlifecycle>PediaClusterLifecycle</h2>
<p>当一个 <strong>Source</strong> 被创建后，<em>ClusterImportPolicy Controller</em> 会根据 <code>ClusterImportPolicy</code> 创建相应的 <code>PediaClusterLifecycle</code> 资源。</p>
<p><code>PediaClusterLifecycle</code> 资源的名字是通过 <code>ClusterImportPolicy</code> 的 <code>spec.nameTemplate</code> 字段来设置的。</p>
<pre tabindex=0><code>apiVersion: policy.clusterpedia.io/v1alpha1
kind: ClusterImportPolicy
metadata:
  name: multi-cluster-platform
spec:
  nameTemplate: &quot;mcp-{{ .source.metadata.namespace }}-{{ .source.metadata.name }}&quot;
</code></pre><p>nameTemplate 只能根据 <strong>Source</strong> 资源来渲染模版，通常根据是否为 Cluster Scoped 资源来设置该字段：</p>
<ul>
<li><code>nameTemplate: "&lt;prefix>-{{ .source.metadata.namespace}}-{{ .source.metadata.name }}"</code></li>
<li><code>nameTemplate: "&lt;prefix>-{{ .source.metadata.name }}"</code></li>
</ul>
<p><strong>nameTemplate 前缀通常是多云平台或者其他有意义的名字，当然也可以没有前缀。</strong></p>
<p><code>PediaClusterLifecycle</code> 中会设置具体的 <strong>source</strong> 资源和 <strong>references</strong> 资源以及转换策略</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy.clusterpedia.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PediaClusterLifecycle</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;prefix&gt;-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>source</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusters</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>references</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>namespaceTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;{{ .source.spec.secretRef.namespace }}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>nameTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;{{ .source.spec.secretRef.name }}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secret</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><code>PediaClusterLifecycle</code> 的 <code>spec.source</code> 设置了一个具体的 <strong>Source</strong> 资源，包括了资源的具体版本，命名空间和名称。</p>
<p><code>spec.references</code> 相比 <code>ClusterImportPolicy</code> 包含了具体的资源版本，其他字段和 <code>ClusterImportPolicy</code> 内的 References 定义相同。
references 资源的命名空间和名字会在转换资源时进行解析。</p>
<h3 id=pediaclusterlifecycle-和-pediacluster>PediaClusterLifecycle 和 PediaCluster</h3>
<p><code>PediaClusterLifecycle</code> 的名字会和 <code>PediaCluster</code> 进行一一对应，<code>PediaClusterLifecycle</code> 根据转换策略创建和更新同名的 <code>PediaCluster</code>。</p>
<h2 id=pediacluster-转换策略>PediaCluster 转换策略</h2>
<p>我们在定义转换策略时，主要关注以下方面:</p>
<ul>
<li>用于创建或者更新 <code>PediaCluster</code> 的模版</li>
<li>什么时候触发 <code>PediaCluster</code> 的创建</li>
</ul>
<p>在 <code>ClusterImportPolicy</code> 中，我们使用 <code>spec.template</code> 和 <code>spec.creationCondition</code> 来定义他们</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy.clusterpedia.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClusterImportPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mcp</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>other fields</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>    spec:
</span><span style=color:#8f5902;font-style:italic>      apiserver: &#34;{{ .source.spec.apiEndpoint }}&#34;
</span><span style=color:#8f5902;font-style:italic>      caData: &#34;{{ .references.authSecret.data.ca }}&#34;
</span><span style=color:#8f5902;font-style:italic>      tokenData: &#34;{{ .references.tokenData.data.token }}&#34;
</span><span style=color:#8f5902;font-style:italic>      syncResources:
</span><span style=color:#8f5902;font-style:italic>        - group: &#34;&#34;
</span><span style=color:#8f5902;font-style:italic>          resources:
</span><span style=color:#8f5902;font-style:italic>          - &#34;pods&#34;
</span><span style=color:#8f5902;font-style:italic>        - group: &#34;apps&#34;
</span><span style=color:#8f5902;font-style:italic>          resources:
</span><span style=color:#8f5902;font-style:italic>          - &#34;*&#34;</span><span style=color:#f8f8f8;text-decoration:underline>    
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>creationCondition</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>    {{ if ne .source.spec.apiEndpoint &#34;&#34; }}
</span><span style=color:#8f5902;font-style:italic>      {{ range .source.status.conditions }}
</span><span style=color:#8f5902;font-style:italic>        {{ if eq .type &#34;Ready&#34; }}
</span><span style=color:#8f5902;font-style:italic>          {{ if eq .status &#34;True&#34; }} true {{ end }}
</span><span style=color:#8f5902;font-style:italic>        {{ end }}
</span><span style=color:#8f5902;font-style:italic>      {{ end }}
</span><span style=color:#8f5902;font-style:italic>    {{ end }}</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></code></pre></div><p>这两个字段都是模版字段，需要根据 <strong>Source</strong> 资源和 <strong>References</strong> 资源来渲染。</p>
<p>当 <strong>Source</strong> 资源被创建后，<strong>ClusterImportPolicy Controller</strong> 会根据 <code>ClusterImportPolicy</code> 创建对应的 <code>PediaClusterLifecycle</code>，并且 <code>PediaClusterLifecycle</code> 中也会包含转换策略。</p>
<blockquote>
<p>当然如果 <code>ClusterImportPolicy</code> 内的策略发生修改，也会同步给所属的所有 <code>PediaClusterLifecycle</code> 资源。</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy.clusterpedia.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClusterImportPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mcp-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>other fields</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>    spec:
</span><span style=color:#8f5902;font-style:italic>      apiserver: &#34;{{ .source.spec.apiEndpoint }}&#34;
</span><span style=color:#8f5902;font-style:italic>      caData: &#34;{{ .references.authSecret.data.ca }}&#34;
</span><span style=color:#8f5902;font-style:italic>      tokenData: &#34;{{ .references.tokenData.data.token }}&#34;
</span><span style=color:#8f5902;font-style:italic>      syncResources:
</span><span style=color:#8f5902;font-style:italic>        - group: &#34;&#34;
</span><span style=color:#8f5902;font-style:italic>          resources:
</span><span style=color:#8f5902;font-style:italic>          - &#34;pods&#34;
</span><span style=color:#8f5902;font-style:italic>        - group: &#34;apps&#34;
</span><span style=color:#8f5902;font-style:italic>          resources:
</span><span style=color:#8f5902;font-style:italic>          - &#34;*&#34;</span><span style=color:#f8f8f8;text-decoration:underline>    
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>creationCondition</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>    {{ if ne .source.spec.apiEndpoint &#34;&#34; }}
</span><span style=color:#8f5902;font-style:italic>      {{ range .source.status.conditions }}
</span><span style=color:#8f5902;font-style:italic>        {{ if eq .type &#34;Ready&#34; }}
</span><span style=color:#8f5902;font-style:italic>          {{ if eq .status &#34;True&#34; }} true {{ end }}
</span><span style=color:#8f5902;font-style:italic>        {{ end }}
</span><span style=color:#8f5902;font-style:italic>      {{ end }}
</span><span style=color:#8f5902;font-style:italic>    {{ end }}</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></code></pre></div><p><code>PediaClusterLifecycle</code> 会负责根据 <code>spec.creationCondition</code> 和 <code>spec.template</code> 来创建更新具体的 <code>PediaCluster</code>。</p>
<h3 id=creation-condition>Creation Condition</h3>
<p>我们有时在 <strong>Source</strong> 资源创建后并不会立刻创建 <code>PediaCluster</code>, 而是需要等到 <strong>Source</strong> 资源某些字段或者某些状态就绪后再创建 <code>PediaCluster</code>。</p>
<p><code>spec.creationCondition</code> 使用模版语法来判断是否满足创建条件，当模版渲染后的值为 <code>True</code>（大小写模糊）后则会根据 <code>spec.Template</code> 创建 <code>PediaCluster</code>。</p>
<p>如果 <code>PediaCluster</code> 已经存在，<code>spec.creationCondition</code> 不会影响后续对 <code>PediaCluster</code> 的更新。</p>
<h3 id=pediacluster-template>PediaCluster Template</h3>
<p><code>spec.template</code> 定义了 <code>PediaCluster</code> 资源模版，在创建或者更新 <code>PediaCluster</code> 时，会根据 <strong>Source</strong> 资源和 <strong>References</strong> 资源来渲染出具体的资源。</p>
<p><code>PediaCluster</code> 模版可以分成三部分：</p>
<ul>
<li>元信息：labels 和 annotations</li>
<li>集群访问与认证字段：<code>spec.apiserver</code>，<code>spec.caData</code>，<code>spec.tokenData</code>，<code>spec.certData</code>，<code>spec.keyData</code> 还有 <code>spec.kubeconfig</code></li>
<li>资源同步字段：<code>spec.syncResources</code>，<code>spec.syncAllCustomResources</code>，<code>spec.syncResourcesRefName</code></li>
</ul>
<p><code>PediaCluster</code> 资源的<strong>元信息</strong>和<strong>资源同步字段</strong>只有在创建 PediaCluser 时才会有效，在更新 <code>PediaCluster</code> 资源时，只会更新<strong>集群访问与认证字段</strong></p>
<h3 id=pediacluster-的删除>PediaCluster 的删除</h3>
<p>如果一个 <code>PediaCluster</code> 是由 <code>PediaClusterLifecycle</code> 创建，那么会将 <code>PediaClusterLifecycle</code> 设置为该 <code>PediaCluster</code> 资源的 owner</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster.clusterpedia.io/v1alpha2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PediaCluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mcp-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ownerReferences</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy.clusterpedia.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PediaClusterLifecycle</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mcp-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>uid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>f932483a-b1c5-4894-a524-00f78ea34a9f</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>当一个 <strong>Source</strong> 资源被删除时，会同步删除 <code>PediaClusterLifecycle</code>，<code>PediaCluster</code> 会自动删除。</p>
<p>如果 <code>PediaCluster</code> 在 <code>PediaClusterLifecycle</code> 前已经出现了，那么 <strong>Source</strong> 删除时不会自动的删除 <code>PediaCluster</code>。</p>
<p>未来会增加 DeletionCondition 来允许用户强制或者提前删除 <code>PediaCluster</code>。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-ec5a5e9379174e59d723f74f5206953c>3 - 使用</h1>
</div>
<div class=td-content>
<h1 id=pg-926b93f86224309ec4277c2c1b97fe8c>3.1 - 集群接入</h1>
<p>Clusterpedia 使用自定义资源 <code>PediaCluster</code> 资源来代表接入的集群</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster.clusterpedia.io/v1alpha2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PediaCluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>apiserver</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;https://10.30.43.43:6443&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kubeconfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>caData</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>tokenData</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>certData</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>keyData</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>用户有两种方式来配置接入的集群:</p>
<ol>
<li>直接配置 base64 编码的 kube config 到 <code>kubeconfig</code> 字段用于集群连接和验证</li>
<li>分别配置接入集群的地址，以及验证信息</li>
</ol>
<p>在使用 <code>apiserver</code> 字段来设置接入集群的地址时，验证字段的配置有多种选择：</p>
<ul>
<li><code>caData</code> + <code>tokenData</code></li>
<li><code>caData</code> + <code>certData</code> + <code>keyData</code></li>
</ul>
<blockquote>
<p><code>caData</code> 在集群 APIServer 允许 Insecure 连接的情况下，也可以不填</p>
</blockquote>
<p>这些验证字段都需要 base64 编码，如果这些字段的值是直接从 ConfigMap 或者 Secret 中获取的话，那么就已经 base64 过。</p>
<h2 id=使用-kube-config-来接入集群>使用 kube config 来接入集群</h2>
<p>使用 kube config 来连接和验证集群是最简单的一种方式。</p>
<p>首先需要将接入集群的 kube config base64 编码。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># mac</span>
cat ./kubeconfig <span style=color:#000;font-weight:700>|</span> base64

<span style=color:#8f5902;font-style:italic># linux</span>
cat ./kubeconfig <span style=color:#000;font-weight:700>|</span> base64 -w <span style=color:#0000cf;font-weight:700>0</span>
</code></pre></div><pre tabindex=0><code># 输出 base64 编码后的配置
YXBpVmVyc2lvbjogdjEKY2x1c3RlcnM6Ci0gY2x1c3RlcjoKICAgIGNlcnRpZmljYXRlLWF1dGhvcml0eS1kYXRhOiBMUzB0TFMxQ1JVZEpUaUJEUlZKVVNVWkpRMEZVUlMwdExTMHRDazFKU1VNdmFrTkRRV1ZoWjBGM1NVSkJaMGxDUVVSQlRrSm5hM0ZvYTJsSE9YY3dRa0ZSYzBaQlJFRldUVkpOZDBWUldVUldVVkZFUlhkd2NtUlhTbXdLWTIwMWJHUkhWbnBOUWpSWVJGUkplRTFFYTNsT1JFVjNUVlJOZVU1R2IxaEVWRTE0VFVScmVVMXFSWGROVkUxNVRrWnZkMFpVUlZSTlFrVkhRVEZWUlFwQmVFMUxZVE5XYVZwWVNuVmFXRkpzWTNwRFEwRlRTWGRFVVZsS1MyOWFTV2gyWTA1QlVVVkNRbEZCUkdkblJWQkJSRU5EUVZGdlEyZG5SVUpCVHk5VENuWnRhMVU1YmsxdVVsUklUM2x2SzNoamRGUkpZMGxQWW5NemMwRjVjVEkyZGpSUVlrVnRiM1pXTTJ4UE9WUXdNVEYyY0U5NlMwcHlPVUZ4ZVZaTVJuWUtWWEZCUkhCVGFrTTNXWGQzTW5ad1NsZDNiREV5U2xCdlVtMXhaMUZCU0ZOa1lsSnBVM0JEVERSdWRqbHZSMjVWT1dJMmRsbFdTeTlpUml0a1VWRkNTQXBuUTFoNk5uWm9UR1k0V21kMk4ydFVRMkpCZGtGUGFFOU9TbFUzTWxsWVRFOHpUMGxaUWpKdmExTkNSR0ZWVWpOdk5ucHdaR1ZXVGt0NVYwRXlOVkEzQ2tSb2JrOHlUazAxUXpscFJFUnFUVFJMWTJGVGEzSlBTa0p2YlVsc1NIRlpSalJ3VlhkVFRsRnZjR1ZHUlZSeVozWnpjVGt3U2tzMllVSlZTMHQ1YWpZS0syTkdkakkzUzBrNEsxWk1VRXRhU1RFMmMyNU1ibmcyUlhSVGF6WnRaakpYVEhkSlpsaHlRbGd3UkVzdllYQkVRMDE1UjJwRWIyZENhR3BKU1Zob1ZBcDJialZRWm5kRldVTnNkR1pGVEVoS1NrZFZRMEYzUlVGQllVNWFUVVpqZDBSbldVUldVakJRUVZGSUwwSkJVVVJCWjB0clRVRTRSMEV4VldSRmQwVkNDaTkzVVVaTlFVMUNRV1k0ZDBoUldVUldVakJQUWtKWlJVWkpWRGhMUkhkQ2JVVnZNSGxhZFVGRVpraGtLelExTDNaRll6ZE5RbFZIUVRGVlpFVlJVVThLVFVGNVEwTnRkREZaYlZaNVltMVdNRnBZVFhkRVVWbEtTMjlhU1doMlkwNUJVVVZNUWxGQlJHZG5SVUpCVDBGNVZIUTRTM1pGTjBkdlJFaFFUMDlwZGdveVIySTJXV1ZzVVU1S2NVTXphMWRJT1hjMU5URk5hR1p2UzNaaU0yMVZhVVY2WlZNd09VTndaVVFyVEZoNVpubHFRemhaWWtKeFFqWlhTRmhOWldNckNucFBkRE5QYXpSWVYwRm1aVlZaVFhoT1ExRkpibGM0Y2pJNGNtWm5ibEVyYzFOQ2RIUXllRVJRTjFSWlkwOW9OVlpHWmtJMkszSnRUbUZUYmxaMU5qZ0tTRkZ4ZGxGTU5FRlhiVmhrUjA5alJXTkJSVGhZZGtkaU9XaHdTalZOY2tSSGR6UTBVVFl5T0c5WWF6WjBOMDFhV1RGT01VTlFkVzlIWjFWbVMxTjNiZ28xTVVGV1JURk9WVmROVjB0RVFYaGFhMkk0YkVodlIzVldhREZ6V21kM1NuSlJRalI1Y2xoMWNteEdOMFkyYlZSbFltNHJjRFZLTTB0b1QwVjRLemxzQ2pGWGRrd3diV2t4TDFKMmJWSktObTExWW10aldVd3pOMUZKV2pJMVlYZHlhRVpNTjBaMWVqTlJTVEZxVFRkWU1IWkVUMlZVTTJWdVZVRkNaVzVTTVM4S1VubG5QUW90TFMwdExVVk9SQ0JEUlZKVVNVWkpRMEZVUlMwdExTMHRDZz09CiAgICBzZXJ2ZXI6IGh0dHBzOi8vMTAuNi4xMDAuMTA6NjQ0MwogIG5hbWU6IGt1YmVybmV0ZXMKY29udGV4dHM6Ci0gY29udGV4dDoKICAgIGNsdXN0ZXI6IGt1YmVybmV0ZXMKICAgIHVzZXI6IGt1YmVybmV0ZXMtYWRtaW4KICBuYW1lOiBrdWJlcm5ldGVzLWFkbWluQGt1YmVybmV0ZXMKY3VycmVudC1jb250ZXh0OiBrdWJlcm5ldGVzLWFkbWluQGt1YmVybmV0ZXMKa2luZDogQ29uZmlnCnByZWZlcmVuY2VzOiB7fQp1c2VyczoKLSBuYW1lOiBrdWJlcm5ldGVzLWFkbWluCiAgdXNlcjoKICAgIGNsaWVudC1jZXJ0aWZpY2F0ZS1kYXRhOiBMUzB0TFMxQ1JVZEpUaUJEUlZKVVNVWkpRMEZVUlMwdExTMHRDazFKU1VSSlZFTkRRV2R0WjBGM1NVSkJaMGxKV2s0eVNscE5TbnAwU21kM1JGRlpTa3R2V2tsb2RtTk9RVkZGVEVKUlFYZEdWRVZVVFVKRlIwRXhWVVVLUVhoTlMyRXpWbWxhV0VwMVdsaFNiR042UVdWR2R6QjVUVlJCTlUxcVVYaE5SRVY2VFdwU1lVWjNNSGxOYWtFMVRXcFJlRTFFUlhwTmFtaGhUVVJSZUFwR2VrRldRbWRPVmtKQmIxUkViazQxWXpOU2JHSlVjSFJaV0U0d1dsaEtlazFTYTNkR2QxbEVWbEZSUkVWNFFuSmtWMHBzWTIwMWJHUkhWbnBNVjBackNtSlhiSFZOU1VsQ1NXcEJUa0puYTNGb2EybEhPWGN3UWtGUlJVWkJRVTlEUVZFNFFVMUpTVUpEWjB0RFFWRkZRVFZEUkdSYVdIcEliMXAxVVRKeFJEZ0tTakpRZGtWdWEyTk1UV05RVG14RE1DOVRTR1YzV25kME5FRjRLM2RDWTFSSVJ6aGpWakJhZUZSYVQwdDNPSFJ4UWxrMk1tcGtOM1p4VkdoeFRWbHdad3AyYzNwSFVXeHlXbGRyZHpSUmFrUldORnBLY1dSbFRITkRVV3BqZUZsa05Ea3JSalEyYkVsS1VUSjVjRXhTUjBkb2NGTlpZMlYzWkdOTVkweHNTamRIQ21wRlJFTnlVRGxrWTFsSWRWUTFlSE5YVG5aQlFXcG5RM051UTNsU1ZXbExOVzAyTDFaR1JEQllTVFp6TlZFclFuZDBPVXNyUzFkblJrSlBVQ3M0TlRBS1Vra3ZZblJSYTJsdmNIZFphMGR1WmtkVE9FeEJiM2t2TTBwUWFsTXlWbXAwUVN0aVR6SnhUa1pFTmpWcWEwRXhWa05XVGxFeFIxVmphV1pYUTFaQ2RRcHpOM2hQUWpnME9WZzVjMUZ6TVhaTlpWSTNTbTh6VjBSRFJEWm9lVTFXZDNOb1FqbEdhR2QxYm5acFNFRlRibkJ5UTJWME9EUjJaMnBSYVdWT1RITmhDbWRFZEhaRlVVbEVRVkZCUW04eFdYZFdSRUZQUW1kT1ZraFJPRUpCWmpoRlFrRk5RMEpoUVhkRmQxbEVWbEl3YkVKQmQzZERaMWxKUzNkWlFrSlJWVWdLUVhkSmQwUkJXVVJXVWpCVVFWRklMMEpCU1hkQlJFRm1RbWRPVmtoVFRVVkhSRUZYWjBKVFJTOURaemhCV21oTFRrMXRZbWRCTTNnelpuVlBaamQ0U0FwUGVrRk9RbWRyY1docmFVYzVkekJDUVZGelJrRkJUME5CVVVWQk5XNWlRME5LYTBwTk5qQkRjVlZsZFdWVVUwbzBaRXBWWkc5S1NHVkhVblJGTWtKRkNrOVNXWEJIVUVVMllqUk5VVlJYY3pSbFZrOTFiRlUzYnpabU9WZFFVV1pDWm5JMmVGSlBXRFo1YUVoM2NIcDNkRVpVVW1od1lqaE5TVWxKV2pscWRqWUtaVVZ3TXpoWmFtUnBPVkV3SzBSaFkzRkxka0pVTURsMVEzWmtNR2x3UnpkTFNuVlNibkZMVVd4VWNtVnRkWFJsVGpOMk9HOUNTVGxXWjJsc2JXUllaZ3BwWkdGS1lqUlJaelpZVkdvemNFMUdkbFpqWTNOSGFWZG9UMHh5T1ZaSVZDdFFWazVaTjB4WlVHeG1Xa2RETkRCSk1URmlTVFZuUlZadVUydHZNa1JqQ21Od1NXOHJNbmRWZFRGU1IybExZMUp3V0RSb1FtUnBORWxYYlM4ek5sTXhaM2gzTW1KMFdFOWxNV3Q2T1c5SFlVNVplazVXU1VObkwzZDNiRzVEYVVNS2FtWjRiVFJJZWtOR1NXcHZRMGRxVFdWWVJFMVhieTlGT0d0U2RuaDFhMnQzYlc1MWN6aHpVV05FTVcxUkswZFFlbWM5UFFvdExTMHRMVVZPUkNCRFJWSlVTVVpKUTBGVVJTMHRMUzB0Q2c9PQogICAgY2xpZW50LWtleS1kYXRhOiBMUzB0TFMxQ1JVZEpUaUJTVTBFZ1VGSkpWa0ZVUlNCTFJWa3RMUzB0TFFwTlNVbEZiM2RKUWtGQlMwTkJVVVZCTlVORVpGcFlla2h2V25WUk1uRkVPRW95VUhaRmJtdGpURTFqVUU1c1F6QXZVMGhsZDFwM2REUkJlQ3QzUW1OVUNraEhPR05XTUZwNFZGcFBTM2M0ZEhGQ1dUWXlhbVEzZG5GVWFIRk5XWEJuZG5ONlIxRnNjbHBYYTNjMFVXcEVWalJhU25Ga1pVeHpRMUZxWTNoWlpEUUtPU3RHTkRac1NVcFJNbmx3VEZKSFIyaHdVMWxqWlhka1kweGpUR3hLTjBkcVJVUkRjbEE1WkdOWlNIVlVOWGh6VjA1MlFVRnFaME56YmtONVVsVnBTd28xYlRZdlZrWkVNRmhKTm5NMVVTdENkM1E1U3l0TFYyZEdRazlRS3pnMU1GSkpMMkowVVd0cGIzQjNXV3RIYm1aSFV6aE1RVzk1THpOS1VHcFRNbFpxQ25SQksySlBNbkZPUmtRMk5XcHJRVEZXUTFaT1VURkhWV05wWmxkRFZrSjFjemQ0VDBJNE5EbFlPWE5SY3pGMlRXVlNOMHB2TTFkRVEwUTJhSGxOVm5jS2MyaENPVVpvWjNWdWRtbElRVk51Y0hKRFpYUTROSFpuYWxGcFpVNU1jMkZuUkhSMlJWRkpSRUZSUVVKQmIwbENRVUU0YTFZd01uSk5Tbm8zWkVkMmRRcHFORFJXZUdkTFZqUXhZbVJvTldJeFYwYzBUVEV6Y0VkWldUQnFhSGswT0RKa2JtcFVhVUpGTTNKU2JHWkxjSFZWUVZVMllXTmxWVFp3WkhreFUyMW5DbTgzWkVkYVJYQXpUMVZKVkVkU1JHSnhVR0ZzTHpCaUx6TjFZbWx1WWxSSGRucE1SVEZ1TDBoSWFrcEtabWhyZEhSd05ITk5jMjl6THlzNVFsWjRWbmNLVkVsR01uTjJWa1Z3WmtWdmVrdGhaMGhXYW5kcVVtZFpiVFpWTkZWYWVIVjJaRmcwVVhGdVVIRm5hVmgyZUd3eU5HeFhibkV6V25wYVQwSjJXa0p6Y2dwM1NWbERlRlJJWWprek5YbGplV3RMS3pKaEwxTlllRGRaUm5GTkwwRXdXbXMyWmxoMVRHeHVVME5wUkdSdlVsUjFWbTFtYWpjMU9VVkRVMjV1YzFCeENreE1hVnBxY1dwc2J6SlNaRlpSVlVOeVRrSk1MMHBGUjJ4aE5IZ3pkRUpxU21NdmFTdDJLekF2Tms1aVdtVm5aMk5tYlcxQk5USk5TRm8xVVVaVVZrb0tkRTkxT0RnMFJVTm5XVVZCTlZKd1FuSmFZazFXVW1sd1dVOVNPVkl4WVdjclZVeHhORlEzUW1sMU5XWkZXQzloZWtoemVsQmlUR0ZvYURaWVFuQjNTQW95YUZKa01XbDJObUZRVkZOSFRYbDFOR2M0WmtSM1owdzJOVE51VVZCVloxUlRURmxVV2xwb2NqUkNPRTUxYmxFMU9XOUZjREUzVW5VNWFIWkhOV1Z5Q204emNIZ3hNRXhRVUdaaUsyUnpNazU2UWxab2IwVlVNSGx5ZFcxbGNXbzFUemxNY1djeFVqRk1NbE5zWlc4M1ZTOXBVRVJMTUd0RFoxbEZRUzkxYkZVS1RHRnBObWRoWVN0VVV5dDRNVEowTlhWblZYaE5kRGROWkhSc2NsRkpjRkl4V2xsV04xQk1kVXBxVDJsSE1HaHdkM2RGWjNkcVdEVXZRMncxU1d0MVNRbzJWaXRKVjFWdFpGcERZbkZoTURsME9XcDZTVXB5TDFjMU5IcFJabmRUWWxsdE9YRjBPVVpZU0cxNWNFMXpUblZKSzBKb1IweENSRGh4UmpKQ1FVaFFDbXhXTkdwSFYxTkJSSG94Y2t0WVNGVkRkRTh4U21KUmMxSTRieXRqWkdGM05XTm1VMGhaYTBObldVVkJNMHc1YlRVd1lqQjZWVEk0TjI5S1lXWXJSbXdLY1RaamFIZEVWVU56WTFseGVtbGhLMmRQV2pSdlozUjVZVmRoVTB0TGEzaEhOVEJwUzFadmIzQjJZVEprV0ZSTVZWVkJNbk5tYjFReWEzaEZXbG9yVEFwS2VXWmhLMU01WTBsdmJWQndhVEl5ZGpVclptVnNSblpxZVhKc1N6bFpRbUZNZUhwamJrZExWa2M1YjBWeWNrOHhVVlZLUlhrNEswZDRWMmxRU0VGU0NqZGxWekZXZVU5TE5HdGFPRGs1UlcxUk1WaGpSMUpyUTJkWlFqa3pUMng1WW1ab1FUUm1jbVZyTm10ck5qSXdPRWQ1YjNseGRUSmlNVlJvZFhOd01EY0tZalZMT1RONWExWmtZazFhT0RSUk9VRTRZVkF2YVZSRWFrSnlRMmQ2WkVSMU5tSlJTakZtZFZKdlZFTnVXVW95TjFsWlMwVXZhbWhrV21KUk1FazJSUXBoVDNwNFprRjVaU3RvYjBVNVdtWm9XVkF5ZDA5blFXbDNabEpMWjBSYWJEQjNhRlJzYkhKbmNUTjJTa0lyYjJoMWJYbGpRa1F4UlRaVFozZ3ZNRnA1Q2k5c2JsSjFVVXRDWjBaTWNGWTVVQzg1Y21GbWJtUjBXRFZZZVZWMFQwMHZRbmt6UlZsbmJGbHZSMDlrUlhGTmFIaFlSeXQzUTFaQ1ZFSlZUMlJ6Y0V3S1RreGlVVkI0YW1KT1ZFMVFTakI2U0ZwcVppdDFhMHBvU1U5MGR6UmlUbk51YzNCa1NsTnpWMmRtTlhVeGRqZFBaMkUyVnpKMGFFRkNSelE1VEZGbFJ3cHRNWEZHUTJkTFpEZFpVRzlMUldKbGIwMXpTRXBSZUhCR2VYWnZSSE40VEZVNU0wOUVVblE1YVVGSFpFMUpZMll5Y25CTkNpMHRMUzB0UlU1RUlGSlRRU0JRVWtsV1FWUkZJRXRGV1MwdExTMHRDZz09Cg==
</code></pre><blockquote>
<p>如果 base64 后存在换行，那么可以使用 <code>base64 -w 0 ./kubeconfig</code></p>
</blockquote>
<p>将 base64 后的内容设置到 PeidaCluster 的 <code>spec.kubeconfig</code> 中即可，并且 <code>spec.apiserver</code> 以及其他验证字段都不需要填写</p>
<p>不过由于集群地址在 kube config 中配置，所以使用 <code>kubectl get pediacluster</code> 时 APIServer 为空</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get pediacluster
</code></pre></div><pre tabindex=0><code># 输出：
NAME           APISERVER URL       VERSION    STATUS
cluster-1                          v1.22.2    Healthy
</code></pre><p>未来会增加 Mutating admission webhooks 来自动设置 <code>spec.apiserver</code>，当前如果用户想要在 kubectl get 时显示集群地址，那么需要手动额外配置 <code>spec.apiserver</code> 字段</p>
<h2 id=使用-serviceaccount-来接入集群>使用 ServiceAccount 来接入集群</h2>
<p>用户也可以选择在<strong>被接入集群</strong>中创建 ServiceAccount 并配置相应的 RBAC 来接入集群。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 注意：当前 kubectl 连接到被接入集群</span>
kubectl apply -f https://raw.githubusercontent.com/clusterpedia-io/clusterpedia/main/examples/clusterpedia_synchro_rbac.yaml

<span style=color:#8f5902;font-style:italic># 获取 Service Account 对应 CA 和 Token</span>
<span style=color:#000>SYNCHRO_CA</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl -n default get secret <span style=color:#204a87;font-weight:700>$(</span>kubectl -n default get serviceaccount clusterpedia-synchro -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.secrets[0].name}&#39;</span><span style=color:#204a87;font-weight:700>)</span> -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.data.ca\.crt}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
<span style=color:#000>SYNCHRO_TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl -n default get secret <span style=color:#204a87;font-weight:700>$(</span>kubectl -n default get serviceaccount clusterpedia-synchro -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.secrets[0].name}&#39;</span><span style=color:#204a87;font-weight:700>)</span> -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.data.token}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</code></pre></div><p>将 <code>$SYNCHRO_CA</code> 和 <code>$SYNCHRO_TOKEN</code> 分别填写到 PediaCluster 资源的 <code>spec.caData</code> 和 <code>spec.tokenData</code> 字段中</p>
<h2 id=创建-pediacluster>创建 PediaCluster</h2>
<p>完善集群的验证信息后，就可以获得一个完整的 <code>PediaCluster</code> 资源了。直接使用 <code>kubectl apply -f</code> 直接创建即可</p>
<p>eg.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster.clusterpedia.io/v1alpha2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PediaCluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>apiserver</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://10.6.100.10:6443</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>caData</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeE1Ea3lOREV3TVRNeU5Gb1hEVE14TURreU1qRXdNVE15TkZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTy9TCnZta1U5bk1uUlRIT3lvK3hjdFRJY0lPYnMzc0F5cTI2djRQYkVtb3ZWM2xPOVQwMTF2cE96S0pyOUFxeVZMRnYKVXFBRHBTakM3WXd3MnZwSld3bDEySlBvUm1xZ1FBSFNkYlJpU3BDTDRudjlvR25VOWI2dllWSy9iRitkUVFCSApnQ1h6NnZoTGY4Wmd2N2tUQ2JBdkFPaE9OSlU3MllYTE8zT0lZQjJva1NCRGFVUjNvNnpwZGVWTkt5V0EyNVA3CkRobk8yTk01QzlpRERqTTRLY2FTa3JPSkJvbUlsSHFZRjRwVXdTTlFvcGVGRVRyZ3ZzcTkwSks2YUJVS0t5ajYKK2NGdjI3S0k4K1ZMUEtaSTE2c25Mbng2RXRTazZtZjJXTHdJZlhyQlgwREsvYXBEQ015R2pEb2dCaGpJSVhoVAp2bjVQZndFWUNsdGZFTEhKSkdVQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZJVDhLRHdCbUVvMHladUFEZkhkKzQ1L3ZFYzdNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBT0F5VHQ4S3ZFN0dvREhQT09pdgoyR2I2WWVsUU5KcUMza1dIOXc1NTFNaGZvS3ZiM21VaUV6ZVMwOUNwZUQrTFh5ZnlqQzhZYkJxQjZXSFhNZWMrCnpPdDNPazRYV0FmZVVZTXhOQ1FJblc4cjI4cmZnblErc1NCdHQyeERQN1RZY09oNVZGZkI2K3JtTmFTblZ1NjgKSFFxdlFMNEFXbVhkR09jRWNBRThYdkdiOWhwSjVNckRHdzQ0UTYyOG9YazZ0N01aWTFOMUNQdW9HZ1VmS1N3bgo1MUFWRTFOVVdNV0tEQXhaa2I4bEhvR3VWaDFzWmd3SnJRQjR5clh1cmxGN0Y2bVRlYm4rcDVKM0toT0V4KzlsCjFXdkwwbWkxL1J2bVJKNm11YmtjWUwzN1FJWjI1YXdyaEZMN0Z1ejNRSTFqTTdYMHZET2VUM2VuVUFCZW5SMS8KUnlnPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>tokenData</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNklrMHRSalJtZGpSdVgxcFljMGxsU1ZneFlXMHpPSFZOY0Zwbk1UTkhiVFpsVFZwQ2JIWk9SbU5XYW5NaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbU5zZFhOMFpYSndaV1JwWVMxemVXNWphSEp2TFhSdmEyVnVMVGsxYTJSNElpd2lhM1ZpWlhKdVpYUmxjeTVwYnk5elpYSjJhV05sWVdOamIzVnVkQzl6WlhKMmFXTmxMV0ZqWTI5MWJuUXVibUZ0WlNJNkltTnNkWE4wWlhKd1pXUnBZUzF6ZVc1amFISnZJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpYSjJhV05sTFdGalkyOTFiblF1ZFdsa0lqb2lNREl5WXpNMk5USXRPR1k0WkMwME5qSmtMV0l6TnpFdFpUVXhPREF3TnpFeE9HUTBJaXdpYzNWaUlqb2ljM2x6ZEdWdE9uTmxjblpwWTJWaFkyTnZkVzUwT21SbFptRjFiSFE2WTJ4MWMzUmxjbkJsWkdsaExYTjVibU5vY204aWZRLkF4ZjhmbG5oR0lDYjJaMDdkT0FKUW11aHVIX0ZzRzZRSVY5Sm5sSmtPUnF5aGpWSDMyMkVqWDk1bVhoZ2RVQ2RfZXphRFJ1RFFpLTBOWDFseGc5OXpYRks1MC10ZzNfYlh5NFA1QnRFOUpRNnNraUt4dDFBZVJHVUF4bG5fVFU3SHozLTU5Vnl5Q3NwckFZczlsQWQwRFB6bTRqb1dyS1lKUXpPaGl5VjkzOWpaX2ZkS1BVUmNaMVVKVGpXUTlvNEFFY0hMdDlyTEJNMTk2eDRkbzA4ZHFaUnVtTzJZRXFkQTB3ZnRxZ2NGQzdtTGlSVVhkWElkYW9CY1BuWXBwM01MU3B5QjJQMV9vSlRFNS1nd3k4N2Jwb3U1RXo2TElSSExIeW5NWXAtWVRLR2hBbDJwMXdJb0tDZUNnQng4RlRfdzM4Rnh1TnE0UDRoQW5RUUh6bU9Ndw==</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=集群查看>集群查看</h2>
<p>集群接入成功后，可以通过 <code>kubectl get pediacluster</code> 命令来查看所有接入的集群，以及集群状态</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get pediacluster
</code></pre></div><pre tabindex=0><code># 输出：
NAME           APISERVER URL               VERSION    STATUS
cluster-1      https://10.6.100.10:6443    v1.22.2    Healthy
cluster-2      https://10.50.10.11:16443   v1.10.11   Healthy
</code></pre><h2 id=接下来>接下来</h2>
<p>继续查看 <a href=../sync-resources>同步集群资源</a></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3fe23ba64b8bbae5fab0c8696ae005cb>3.2 - 接入多云平台</h1>
<p>0.4.0 后，Clusterpedia 提供了更加友好的接入多云平台的方式。</p>
<p>用户通过创建 <code>ClusterImportPolicy</code> 来自动发现多云平台中纳管的集群，并将这些集群自动同步为 <code>PediaCluster</code>，用户不需要根据纳管的集群来手动去维护 <code>PediaCluster</code> 了。</p>
<p>我们在 <a href=https://github.com/clusterpedia-io/clusterpedia/tree/main/deploy/clusterimportpolicy>Clusterpedia 仓库</a> 中维护了各个多云平台的 <code>ClusterImportPolicy</code>。
<strong>大家也提交用于对接其他多云平台的 <code>ClusterImportPolicy</code>。</strong></p>
<p>用户在<a href=../../installation>安装 Clusterpedia</a> 后，创建合适的 <code>ClusterImportPolicy</code> 即可，用户也可以根据自己的需求来<a href=#%E6%96%B0%E5%BB%BA-clusterimportpolicy>创建新的 <code>ClusterImportPolicy</code></a></p>
<h2 id=cluster-api-clusterimportpolicy>Cluster API ClusterImportPolicy</h2>
<p>用户可以参考 <a href=https://cluster-api.sigs.k8s.io/user/quick-start.html>Cluster API Quick Start</a> 来安装 Cluster API，或者参考 <a href=https://clusterpedia.io/zh-cn/blog/2022/08/04/cluster-api-searching-has-never-been-easier/#%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2%E4%B8%80%E5%A5%97-cluster-api-and-clusterpedia-%E7%9A%84%E7%A4%BA%E4%BE%8B%E7%8E%AF%E5%A2%83>快速部署 Cluster API + Clusterpedia</a> 来搭建示例环境。</p>
<p>创建用于对接 Cluster API 平台的 <code>ClusterImportPolicy</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl apply -f https://raw.githubusercontent.com/clusterpedia-io/clusterpedia/main/deploy/clusterimportpolicy/cluster_api.yaml
$ kubectl get clusterimportpolicy
NAME          AGE
cluster-api   4d19h
</code></pre></div><p>如果集群中已经存在由 Cluster API 创建的集群，那么可以查看 <code>Cluster</code> 与 <code>PediaCluster</code> 资源</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get cluster
NAME                PHASE         AGE     VERSION
capi-quickstart     Provisioned   3d23h   v1.24.2
capi-quickstart-2   Provisioned   3d23h   v1.24.2

$ kubectl get pediaclusterlifecycle
NAME                        AGE
default-capi-quickstart     3d23h
default-capi-quickstart-2   3d23h

$ kubectl get pediacluster
NAME                        READY   VERSION   APISERVER
default-capi-quickstart     True    v1.24.2
default-capi-quickstart-2   True    v1.24.2
</code></pre></div><p><a href=../../concepts/pediacluster>PediaCluster</a> 会根据 Cluster 自动创建，并且当 Cluster 的 kubeconfig 发生变动时会自动更新 <a href=../../concepts/pediacluster>PediaCluster</a>.</p>
<p>新建一个 Cluster 资源时，Clusterpedia 根据 <a href=https://github.com/clusterpedia-io/clusterpedia/blob/main/deploy/clusterimportpolicy/cluster_api.yaml>Cluster API ClusterImportPolicy</a> 等到 ControlPlaneInitialized 为 True 时才会自动创建 PediaCluster，可以通过 <code>kubectl get kubeadmcontrolplane</code> 来查看集群的初始化状态</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>NAME                    CLUSTER           INITIALIZED   API SERVER AVAILABLE   REPLICAS   READY   UPDATED   UNAVAILABLE   AGE   VERSION
capi-quickstart-2xcsz   capi-quickstart   <span style=color:#204a87>true</span>                                 <span style=color:#0000cf;font-weight:700>1</span>                  <span style=color:#0000cf;font-weight:700>1</span>         <span style=color:#0000cf;font-weight:700>1</span>             86s   v1.24.2
</code></pre></div><p>Cluster 初始化完成后，就可以直接使用 kubectl 来检索多集群资源了</p>
<blockquote>
<p>使用 kubectl 前，需要为多集群资源检索生成集群快捷配置 —— <a href=../access-clusterpedia#%E4%B8%BA-kubectl-%E7%94%9F%E6%88%90%E9%9B%86%E7%BE%A4%E8%AE%BF%E9%97%AE%E7%9A%84%E5%BF%AB%E6%8D%B7%E9%85%8D%E7%BD%AE>为 kubectl 生成集群访问的快捷配置</a></p>
</blockquote>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ <span style=color:#8f5902;font-style:italic># Since CNI is not installed, the nodes are not ready.</span>
$ kubectl --cluster clusterpedia get no
CLUSTER                     NAME                                            STATUS     ROLES           AGE   VERSION
default-capi-quickstart-2   capi-quickstart-2-ctm9k-g2m87                   NotReady   control-plane   12m   v1.24.2
default-capi-quickstart-2   capi-quickstart-2-md-0-s8hbx-7bd44554b5-kzcb6   NotReady   &lt;none&gt;          11m   v1.24.2
default-capi-quickstart     capi-quickstart-2xcsz-fxrrk                     NotReady   control-plane   21m   v1.24.2
default-capi-quickstart     capi-quickstart-md-0-9tw2g-b8b4f46cf-gggvq      NotReady   &lt;none&gt;          20m   v1.24.2
</code></pre></div><h2 id=karmada-clusterimportpolicy>Karmada ClusterImportPolicy</h2>
<blockquote>
<p>对于 Karmada 平台，用户首先需要先将 Clusterpedia 部署在 Karmada APIServer 中，部署步骤可以参考 <a href=https://github.com/Iceber/deploy-clusterpedia-to-karmada>https://github.com/Iceber/deploy-clusterpedia-to-karmada</a></p>
</blockquote>
<p>创建用于对接 Karmada 平台的 <code>ClusterImportPolicy</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl create -f https://raw.githubusercontent.com/clusterpedia-io/clusterpedia/main/deploy/clusterimportpolicy/karmada.yaml
$ kubectl get clusterimportpolicy
NAME      AGE
karmada   7d5h
</code></pre></div><p>查看 <code>Karmada Cluster</code> 与 <code>PediaClusterLifecycle</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get cluster
NAME      VERSION   MODE   READY   AGE
argocd              Push   False   8d
member1   v1.23.4   Push   True    22d
member3   v1.23.4   Pull   True    22d

$ kubectl get pediaclusterlifecycle
NAME              AGE
karmada-argocd    7d5h
karmada-member1   7d5h
karmada-member3   7d5h
</code></pre></div><p>Clusterpedia 会为每一个 Karmada Cluster 创建对应的 <code>PediaClusterLifecycle</code>，可以使用 <code>kubectl describe pediaclusterlifecycle &lt;name></code> 来查看 Karmada Cluster 与 PediaCluster 的转换状态</p>
<blockquote>
<p>未来会在 <code>kubectl get pediaclusterlifecycle</code> 中详细状态</p>
</blockquote>
<p>查看成功创建的 <code>PediaCluster</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>NAME              APISERVER                 VERSION   STATUS
karmada-member1   https://172.18.0.4:6443   v1.23.4   Healthy
</code></pre></div><p>karmada clusterimportpolicy 要求 karmada 集群为 Push 模式，并且处于 Ready 状态，所以为 <em>member-1</em> 集群创建了 <em>karmada-member-1</em> pediacluster 资源。</p>
<h2 id=vcluster-clusterimportpolicy>VCluster ClusterImportPolicy</h2>
<p>创建用于自动发现 <a href=https://github.com/loft-sh/vcluster>VCluster</a> 的 <code>ClusterImportPolicy</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl create -f https://raw.githubusercontent.com/clusterpedia-io/clusterpedia/main/deploy/clusterimportpolicy/vcluster.yaml
$ kubectl get clusterimportpolicy
NAME      AGE
vclsuter  5h
</code></pre></div><p><strong>需要注意，VCluster 集群在创建时需要保证生成的 kubeconfig 的 Server 地址可以由宿主集群内的其他 Pod 访问。</strong></p>
<p>可以设置为 VCluster Service 域名，也可以是 Node IP 或者 Ingress 地址</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>syncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>extraArgs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- --<span style=color:#000>out-kube-config-server=https://&lt;vcluster name&gt;.&lt;namespace&gt;.svc</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- --<span style=color:#000>tls-san=&lt;vcluster name&gt;.&lt;namespace&gt;.svc,127.0.0.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>在 default 命名空间创建两个 VCluster，
创建虚拟集群 vcluster-1</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># vcluster-1.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>syncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>extraArgs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- --<span style=color:#000>out-kube-config-server=https://vcluster-1.default.svc</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- --<span style=color:#000>tls-san=vcluster-1.default.svc,127.0.0.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ vcluster create -n default -f vcluster-1.yaml vcluster-1
</code></pre></div><p>创建虚拟集群 vcluster-2</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># vcluster-2.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>syncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>extraArgs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- --<span style=color:#000>out-kube-config-server=https://vcluster-2.default.svc</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- --<span style=color:#000>tls-san=vcluster-2.default.svc,127.0.0.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ vcluster create -n default -f vcluster-2.yaml vcluster-2
</code></pre></div><p>查看所有的 VCluster 集群</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ vcluster list
 NAME              NAMESPACE         STATUS    CONNECTED   CREATED                         AGE
 caiwei-vcluster   caiwei-vcluster   Running               2022-08-26 16:10:52 +0800 CST   484h49m6s
 vcluster-1        default           Running               2022-09-15 20:57:59 +0800 CST   1m59s
 vcluster-2        default           Running               2022-09-15 20:59:34 +0800 CST   24s
</code></pre></div><p>我们可以直接使用 kubectl + Clusterpedia 来检索任意 VCluster 内的资源</p>
<blockquote>
<p>使用 kubectl 前，需要为多集群资源检索生成集群快捷配置 —— <a href=../access-clusterpedia#%E4%B8%BA-kubectl-%E7%94%9F%E6%88%90%E9%9B%86%E7%BE%A4%E8%AE%BF%E9%97%AE%E7%9A%84%E5%BF%AB%E6%8D%B7%E9%85%8D%E7%BD%AE>为 kubectl 生成集群访问的快捷配置</a></p>
</blockquote>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> $ kubectl --cluster clusterpedia get po -A
NAMESPACE     CLUSTER                              NAME                       READY   STATUS    RESTARTS   AGE
default       vc-caiwei-vcluster-caiwei-vcluster   backend-77f8f45fc8-5ssww   1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          20d
default       vc-caiwei-vcluster-caiwei-vcluster   backend-77f8f45fc8-j5m4c   1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          20d
default       vc-caiwei-vcluster-caiwei-vcluster   backend-77f8f45fc8-vjzf6   1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          20d
kube-system   vc-default-vcluster-1                coredns-669fb9997d-cxktv   1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          3m40s
kube-system   vc-default-vcluster-2                coredns-669fb9997d-g7w8l   1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          2m6s
kube-system   vc-caiwei-vcluster-caiwei-vcluster   coredns-669fb9997d-x6vc2   1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          20d

$ kubectl --cluster clusterpedia get ns
CLUSTER                              NAME              STATUS   AGE
vc-default-vcluster-2                default           Active   2m49s
vc-default-vcluster-1                default           Active   4m24s
vc-caiwei-vcluster-caiwei-vcluster   default           Active   20d
vc-default-vcluster-2                kube-node-lease   Active   2m49s
vc-default-vcluster-1                kube-node-lease   Active   4m24s
vc-caiwei-vcluster-caiwei-vcluster   kube-node-lease   Active   20d
vc-default-vcluster-2                kube-public       Active   2m49s
vc-default-vcluster-1                kube-public       Active   4m24s
vc-caiwei-vcluster-caiwei-vcluster   kube-public       Active   20d
vc-default-vcluster-2                kube-system       Active   2m49s
vc-default-vcluster-1                kube-system       Active   4m24s
vc-caiwei-vcluster-caiwei-vcluster   kube-system       Active   20d
</code></pre></div><p>Clusterpedia 会自动发现宿主集群内的虚拟集群（VCluster），并根据 <a href=https://github.com/clusterpedia-io/clusterpedia/blob/main/deploy/clusterimportpolicy/vcluster.yaml>VCluster ClusterImportPolicy</a> 创建相应的 <a href=../../concepts/pediacluster>PediaCluster</a>，用户可以直接访问 Clusterpedia 来检索资源</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get pediaclusterlifecycle
NAME                                 AGE
vc-caiwei-vcluster-caiwei-vcluster   20d
vc-default-vcluster-1                5m57s
vc-default-vcluster-2                4m24s

$ kubectl get pediacluster
NAME                                 READY   VERSION        APISERVER
vc-caiwei-vcluster-caiwei-vcluster   True    v1.23.5+k3s1   https://caiwei-vcluster.caiwei-vcluster.svc
vc-default-vcluster-1                True    v1.23.5+k3s1   https://vcluster-1.default.svc
vc-default-vcluster-2                True    v1.23.5+k3s1   https://vcluster-2.default.svc
</code></pre></div><h2 id=新建-clusterimportpolicy>新建 ClusterImportPolicy</h2>
<p>如果 <a href=https://github.com/clusterpedia-io/clusterpedia/tree/main/deploy/clusterimportpolicy>Clusterpedia 仓库</a> 中没有维护某个平台的 ClusterImportPolicy，那么我们可以新建 ClusterImportPolicy</p>
<p><strong>关于 ClusterImportPolicy 原理和字段的详细描述可以参考 <a href=../../concepts/cluster-import-policy>集群自动接入策略</a></strong></p>
<p>现在假定有一个多云平台 <strong>MCP</strong>，该平台使用自定义资源 —— Cluster 来代表被纳管的集群，并且将集群的认证信息保存在和集群同名的 Secret 中</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster.mcp.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>apiEndpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;https://172.10.10.10:6443&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>authSecretRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;default&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cluster-1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>conditions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Ready</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>True</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Secret</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ca</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>**cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ca bundle**</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>token</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>**cluster</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>token**</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>我们为 <strong>MCP</strong> 平台定义一个 <code>ClusterImportPolicy</code> 资源，并且默认同步 pods 和 apps group 下的资源</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>policy.clusterpedia.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClusterImportPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mcp</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>source</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cluster.mcp.io&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusters</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>versions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>references</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>resource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>versions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>namespaceTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;{{ .source.spec.authSecretRef.namespace }}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>nameTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;{{ .source.spec.authSecretRef.name }}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authSecret</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>nameTemplate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;mcp-{{ .source.metadata.name }}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>    spec:
</span><span style=color:#8f5902;font-style:italic>      apiserver: &#34;{{ .source.spec.apiEndpoint }}&#34;
</span><span style=color:#8f5902;font-style:italic>      caData: &#34;{{ .references.authSecret.data.ca }}&#34;
</span><span style=color:#8f5902;font-style:italic>      tokenData: &#34;{{ .references.authSecret.data.token }}&#34;
</span><span style=color:#8f5902;font-style:italic>      syncResources:
</span><span style=color:#8f5902;font-style:italic>        - group: &#34;&#34;
</span><span style=color:#8f5902;font-style:italic>          resources:
</span><span style=color:#8f5902;font-style:italic>          - &#34;pods&#34;
</span><span style=color:#8f5902;font-style:italic>        - group: &#34;apps&#34;
</span><span style=color:#8f5902;font-style:italic>          resources:
</span><span style=color:#8f5902;font-style:italic>          - &#34;*&#34;
</span><span style=color:#8f5902;font-style:italic>      syncResourcesRefName: &#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>    
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>creationCondition</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>    {{ if ne .source.spec.apiEndpoint &#34;&#34; }}
</span><span style=color:#8f5902;font-style:italic>      {{ range .source.status.conditions }}
</span><span style=color:#8f5902;font-style:italic>        {{ if eq .type &#34;Ready&#34; }}
</span><span style=color:#8f5902;font-style:italic>          {{ if eq .status &#34;True&#34; }} true {{ end }}
</span><span style=color:#8f5902;font-style:italic>        {{ end }}
</span><span style=color:#8f5902;font-style:italic>      {{ end }}
</span><span style=color:#8f5902;font-style:italic>    {{ end }}</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></code></pre></div><ul>
<li><code>spec.source</code> 定义了需要监听的资源 Cluster</li>
<li><code>spec.references</code> 定义了将 MCP Cluster 转换为 PediaCluster 时涉及到的资源，当前只有 secrets 资源</li>
<li><code>spec.nameTemplate</code> 会根据 MCP Cluster 资源渲染出 PediaCluster 资源的名字</li>
<li><code>spec.template</code> 通过 MCP Cluster 和 <code>spec.references</code> 中定义的资源来渲染出 PediaCluster 资源，具体规则可以参考 <a href=../../concepts/cluster-import-policy#pediacluster-template>PediaCluster Template</a></li>
<li><code>spec.creationCondition</code> 可以根据 MCP Cluster 和 <code>spec.references</code> 定义的资源来可以决定了什么时候可以创建 PediaCluster，这里定义了当 MCP Cluster 处于 Ready 后再创建 PediaCluster，具体使用可以参考 <a href=../../concepts/cluster-import-policy#creation-condition>Creation Condition</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-64bebf7ca20899cc843d095cee1d0313>3.3 - 同步集群资源</h1>
<p>Clusterpedia 的主要功能，便是提供对多集群内的资源进行复杂检索。</p>
<p>通过 <code>PediaCluster</code> 资源来指定该集群中哪些资源需要支持复杂检索，Clusterpedia 会将这些资源实时的通过<code>存储层</code>同步到<code>存储组件</code>中</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># example</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster.clusterpedia.io/v1alpha2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PediaCluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>apiserver</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;https://10.30.43.43:6443&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#000>deployments</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#000>pods</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#000>configmaps</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cert-manager.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>versions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>certificates</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=内置资源同步>内置资源同步</h2>
<p><code>PediaCluster</code> 为了方便管理和查看这些同步的资源，用户需要以 Group 为单位来配置资源</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>syncResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline> </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>versions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#000>deployments</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#000>daemonsets</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><strong>对于内置资源，不需要填写 <code>versions</code> 字段。</strong></p>
<p>Clusterpedia 会根据该集群内所支持的资源版本自动选择合适的版本来收集，
并且用户无需担心版本转换的问题， Clusterpedia 会开放出该内置资源的所有版本接口。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis/apps&#34;</span> <span style=color:#000;font-weight:700>|</span> jq
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;kind&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;APIGroup&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;apiVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;versions&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps/v1&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1&#34;</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps/v1beta2&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1beta2&#34;</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps/v1beta1&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1beta1&#34;</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>],</span>
  <span style=color:#204a87;font-weight:700>&#34;preferredVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps/v1&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1&#34;</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>可以看到 Clusterpedia 支持 <code>v1</code>，<code>v1beta2</code>，<code>v1beta1</code> 三个版本的 <code>Deployment</code></p>
<h2 id=自定义资源同步>自定义资源同步</h2>
<p>相比内置资源，自定义资源在资源版本的配置上会稍有不同。</p>
<pre tabindex=0><code class=language-yaml: data-lang=yaml:>syncResources:
 - group: cert-manager.io
   versions: []
   resources:
    - certificates
</code></pre><p><strong>用户同样可以忽略 versions 字段，这时 Clusterpedia 就会同步该 Group 在该集群的前三个版本。</strong></p>
<p>以 cert-manager.io 为例，获取被接入集群中 cert-manager.io 支持的 Group</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 在被接入集群内执行</span>
kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/cert-manager.io&#34;</span> <span style=color:#000;font-weight:700>|</span> jq
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;kind&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;APIGroup&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;apiVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cert-manager.io&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;versions&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cert-manager.io/v1&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1&#34;</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cert-manager.io/v1beta1&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1beta1&#34;</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cert-manager.io/v1alpha3&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1alpha3&#34;</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cert-manager.io/v1alpha2&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1alpha2&#34;</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>],</span>
  <span style=color:#204a87;font-weight:700>&#34;preferredVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cert-manager.io/v1&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1&#34;</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>可以看到，被接入集群支持 <em>cert-manager.io</em> 的 <code>v1</code>，<code>v1beta1</code>，<code>v1alpha3</code>，<code>v1alpha2</code> 四个版本。</p>
<p>当 <code>syncResources.[group].versions</code> 为空时，Clusterpedia 就会以 <code>APIGroup.versions</code> 列表的顺序，收集 <code>v1</code>， <code>v1beta1</code>，<code>v1alpah3</code> 三个版本，而 <code>v1alpha2</code> 不会被收集</p>
<h3 id=指定自定义资源的同步版本>指定自定义资源的同步版本</h3>
<p>如果用户指定了 <code>versions</code>，那么就会按照 <code>versions</code> 的配置来收集指定的版本资源。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>syncResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline> </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cert-manager.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>versions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>certificates</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>这时，只会收集 <code>v1beta1</code> 版本。</p>
<h3 id=使用注意>使用注意</h3>
<p>自定义资源收集暂时不支持版本转换，收集了哪些版本，那么就只支持哪些资源版本的收集。</p>
<p>这时在检索多集群资源时，如果 cluster-1 只收集了 <code>v1beta1</code> 版本的资源，而检索请求 v1 版本的资源便会忽略 cluster-1 所收集的 <code>v1beta1</code> 版本</p>
<p>需要用户去协调处理自定义资源在多个集群内的版本情况</p>
<h3 id=同步所有的自定义资源>同步所有的自定义资源</h3>
<p>自定义资源类型和版本会随着 CRD 进行变动，当一个 CRD 被创建时，我们不想同时修改 <code>spec.syncResources</code> 来同步资源，这时我们就可以设置 <code>spec.syncAllCustomResources</code> 来同步所有的自定义资源</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncAllCustomResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>但是需要注意，使用该功能需要在 <code>clustersynchro-manager</code> 中开启相应的 Feature Gate，具体操作可以参考 <a href=../../features/sync-all-custom-resources>同步所有自定义资源</a></p>
<h2 id=使用通配符来同步资源>使用通配符来同步资源</h2>
<h3 id=使用通配符收集指定组下的所有类型资源>使用通配符，收集指定组下的所有类型资源</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;apps&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>通过<code>组通配符</code>可以收集指定的 Group 下的所有类型的资源。</p>
<p>例如上例中，便会同步 <code>apps</code> 下的所有资源</p>
<h3 id=使用通配符收集所有类型的资源>使用通配符，收集所有类型的资源</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>通过<code>全资源通配符</code> 可以同步集群中的内置资源，自定义资源以及聚合式 API 资源。</p>
<p>使用该功能会创建大量的长连接，所以需要谨慎使用，并且在 <code>clustersynchro-manager</code> 中开启相应的 Feature Gate, 具体操作可以参考 <a href=../../features/sync-all-resources>同步所有资源</a></p>
<h2 id=引用-clustersyncresources>引用 ClusterSyncResources</h2>
<p><code>ClusterSyncResources</code> 用于定义多个 PediaCluster 共同引用的集群资源同步配置，关于 <code>ClusterSyncResources</code> 可以查看 <a href=../../concepts/cluster-sync-resources>公共的集群资源同步配置(ClusterSyncResources) </a></p>
<p>PediaCluster 通过 <code>spec.syncResourceRefName</code> 来设置引用的 <code>ClusterSyncResources</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster.clusterpedia.io/v1alpha2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClusterSyncResources</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>global-base</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>pods</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;apps&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster.clusterpedia.io/v1alpha2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PediaCluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>demo1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncResourcesRefName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;global-base&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>pods</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>configmaps</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>如果 <strong>PediaCluster</strong> 同时设置了 <code>spec.syncResourcesRefName</code> 和 <code>spec.syncResources</code>，那么会取两者的并集。</p>
<p>上例中，clusterpedia 会同步 demo1 的 pods 和 confgimaps，以及 apps group 下的所有资源。</p>
<h2 id=查看资源同步状态>查看资源同步状态</h2>
<p>我们可以通过 <code>PediaCluster</code> 资源的 <code>Status</code> 来查看资源的信息，同步的资源版本和状态以及存储版本</p>
<p>在 <code>Status</code> 中，资源会有<strong>同步版本</strong>和<strong>存储版本</strong>：</p>
<ul>
<li><strong>同步版本</strong>是 Clusterpedia 从被同步集群中获取到的资源的版本</li>
<li><strong>存储版本</strong>是 Clusterpedia 存储到存储层中的版本</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>deployments</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>namespaced</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>syncConditions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2022-01-13T04:34:08Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Syncing</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>storageVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>通常集群资源的<strong>同步版本</strong>和<strong>存储版本</strong>是相同的。</p>
<p>但是当接入一个比较老的集群时，集群只提供了 <code>v1beta1</code> 版本的 <code>Deployment</code> 资源，而这时资源的<strong>同步版本</strong>为 <code>v1beta1</code>，<strong>存储版本</strong>为 <code>v1</code></p>
<p>例如，同步 1.10 版本 Kubernetes 的 Deployment 时，同步状态为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>deployments</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>namespaced</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>syncConditions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2022-01-13T04:34:04Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Syncing</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>storageVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>对于自定义资源来说，<strong>同步版本</strong>和<strong>存储版本</strong>是一致的</p>
<h2 id=接下来>接下来</h2>
<p>资源同步完成后，便可以<a href=../access-clusterpedia>访问 Clusterpedia</a>来<a href=../search>检索资源</a></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-bbba5e1deb968130546edf7495679ad0>3.4 - 访问 Clusterpedia</h1>
<p>Clusterpedia 主要有两个组件：</p>
<ul>
<li><code>ClusterSynchroManager</code> 管理 <em>主集群</em> 内的 <code>PediaCluster</code> 资源，通过 <code>PediaCluster</code> 配置认证信息连接到指定集群，并且实时同步相应的资源。</li>
<li><code>APIServer</code> 同样会监听 <em>主集群</em> 内的 <code>PediaCluster</code> 资源，并根据集群同步的资源以<strong>兼容 Kubernetes OpenAPI</strong>的方式来提供对资源的复杂检索。</li>
<li><code>ControllerManager</code></li>
</ul>
<p>并且 <code>Clusterpedia APIServer</code> 会以<a href=https://kubernetes.io/zh/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation>聚合式 API</a> 的方式注册到 <em>主集群</em> 的 APIServer 中，
这样我们通过和主集群相同的入口便可访问 Clusterpedia</p>
<h2 id=resources-和聚合资源conceptscollection-resource>Resources 和<a href=../../concepts/collection-resource>聚合资源</a></h2>
<p>Clusterpedia APIServer 会在 Group —— <em>clusterpedia.io</em> 下提供两种检索资源：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl api-resources <span style=color:#000;font-weight:700>|</span> grep clusterpedia.io
</code></pre></div><pre tabindex=0><code># 输出：
NAME                 SHORTNAMES    APIVERSION                 NAMESPACED   KIND
collectionresources                clusterpedia.io/v1beta1    false        CollectionResource
resources                          clusterpedia.io/v1beta1    false        Resources
</code></pre><ul>
<li><code>Resources</code> 用于指定资源类型的方式来检索，在使用上兼容 Kubernetes OpenAPI</li>
<li><code>CollectionResource</code> 用于检索由多个资源类型聚合而成的新的资源类型，以达到同时检索多种资源的目的</li>
</ul>
<blockquote>
<p>对于 Collection Resource 的概念和使用可以查看 <a href>什么是聚合资源（Collection Resource）</a>，<a href>聚合资源（Collection Resource）检索</a></p>
</blockquote>
<h2 id=访问-clusterpedia-资源>访问 Clusterpedia 资源</h2>
<p>在检索指定类型的资源时，可以按照 <strong>Kubernetes OpenAPI</strong> 的 Get/List 规范来请求，
<strong>这样我们不仅仅可以使用 URL 来访问 Clusterpedia Resources，还可以直接使用 kubectl 或者 client-go 来检索资源。</strong></p>
<p>Clusterpedia 通过 URL Path 来区分请求是多集群资源还是指定集群：</p>
<p><strong>多集群资源路径</strong> 直接以 Resources 资源路径为前缀
<em>/apis/clusterpedia.io/v1beta1/resources</em></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/version&#34;</span>
</code></pre></div><p><strong>指定集群资源路径</strong> 在 Resources 资源路径的基础上设置资源名称来指定集群
<em>/apis/clusterpedia.io/v1beta1/resources/clusters/<cluster name></em></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/clusters/cluster-1/version&#34;</span>
</code></pre></div><p><strong>无论是多集群资源路径还是指定集群的资源路径，都可以在路径后拼接 Kubernetes 的 Get/List Path</strong></p>
<h3 id=为-kubectl-生成集群访问的快捷配置>为 kubectl 生成集群访问的快捷配置</h3>
<p>尽管我们可以使用 URL 来访问 Clusterpedia 资源，但是如果想要更方便的使用 kubectl 来查询的话，就需要配置集群的 kubeconfig cluster 配置。</p>
<p>Clusterpedia 提供了一个简单的脚本来帮助生成 <code>cluster kube config</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -sfL https://raw.githubusercontent.com/clusterpedia-io/clusterpedia/v0.7.0/hack/gen-clusterconfigs.sh <span style=color:#000;font-weight:700>|</span> sh -
</code></pre></div><pre tabindex=0><code># 输出：
Current Context: kubernetes-admin@kubernetes
Current Cluster: kubernetes
        Server: https://10.6.100.10:6443
        TLS Server Name:
        Insecure Skip TLS Verify:
        Certificate Authority:
        Certificate Authority Data: ***

Cluster &quot;clusterpedia&quot; set.
Cluster &quot;cluster-1&quot; set.
Cluster &quot;cluster-2&quot; set.
</code></pre><blockquote>
<p>可以在 <a href=https://github.com/clusterpedia-io/clusterpedia/blob/v0.1.0/hack/gen-clusterconfigs.sh>hack/gen-clusterconfigs.sh</a> 找到该脚本</p>
</blockquote>
<p>脚本会打印当前的集群信息，并将集群中 PediaCluster 配置到 kubeconfig 中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat ~/.kube/config
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># .kube/config</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>certificate-authority-data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeE1Ea3lOREV3TVRNeU5Gb1hEVE14TURreU1qRXdNVE15TkZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTy9TCnZta1U5bk1uUlRIT3lvK3hjdFRJY0lPYnMzc0F5cTI2djRQYkVtb3ZWM2xPOVQwMTF2cE96S0pyOUFxeVZMRnYKVXFBRHBTakM3WXd3MnZwSld3bDEySlBvUm1xZ1FBSFNkYlJpU3BDTDRudjlvR25VOWI2dllWSy9iRitkUVFCSApnQ1h6NnZoTGY4Wmd2N2tUQ2JBdkFPaE9OSlU3MllYTE8zT0lZQjJva1NCRGFVUjNvNnpwZGVWTkt5V0EyNVA3CkRobk8yTk01QzlpRERqTTRLY2FTa3JPSkJvbUlsSHFZRjRwVXdTTlFvcGVGRVRyZ3ZzcTkwSks2YUJVS0t5ajYKK2NGdjI3S0k4K1ZMUEtaSTE2c25Mbng2RXRTazZtZjJXTHdJZlhyQlgwREsvYXBEQ015R2pEb2dCaGpJSVhoVAp2bjVQZndFWUNsdGZFTEhKSkdVQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZJVDhLRHdCbUVvMHladUFEZkhkKzQ1L3ZFYzdNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBT0F5VHQ4S3ZFN0dvREhQT09pdgoyR2I2WWVsUU5KcUMza1dIOXc1NTFNaGZvS3ZiM21VaUV6ZVMwOUNwZUQrTFh5ZnlqQzhZYkJxQjZXSFhNZWMrCnpPdDNPazRYV0FmZVVZTXhOQ1FJblc4cjI4cmZnblErc1NCdHQyeERQN1RZY09oNVZGZkI2K3JtTmFTblZ1NjgKSFFxdlFMNEFXbVhkR09jRWNBRThYdkdiOWhwSjVNckRHdzQ0UTYyOG9YazZ0N01aWTFOMUNQdW9HZ1VmS1N3bgo1MUFWRTFOVVdNV0tEQXhaa2I4bEhvR3VWaDFzWmd3SnJRQjR5clh1cmxGN0Y2bVRlYm4rcDVKM0toT0V4KzlsCjFXdkwwbWkxL1J2bVJKNm11YmtjWUwzN1FJWjI1YXdyaEZMN0Z1ejNRSTFqTTdYMHZET2VUM2VuVUFCZW5SMS8KUnlnPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>server</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://10.6.100.10:6443/apis/clusterpedia.io/v1beta1/resources/clusters/cluster-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>certificate-authority-data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeE1Ea3lOREV3TVRNeU5Gb1hEVE14TURreU1qRXdNVE15TkZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTy9TCnZta1U5bk1uUlRIT3lvK3hjdFRJY0lPYnMzc0F5cTI2djRQYkVtb3ZWM2xPOVQwMTF2cE96S0pyOUFxeVZMRnYKVXFBRHBTakM3WXd3MnZwSld3bDEySlBvUm1xZ1FBSFNkYlJpU3BDTDRudjlvR25VOWI2dllWSy9iRitkUVFCSApnQ1h6NnZoTGY4Wmd2N2tUQ2JBdkFPaE9OSlU3MllYTE8zT0lZQjJva1NCRGFVUjNvNnpwZGVWTkt5V0EyNVA3CkRobk8yTk01QzlpRERqTTRLY2FTa3JPSkJvbUlsSHFZRjRwVXdTTlFvcGVGRVRyZ3ZzcTkwSks2YUJVS0t5ajYKK2NGdjI3S0k4K1ZMUEtaSTE2c25Mbng2RXRTazZtZjJXTHdJZlhyQlgwREsvYXBEQ015R2pEb2dCaGpJSVhoVAp2bjVQZndFWUNsdGZFTEhKSkdVQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZJVDhLRHdCbUVvMHladUFEZkhkKzQ1L3ZFYzdNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBT0F5VHQ4S3ZFN0dvREhQT09pdgoyR2I2WWVsUU5KcUMza1dIOXc1NTFNaGZvS3ZiM21VaUV6ZVMwOUNwZUQrTFh5ZnlqQzhZYkJxQjZXSFhNZWMrCnpPdDNPazRYV0FmZVVZTXhOQ1FJblc4cjI4cmZnblErc1NCdHQyeERQN1RZY09oNVZGZkI2K3JtTmFTblZ1NjgKSFFxdlFMNEFXbVhkR09jRWNBRThYdkdiOWhwSjVNckRHdzQ0UTYyOG9YazZ0N01aWTFOMUNQdW9HZ1VmS1N3bgo1MUFWRTFOVVdNV0tEQXhaa2I4bEhvR3VWaDFzWmd3SnJRQjR5clh1cmxGN0Y2bVRlYm4rcDVKM0toT0V4KzlsCjFXdkwwbWkxL1J2bVJKNm11YmtjWUwzN1FJWjI1YXdyaEZMN0Z1ejNRSTFqTTdYMHZET2VUM2VuVUFCZW5SMS8KUnlnPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>server</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://10.6.100.10:6443/apis/clusterpedia.io/v1beta1/resources/clusters/cluster-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster-2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>certificate-authority-data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeE1Ea3lOREV3TVRNeU5Gb1hEVE14TURreU1qRXdNVE15TkZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTy9TCnZta1U5bk1uUlRIT3lvK3hjdFRJY0lPYnMzc0F5cTI2djRQYkVtb3ZWM2xPOVQwMTF2cE96S0pyOUFxeVZMRnYKVXFBRHBTakM3WXd3MnZwSld3bDEySlBvUm1xZ1FBSFNkYlJpU3BDTDRudjlvR25VOWI2dllWSy9iRitkUVFCSApnQ1h6NnZoTGY4Wmd2N2tUQ2JBdkFPaE9OSlU3MllYTE8zT0lZQjJva1NCRGFVUjNvNnpwZGVWTkt5V0EyNVA3CkRobk8yTk01QzlpRERqTTRLY2FTa3JPSkJvbUlsSHFZRjRwVXdTTlFvcGVGRVRyZ3ZzcTkwSks2YUJVS0t5ajYKK2NGdjI3S0k4K1ZMUEtaSTE2c25Mbng2RXRTazZtZjJXTHdJZlhyQlgwREsvYXBEQ015R2pEb2dCaGpJSVhoVAp2bjVQZndFWUNsdGZFTEhKSkdVQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZJVDhLRHdCbUVvMHladUFEZkhkKzQ1L3ZFYzdNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBT0F5VHQ4S3ZFN0dvREhQT09pdgoyR2I2WWVsUU5KcUMza1dIOXc1NTFNaGZvS3ZiM21VaUV6ZVMwOUNwZUQrTFh5ZnlqQzhZYkJxQjZXSFhNZWMrCnpPdDNPazRYV0FmZVVZTXhOQ1FJblc4cjI4cmZnblErc1NCdHQyeERQN1RZY09oNVZGZkI2K3JtTmFTblZ1NjgKSFFxdlFMNEFXbVhkR09jRWNBRThYdkdiOWhwSjVNckRHdzQ0UTYyOG9YazZ0N01aWTFOMUNQdW9HZ1VmS1N3bgo1MUFWRTFOVVdNV0tEQXhaa2I4bEhvR3VWaDFzWmd3SnJRQjR5clh1cmxGN0Y2bVRlYm4rcDVKM0toT0V4KzlsCjFXdkwwbWkxL1J2bVJKNm11YmtjWUwzN1FJWjI1YXdyaEZMN0Z1ejNRSTFqTTdYMHZET2VUM2VuVUFCZW5SMS8KUnlnPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>server</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://10.6.100.10:6443/apis/clusterpedia.io/v1beta1/resources</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterpedia</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>certificate-authority-data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeE1Ea3lOREV3TVRNeU5Gb1hEVE14TURreU1qRXdNVE15TkZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTy9TCnZta1U5bk1uUlRIT3lvK3hjdFRJY0lPYnMzc0F5cTI2djRQYkVtb3ZWM2xPOVQwMTF2cE96S0pyOUFxeVZMRnYKVXFBRHBTakM3WXd3MnZwSld3bDEySlBvUm1xZ1FBSFNkYlJpU3BDTDRudjlvR25VOWI2dllWSy9iRitkUVFCSApnQ1h6NnZoTGY4Wmd2N2tUQ2JBdkFPaE9OSlU3MllYTE8zT0lZQjJva1NCRGFVUjNvNnpwZGVWTkt5V0EyNVA3CkRobk8yTk01QzlpRERqTTRLY2FTa3JPSkJvbUlsSHFZRjRwVXdTTlFvcGVGRVRyZ3ZzcTkwSks2YUJVS0t5ajYKK2NGdjI3S0k4K1ZMUEtaSTE2c25Mbng2RXRTazZtZjJXTHdJZlhyQlgwREsvYXBEQ015R2pEb2dCaGpJSVhoVAp2bjVQZndFWUNsdGZFTEhKSkdVQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZJVDhLRHdCbUVvMHladUFEZkhkKzQ1L3ZFYzdNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBT0F5VHQ4S3ZFN0dvREhQT09pdgoyR2I2WWVsUU5KcUMza1dIOXc1NTFNaGZvS3ZiM21VaUV6ZVMwOUNwZUQrTFh5ZnlqQzhZYkJxQjZXSFhNZWMrCnpPdDNPazRYV0FmZVVZTXhOQ1FJblc4cjI4cmZnblErc1NCdHQyeERQN1RZY09oNVZGZkI2K3JtTmFTblZ1NjgKSFFxdlFMNEFXbVhkR09jRWNBRThYdkdiOWhwSjVNckRHdzQ0UTYyOG9YazZ0N01aWTFOMUNQdW9HZ1VmS1N3bgo1MUFWRTFOVVdNV0tEQXhaa2I4bEhvR3VWaDFzWmd3SnJRQjR5clh1cmxGN0Y2bVRlYm4rcDVKM0toT0V4KzlsCjFXdkwwbWkxL1J2bVJKNm11YmtjWUwzN1FJWjI1YXdyaEZMN0Z1ejNRSTFqTTdYMHZET2VUM2VuVUFCZW5SMS8KUnlnPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>server</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://10.6.100.10:6443</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubernetes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>脚本生成了用于多集群访问的 <em>clusterpedia</em> cluster 以及其他 <code>PediaCluster</code> Name 命名的 cluster config，
而且在访问 Clusterpedia 时会复用主集群的入口以及认证信息，相比主集群入口只是增加了 Clusterpedia Resources 的 path。</p>
<p>多集群的 kubeconfig 信息生成完成后，就可以使用 <code>kubectl --cluster</code> 来指定集群访问了</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 多集群检索时支持的资源</span>
kubectl --cluster clusterpedia api-resources

<span style=color:#8f5902;font-style:italic># cluster-1 支持检索的资源</span>
kubectl --cluster cluster-1 api-resources
</code></pre></div><h2 id=查看支持检索的资源类型>查看支持检索的资源类型</h2>
<p>我们可以根据 URL 路径来分别获取全局资源信息和指定集群的资源信息。</p>
<p><strong>全局资源信息是所有集群同步的资源类型的并集。</strong></p>
<p>Clusterpedia 开放的 <code>Discovery API</code> 同样<strong>兼容 Kubernetes OpenAPI</strong>，可以使用 <code>kubectl</code>，<a href=https://pkg.go.dev/k8s.io/client-go/discovery#DiscoveryClient>client-go/discovery</a>，<a href=https://pkg.go.dev/k8s.io/client-go/restmapper>client-go/restmapper</a> 或者 <a href=https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/client/apiutil#NewDynamicRESTMapper>controller-runtime/dynamic-restmapper</a> 来访问。</p>
<ul class="nav nav-tabs" id=tabset-zh-cndocsusageaccess-clusterpedia-1 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tabset-zh-cndocsusageaccess-clusterpedia-1-0 role=tab aria-controls=tabset-zh-cndocsusageaccess-clusterpedia-1-0 aria-selected=true>URL</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#tabset-zh-cndocsusageaccess-clusterpedia-1-1 role=tab aria-controls=tabset-zh-cndocsusageaccess-clusterpedia-1-1>kubectl</a></li></ul>
<div class=tab-content id=tabset-zh-cndocsusageaccess-clusterpedia-1><div id=tabset-zh-cndocsusageaccess-clusterpedia-1-0 class="tab-pane show active" role=tabpanel aria-labelledby=tabset-zh-cndocsusageaccess-clusterpedia-1-0>
<p><p><strong>使用 URL 来获取 APIGroupList 以及 APIGroup 信息</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis&#34;</span> <span style=color:#000;font-weight:700>|</span> jq
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;kind&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;APIGroupList&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;apiVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;groups&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;versions&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps/v1&#34;</span><span style=color:#000;font-weight:700>,</span>
          <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1&#34;</span>
        <span style=color:#000;font-weight:700>},</span>
        <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps/v1beta2&#34;</span><span style=color:#000;font-weight:700>,</span>
          <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1beta2&#34;</span>
        <span style=color:#000;font-weight:700>},</span>
        <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps/v1beta1&#34;</span><span style=color:#000;font-weight:700>,</span>
          <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1beta1&#34;</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;preferredVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps/v1&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1&#34;</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cert-manager.io&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;versions&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cert-manager.io/v1&#34;</span><span style=color:#000;font-weight:700>,</span>
          <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1&#34;</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;preferredVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cert-manager.io/v1&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1&#34;</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>]</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis/apps&#34;</span> <span style=color:#000;font-weight:700>|</span> jq
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;kind&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;APIGroup&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;apiVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;versions&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps/v1&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1&#34;</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps/v1beta2&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1beta2&#34;</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps/v1beta1&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1beta1&#34;</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>],</span>
  <span style=color:#204a87;font-weight:700>&#34;preferredVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;groupVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps/v1&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1&#34;</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div></div>
<div id=tabset-zh-cndocsusageaccess-clusterpedia-1-1 class=tab-pane role=tabpanel aria-labelledby=tabset-zh-cndocsusageaccess-clusterpedia-1-1>
<p><p><strong>使用 kubectl 来获取 api-resources</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster clusterpedia api-resources
</code></pre></div><pre tabindex=0><code># 输出：
NAME          SHORTNAMES   APIVERSION           NAMESPACED   KIND
configmaps    cm           v1                   true         ConfigMap
namespaces    ns           v1                   false        Namespace
nodes         no           v1                   false        Node
pods          po           v1                   true         Pod
secrets                    v1                   true         Secret
daemonsets    ds           apps/v1              true         DaemonSet
deployments   deploy       apps/v1              true         Deployment
replicasets   rs           apps/v1              true         ReplicaSet
issuers                    cert-manager.io/v1   true         Issuer
</code></pre></div></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-48ab5663f4f8c240e7bf89c5454f249f>3.5 - 资源检索</h1>
<p>Clusterpedia 支持对 <a href=multi-cluster>多个集群内资源</a>，<a href=specified-cluster>指定集群的资源</a> 以及<a href=collection-resource>聚合资源</a> 的复杂检索，</p>
<p>并且这些复杂检索的条件可以通过两种方式传递给 <code>Clusterpedia APIServer</code>：</p>
<ul>
<li><code>URL Query</code>：直接将查询条件作为 Query 来传递</li>
<li><code>Search Labels</code>：为了<strong>兼容 Kubernetes OpenAPI</strong>，可以将查询条件设置在 Label Selector。</li>
</ul>
<p><strong><code>Search Labels</code> 和 <code>URL Query</code> 都支持与 Label Selector 相同的操作符：</strong></p>
<ul>
<li><code>exist</code>，<code>not exist</code></li>
<li><code>=</code>，<code>==</code>，<code>!=</code></li>
<li><code>in</code>，<code>notin</code></li>
</ul>
<p>除了条件检索，Clusterpedia 还增强了 <a href=#%E5%AD%97%E6%AE%B5%E8%BF%87%E6%BB%A4>Field Selector</a>
，满足我们通过 <code>metadata.annotation</code> 或者 <code>status.*</code> 等字段的过滤需求。</p>
<h2 id=元信息检索>元信息检索</h2>
<blockquote>
<p>支持的操作符：<code>==</code>，<code>=</code>，<code>in</code>。</p>
</blockquote>
<table>
<thead>
<tr>
<th>作用</th>
<th>search label key</th>
<th>url query</th>
</tr>
</thead>
<tbody>
<tr>
<td>过滤集群名称</td>
<td>search.clusterpedia.io/clusters</td>
<td>clusters</td>
</tr>
<tr>
<td>过滤命名空间</td>
<td>search.clusterpedia.io/namespaces</td>
<td>namespaces</td>
</tr>
<tr>
<td>过滤资源名称</td>
<td>search.clusterpedia.io/names</td>
<td>names</td>
</tr>
</tbody>
</table>
<blockquote>
<p>暂时不支持例如 <code>!=</code>，<code>notin</code> 操作符，如果有这些需求或者场景，可以在 issue 中讨论</p>
</blockquote>
<h2 id=模糊搜索>模糊搜索</h2>
<blockquote>
<p>支持的操作符：<code>==</code>，<code>=</code>，<code>in</code>。</p>
</blockquote>
<p>该功能暂时为试验性功能，暂时只提供 search label</p>
<table>
<thead>
<tr>
<th>作用</th>
<th>search label key</th>
<th>url query</th>
</tr>
</thead>
<tbody>
<tr>
<td>模糊搜索资源名称</td>
<td>internalstorage.clusterpedia.io/fuzzy-name</td>
<td>-</td>
</tr>
</tbody>
</table>
<h2 id=创建时间区间检索>创建时间区间检索</h2>
<blockquote>
<p>支持的操作符：<code>==</code>，<code>=</code>。</p>
</blockquote>
<p>基于资源的创建时间区间进行检索，采用的是左闭右开的区间</p>
<table>
<thead>
<tr>
<th>作用</th>
<th>search label key</th>
<th>url query</th>
</tr>
</thead>
<tbody>
<tr>
<td>指定 Since</td>
<td>search.clusterpedia.io/since</td>
<td>since</td>
</tr>
<tr>
<td>指定 Before</td>
<td>search.clusterpedia.io/before</td>
<td>before</td>
</tr>
</tbody>
</table>
<p>创建时间的格式有四种：</p>
<ol>
<li><code>Unix 时间戳格式</code> 为了方便使用会根据时间戳的长度来区分单位为 s 还是 ms。
10 位时间戳单位为秒，13 位时间戳单位为毫秒。</li>
<li><code>RFC3339</code> <em>2006-01-02T15:04:05Z</em> or <em>2006-01-02T15:04:05+08:00</em></li>
<li><code>UTC Date</code> <em>2006-01-02</em></li>
<li><code>UTC Datetime</code> <em>2006-01-02 15:04:05</em></li>
</ol>
<p>由于 kube label selector 的限制，search label 只支持 <code>Unix 时间戳</code>，<code>UTC Date</code>.</p>
<p>使用 url query 的方式可以所有的格式</p>
<h2 id=owner-检索>Owner 检索</h2>
<blockquote>
<p>只支持操作符：<code>==</code>，<code>=</code>。</p>
</blockquote>
<table>
<thead>
<tr>
<th>作用</th>
<th>search label key</th>
<th>url query</th>
</tr>
</thead>
<tbody>
<tr>
<td>指定 Owner UID</td>
<td>search.clusterpedia.io/owner-uid</td>
<td>ownerUID</td>
</tr>
<tr>
<td>指定 Owner Name</td>
<td>search.clusterpedia.io/owner-name</td>
<td>ownerName</td>
</tr>
<tr>
<td>指定 Owner Group Resource</td>
<td>search.clusterpedia.io/owner-gr</td>
<td>ownerGR</td>
</tr>
<tr>
<td>指定 Owner 辈分</td>
<td>internalstorage.clusterpedia.io/owner-seniority</td>
<td>ownerSeniority</td>
</tr>
</tbody>
</table>
<p>需要注意指定 <code>Owner UID</code> 时，<code>Owner Name</code> 和 <code>Owner Group Resource</code> 会被忽略</p>
<p>Owner Group 的格式为 <code>resource.group</code>，例如 <em>deployments.apps</em> 或者 <em>nodes</em></p>
<h2 id=排序>排序</h2>
<blockquote>
<p>只支持操作符：<code>=</code>，<code>==</code>，<code>in</code>。</p>
</blockquote>
<table>
<thead>
<tr>
<th>作用</th>
<th>search label key</th>
<th>url query</th>
</tr>
</thead>
<tbody>
<tr>
<td>多字段排序</td>
<td>search.clusterpedia.io/orderby</td>
<td>orderby</td>
</tr>
</tbody>
</table>
<h2 id=分页>分页</h2>
<blockquote>
<p>只支持操作符 <code>=</code>，<code>==</code>。</p>
</blockquote>
<table>
<thead>
<tr>
<th>作用</th>
<th>search label key</th>
<th>url query</th>
</tr>
</thead>
<tbody>
<tr>
<td>设置分页 size</td>
<td>search.clusterpedia.io/size</td>
<td>limit</td>
</tr>
<tr>
<td>设置分页 offset</td>
<td>search.clusterpedia.io/offset</td>
<td>continue</td>
</tr>
<tr>
<td>要求响应携带 Continue</td>
<td>search.clusterpedia.io/with-continue</td>
<td>withContinue</td>
</tr>
<tr>
<td>要求响应携带资源剩余数量</td>
<td>search.clusterpedia.io/with-remaining-count</td>
<td>withRemainingCount</td>
</tr>
</tbody>
</table>
<blockquote>
<p>在使用 kubectl 操作时，分页 size 只能通过 <code>kubectl --chunk-size</code> 来设置，因为 kubectl 会将 limit 默认设置为 500。</p>
</blockquote>
<h2 id=label-过滤>Label 过滤</h2>
<p>无论使用 kubectl 还是 URL，所有 Key 中不包含 <em>clusterpedia.io</em> 的 Label Selector 都会作为 Label Selector 来过滤资源。</p>
<p>所有行为和原生 Kubernetes 一致。</p>
<table>
<thead>
<tr>
<th>作用</th>
<th>kubectl</th>
<th>url query</th>
</tr>
</thead>
<tbody>
<tr>
<td>Label 过滤</td>
<td><code>kubectl -l</code> or <code>kubectl --label-selector</code></td>
<td>labelSelector</td>
</tr>
</tbody>
</table>
<h2 id=字段过滤>字段过滤</h2>
<p><strong>Clusterpedia 的 Field Selector 在操作符上与 Label Selector 保持一致，同样支持：</strong></p>
<p><strong><code>exist</code>，<code>not exist</code>，<code>==</code>，<code>=</code>，<code>!=</code>，<code>in</code>，<code>notin</code>。</strong></p>
<p>无论是 URL 还是 kubectl 上的命令参数都原生 Field Selector 一致</p>
<table>
<thead>
<tr>
<th>作用</th>
<th>kubectl</th>
<th>url query</th>
</tr>
</thead>
<tbody>
<tr>
<td>字段过滤</td>
<td><code>kubectl --field-selector</code></td>
<td><code>fieldSelector</code></td>
</tr>
</tbody>
</table>
<p>详细可以查看：</p>
<ul>
<li><a href=./multi-cluster#%E5%AD%97%E6%AE%B5%E8%BF%87%E6%BB%A4>使用字段过滤来检索资源</a></li>
<li><a href=https://github.com/clusterpedia-io/clusterpedia/pull/36>support field selector</a></li>
<li><a href=https://github.com/clusterpedia-io/clusterpedia/issues/48>issue: support list field filtering</a></li>
</ul>
<h2 id=高级检索自定义条件检索>高级检索(自定义条件检索)</h2>
<p>自定义检索为 <code>默认存储层</code> 提供的功能，目的是为了满足用户更加灵活多变的检索需求</p>
<table>
<thead>
<tr>
<th>作用</th>
<th>search label key</th>
<th>url query</th>
</tr>
</thead>
<tbody>
<tr>
<td>自定义检索语句</td>
<td>-</td>
<td>whereSQL</td>
</tr>
</tbody>
</table>
<p>自定义检索并不支持通过 search lable，只能使用 url query 来传递自定义搜素的语句。</p>
<p>另外该功能暂时还是处于 alpha 阶段，需要用户在 <code>clusterpedia apiserver</code> 中开启相应的 Feature Gate，详细可以参考 <a href=../../features/raw-sql-query>自定义条件检索</a></p>
<h2 id=collectionresource-url-query>CollectionResource URL Query</h2>
<p>以下 URL Query 专属于 Collection Resource。</p>
<table>
<thead>
<tr>
<th>作用</th>
<th>url query</th>
<th>example</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href=collection-resource#only-metadata>只获取资源的 metadata</a></td>
<td><code>onlyMetadata</code></td>
<td><em>onlyMetadata=true</em></td>
</tr>
<tr>
<td><a href=collection-resource#any-collectionresource>指定 any collectionresource 的 groups</a></td>
<td><code>groups</code></td>
<td><em>groups=apps,cert-manager.io/v1</em></td>
</tr>
<tr>
<td><a href=collection-resource#any-collectionresource>指定 any collectionresource 的 resources</a></td>
<td><code>resources</code></td>
<td><em>resources=apps/deployments,batch/v1/cronjobs</em></td>
</tr>
</tbody>
</table>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-ec8e2360424d04fb82dc27fbc4824983>3.5.1 - 多集群检索</h1>
<p>多集群资源检索可以满足我们<strong>根据查询条件一次过滤多个集群内的资源，并提供对这些资源的分页排序的能力</strong></p>
<p>在使用 kubectl 操作时，可以查看一下当前可以检索哪些资源</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster clusterpedia api-resources
</code></pre></div><pre tabindex=0><code># 输出：
NAME          SHORTNAMES   APIVERSION           NAMESPACED   KIND
configmaps    cm           v1                   true         ConfigMap
namespaces    ns           v1                   false        Namespace
nodes         no           v1                   false        Node
pods          po           v1                   true         Pod
secrets                    v1                   true         Secret
daemonsets    ds           apps/v1              true         DaemonSet
deployments   deploy       apps/v1              true         Deployment
replicasets   rs           apps/v1              true         ReplicaSet
issuers                    cert-manager.io/v1   true         Issuer
</code></pre><p>Clusterpedia 根据所有集群同步的资源来提供多集群的资源检索，可以查看 <a href=../../sync-resources>同步集群资源</a> 来更新需要同步的资源</p>
<h2 id=基本功能>基本功能</h2>
<h3 id=指定集群>指定集群</h3>
<p>多集群检索时，会默认检索所有的集群，我们也可以指定单个或者一组集群</p>
<ul class="nav nav-tabs" id=tabset-zh-cndocsusagesearchmulti-cluster-1 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tabset-zh-cndocsusagesearchmulti-cluster-1-0 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-1-0 aria-selected=true>kubectl</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#tabset-zh-cndocsusagesearchmulti-cluster-1-1 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-1-1>URL</a></li></ul>
<div class=tab-content id=tabset-zh-cndocsusagesearchmulti-cluster-1><div id=tabset-zh-cndocsusagesearchmulti-cluster-1-0 class="tab-pane show active" role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-1-0>
<p><p>使用 <a href=../#%E5%85%83%E4%BF%A1%E6%81%AF%E6%A3%80%E7%B4%A2>Search Label</a> <code>search.clusterpedia.io/clusters</code> 来指定一组集群</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster clusterpedia get deployments -l <span style=color:#4e9a06>&#34;search.clusterpedia.io/clusters in (cluster-1,cluster-2)&#34;</span>
</code></pre></div><pre tabindex=0><code># 输出：
NAMESPACE     CLUSTER     NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
kube-system   cluster-1   coredns                   2/2     2            2           68d
kube-system   cluster-2   coredns                   2/2     2            2           64d
</code></pre><p>对于指定单个集群的检索，同样可以使用 Search Label 来设置，也可以查看 <a href=../specified-cluster>指定集群检索</a> 来使用 URL Path 的方式指定集群</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 指定单个集群</span>
kubectl --cluster clusterpedia get deployments -l <span style=color:#4e9a06>&#34;search.clusterpedia.io/clusters=cluster-1&#34;</span>

<span style=color:#8f5902;font-style:italic># 指定集群也可以使用 --cluster &lt;cluster name&gt; 来指定</span>
kubectl --cluster cluster-1 get deployments
</code></pre></div></div>
<div id=tabset-zh-cndocsusagesearchmulti-cluster-1-1 class=tab-pane role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-1-1>
<p><p>使用 URL 时，使用 <code>clusters</code> 作为 <a href=../#%E5%85%83%E4%BF%A1%E6%81%AF%E6%A3%80%E7%B4%A2>URL Query</a> 来传递</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis/apps/v1/deployments?clusters=cluster-1&#34;</span>
</code></pre></div><p>如果指定单个集群，也可以将 cluster name 放到 URL 路径中</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/clusters/cluster-1/apis/apps/v1/deployments&#34;</span>
</code></pre></div><p>了解更多<a href=../specified-cluster>指定集群检索</a></p>
</div></div>
<h3 id=指定命名空间>指定命名空间</h3>
<p>可以像查看原生 Kube 一样来<strong>指定单个命名空间或者所有命名空间</strong></p>
<ul class="nav nav-tabs" id=tabset-zh-cndocsusagesearchmulti-cluster-2 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tabset-zh-cndocsusagesearchmulti-cluster-2-0 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-2-0 aria-selected=true>kubectl</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#tabset-zh-cndocsusagesearchmulti-cluster-2-1 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-2-1>URL</a></li></ul>
<div class=tab-content id=tabset-zh-cndocsusagesearchmulti-cluster-2><div id=tabset-zh-cndocsusagesearchmulti-cluster-2-0 class="tab-pane show active" role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-2-0>
<p><p>使用 <code>-n &lt;namespace></code> 来指定命名空间，默认在 <em>default</em> 命名空间</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster clusterpedia get deployments -n kube-system
</code></pre></div><pre tabindex=0><code># 输出：
CLUSTER     NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
cluster-1   coredns                   2/2     2            2           68d
cluster-2   calico-kube-controllers   1/1     1            1           64d
cluster-2   coredns                   2/2     2            2           64d
</code></pre><p>使用 <code>-A</code> 或者 <code>--all-namespaces</code> 来查看所有集群的所有命名空间下的资源</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster clusterpedia get deployments -A
</code></pre></div><pre tabindex=0><code># 输出：
NAMESPACE     CLUSTER     NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
kube-system   cluster-1   coredns                   2/2     2            2           68d
kube-system   cluster-2   calico-kube-controllers   1/1     1            1           64d
kube-system   cluster-2   coredns                   2/2     2            2           64d
default       cluster-2   dd-airflow-scheduler      0/1     1            0           54d
default       cluster-2   dd-airflow-web            0/1     1            0           54d
</code></pre></div>
<div id=tabset-zh-cndocsusagesearchmulti-cluster-2-1 class=tab-pane role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-2-1>
<p><p>获取资源的 <strong>URL Path</strong> 和原生 Kubernetes 一样 <em>/apis/apps/v1/deployments</em>，</p>
<p>只是需要加上 Clusterpedia Resources 的路径前缀 <em>/apis/clusterpedia.io/v1beta1/resources</em> 来表示当前是 Clusterpedia 请求。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis/apps/v1/deployments&#34;</span>

<span style=color:#8f5902;font-style:italic># 指定命名空间</span>
kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis/apps/v1/namespaces/kube-system/deployments&#34;</span>
</code></pre></div></div></div>
<hr>
<p>除了指定单个命名空间，还可以<strong>指定查看一组命名空间下的资源</strong>
<ul class="nav nav-tabs" id=tabset-zh-cndocsusagesearchmulti-cluster-3 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tabset-zh-cndocsusagesearchmulti-cluster-3-0 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-3-0 aria-selected=true>kubectl</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#tabset-zh-cndocsusagesearchmulti-cluster-3-1 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-3-1>URL</a></li></ul>
<div class=tab-content id=tabset-zh-cndocsusagesearchmulti-cluster-3><div id=tabset-zh-cndocsusagesearchmulti-cluster-3-0 class="tab-pane show active" role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-3-0>
<p><p>使用 <a href=../#%E5%85%83%E4%BF%A1%E6%81%AF%E6%A3%80%E7%B4%A2>Search Label</a> <code>search.clusterpedia.io/namespaces</code> 来指定一组命名空间</p>
<blockquote>
<p>一定要指定 -A 参数，避免 kubectl 在路径中设置 default namespace</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster clusterpedia get deployments -A -l <span style=color:#4e9a06>&#34;search.clusterpedia.io/namespaces in (kube-system, default)&#34;</span>
</code></pre></div><pre tabindex=0><code># 输出：
NAMESPACE     CLUSTER     NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
kube-system   cluster-1   coredns                   2/2     2            2           68d
kube-system   cluster-2   calico-kube-controllers   1/1     1            1           64d
kube-system   cluster-2   coredns                   2/2     2            2           64d
default       cluster-2   dd-airflow-scheduler      0/1     1            0           54d
default       cluster-2   dd-airflow-web            0/1     1            0           54d
</code></pre></div>
<div id=tabset-zh-cndocsusagesearchmulti-cluster-3-1 class=tab-pane role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-3-1>
<p><p>使用 URL 时，就不需要使用 Label Selector 来传递参数了，直接使用 URL Query <code>namespaces</code> 即可</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis/apps/v1/deployments?namespaces=kube-system,default&#34;</span>
</code></pre></div></div></div>
</p>
<h3 id=指定资源名称>指定资源名称</h3>
<p>用户可以通过一组资源名称来过滤资源</p>
<ul class="nav nav-tabs" id=tabset-zh-cndocsusagesearchmulti-cluster-4 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tabset-zh-cndocsusagesearchmulti-cluster-4-0 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-4-0 aria-selected=true>kubectl</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#tabset-zh-cndocsusagesearchmulti-cluster-4-1 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-4-1>URL</a></li></ul>
<div class=tab-content id=tabset-zh-cndocsusagesearchmulti-cluster-4><div id=tabset-zh-cndocsusagesearchmulti-cluster-4-0 class="tab-pane show active" role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-4-0>
<p><p>使用 Search Label <code>search.clusterpedia.io/names</code> 来指定一组资源名称
<strong>注意：如果在所有命名空间下检索资源，需要指定 -A 参数，或者使用 -n 来指定命名空间</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster clusterpedia get deployments -A -l <span style=color:#4e9a06>&#34;search.clusterpedia.io/names=coredns&#34;</span>
</code></pre></div><pre tabindex=0><code># 输出：
NAMESPACE     CLUSTER     NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
kube-system   cluster-1   coredns                   2/2     2            2           68d
kube-system   cluster-2   coredns                   2/2     2            2           64d
</code></pre></div>
<div id=tabset-zh-cndocsusagesearchmulti-cluster-4-1 class=tab-pane role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-4-1>
<p><p>使用 URL 时，使用 <code>names</code> 作为 URL Query 来传递，如果需要指定命名空间，那么就在路径中加上 namespace。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis/apps/v1/deployments?names=kube-coredns,dd-airflow-web&#34;</span>

<span style=color:#8f5902;font-style:italic># 在 default 命名空间下检索指定名字的资源</span>
kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis/apps/v1/namespaces/default/deployments?names=kube-coredns,dd-airflow-web&#34;</span>
</code></pre></div><p>在多集群检索时，返回的数据实际是以类似 <code>DeploymentList</code> 的结构封装的数据。</p>
<p>如果我们想要获取到单个的 <code>Deployment</code> 那么就需要在 URL 路径中指定 cluster name，参考<a href=../specified-cluster#%E8%8E%B7%E5%8F%96%E5%8D%95%E4%B8%AA%E8%B5%84%E6%BA%90>获取单个资源</a></p>
</div></div>
<h3 id=创建时间的区间>创建时间的区间</h3>
<p>创建时间的区间以左闭右开的方式来进行检索，<strong>since &lt;= creation time &lt; before</strong></p>
<p>关于详细的时间区间参数可以查看 <a href=../#%E5%88%9B%E5%BB%BA%E6%97%B6%E9%97%B4%E5%8C%BA%E9%97%B4%E6%A3%80%E7%B4%A2>创建时间区间检索</a></p>
<ul class="nav nav-tabs" id=tabset-zh-cndocsusagesearchmulti-cluster-5 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tabset-zh-cndocsusagesearchmulti-cluster-5-0 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-5-0 aria-selected=true>kubectl</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#tabset-zh-cndocsusagesearchmulti-cluster-5-1 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-5-1>URL</a></li></ul>
<div class=tab-content id=tabset-zh-cndocsusagesearchmulti-cluster-5><div id=tabset-zh-cndocsusagesearchmulti-cluster-5-0 class="tab-pane show active" role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-5-0>
<p><p>使用 Search Label <code>search.clusterpedia.io/since</code> 和 <code>search.clusterpedia.io/before</code> 来指定时间区间</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster clusterpedia get deployments -A -l <span style=color:#4e9a06>&#34;search.clusterpedia.io/since=2022-03-24, \
</span><span style=color:#4e9a06>    search.clusterpedia.io/before=2022-04-10&#34;</span>
</code></pre></div></div>
<div id=tabset-zh-cndocsusagesearchmulti-cluster-5-1 class=tab-pane role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-5-1>
<p><p>直接使用 URL 时，可以 Query <code>since</code> 和 <code>before</code> 来分别指定时间的区间</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis/apps/v1/deployments?since=2022-03-24&amp;before=2022-04-10&#34;</span>
</code></pre></div></div></div>
<h2 id=模糊搜索>模糊搜索</h2>
<p>当前支持根据资源名称进行模糊搜索，由于模糊搜索还需要继续讨论，所以暂时以试验性功能来提供</p>
<p>只支持 Search Label 的方式，不支持 URL Query</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster clusterpedia get deployments -A -l <span style=color:#4e9a06>&#34;internalstorage.clusterpedia.io/fuzzy-name=test&#34;</span>
</code></pre></div><p>过滤出名字中包含 <em>test</em> 字符串的 deployments。</p>
<p>可以使用 <code>in</code> 操作符来传递多个参数，这样可以过滤出名字中包含所有字符串的资源</p>
<h2 id=字段过滤>字段过滤</h2>
<p>原生 Kubernetes 当前只支持对 <code>metadata.name</code> 和 <code>metadata.namespace</code> 的字段过滤，而且操作符只支持 <code>=</code>，<code>!=</code>，<code>==</code>，能力非常有限。</p>
<p><strong>Clusterpedia 在兼容已有的 Field Selector 功能的基础上，提供了更加强大的功能，支持和 <code>Label Selector</code> 相同的操作符。</strong></p>
<p>Field Selector 的 key 当前支持三种格式：</p>
<ul>
<li><strong>使用 <code>.</code> 分隔字段</strong></li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster clusterpedia get pods --field-selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;status.phase=Running&#34;</span>

<span style=color:#8f5902;font-style:italic># 也可以在首字符添加 `.`</span>
kubectl --cluster clusterpedia get pods --field-selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;.status.phase notin (Running,Succeeded)&#34;</span>
</code></pre></div><ul>
<li><strong>字段名称使用 <code>''</code> 或者 <code>""</code> 来包裹</strong>，可以用于带 <code>.</code> 之类的非法字符的字段</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster clusterpedia get deploy <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --field-selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;metadata.annotations[&#39;test.io&#39;] in (value1,value2),spec.replica=3&#34;</span>
</code></pre></div><ul>
<li><strong>使用 <code>[]</code> 来分隔字段</strong>，<code>[]</code> 内字符串必须使用 <code>''</code> 或者 <code>""</code> 来包裹</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster clusterpedia get pods --field-selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;status[&#39;phase&#39;]!=Running&#34;</span>
</code></pre></div><h3 id=列表字段支持>列表字段支持</h3>
<p>实际在字段过滤的设计时考虑到了对<code>列表元素</code>内字段过滤，不过由于使用场景是否真正有意义还需要更多的讨论 <a href=https://github.com/clusterpedia-io/clusterpedia/issues/48>issue: support list field filtering</a></p>
<p>示例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get po --field-selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;spec.containers[].name!=container1&#34;</span>

kubectl get po --field-selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;spec.containers[].name == container1&#34;</span>

kubectl get po --field-selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;spec.containers[1].name in (container1,container2)&#34;</span>
</code></pre></div><h2 id=根据父辈以及祖辈-owner-查询>根据父辈以及祖辈 Owner 查询</h2>
<p>通过 Owner 检索是一个非常有用的检索功能，
并且 Clusterpedia 在 Owner 的基础上还支持<strong>对 Owner 进行辈分提升来进行祖辈甚至更高辈分的检索</strong>。</p>
<p>通过 Owner 检索，可以一次查询到 <code>Deployment</code> 下的所有 <code>Pods</code>，无需中间再查询 <code>ReplicaSet</code>。</p>
<p><strong>Owner 查询必须指定单个集群，可以使用 <a href=../#owner-%E6%A3%80%E7%B4%A2>Serach Label</a> 或者 <a href=../#owner-%E6%A3%80%E7%B4%A2>URL Query</a> 来指定，也可以在 URL Path 中指定集群名称</strong></p>
<p>关于<strong>根据 Owner 检索</strong>的具体使用方法，可以参考<a href=../specified-cluster#%E6%A0%B9%E6%8D%AE%E7%88%B6%E8%BE%88%E6%88%96%E8%80%85%E7%A5%96%E8%BE%88-owner-%E8%BF%9B%E8%A1%8C%E6%A3%80%E7%B4%A2>指定集群内根据父辈或者祖辈 Owenr 进行检索</a></p>
<h2 id=分页与排序>分页与排序</h2>
<p>分页和排序是资源检索必不可少的功能</p>
<h3 id=根据多个字段进行排序>根据多个字段进行排序</h3>
<p>可以指定多个字段进行排序，而对排序字段的支持是由存储层来决定。</p>
<p>当前默认存储层支持对 <code>cluster</code>，<code>namespace</code>，<code>name</code>，<code>created_at</code>，<code>resource_version</code> 进行正序和倒序的排序，字段也支持随意的组合
<ul class="nav nav-tabs" id=tabset-zh-cndocsusagesearchmulti-cluster-6 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tabset-zh-cndocsusagesearchmulti-cluster-6-0 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-6-0 aria-selected=true>kubectl</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#tabset-zh-cndocsusagesearchmulti-cluster-6-1 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-6-1>URL</a></li></ul>
<div class=tab-content id=tabset-zh-cndocsusagesearchmulti-cluster-6><div id=tabset-zh-cndocsusagesearchmulti-cluster-6-0 class="tab-pane show active" role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-6-0>
<p><p>使用多个字段进行正序排序</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster clusterpedia get pods -l <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    <span style=color:#4e9a06>&#34;search.clusterpedia.io/orderby in (cluster, name)&#34;</span>
</code></pre></div><p>由于 Label Selector 对 value 的限制，倒序时需要在字段结尾加上 <code>_desc</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster clusterpedia get pods -l <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    <span style=color:#4e9a06>&#34;search.clusterpedia.io/orderby in (namespace_desc, cluster, name)&#34;</span>
</code></pre></div></div>
<div id=tabset-zh-cndocsusagesearchmulti-cluster-6-1 class=tab-pane role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-6-1>
<p><p>使用 <a href=../#%E6%8E%92%E5%BA%8F>URL Query</a> 来指定排序字段</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis/apps/v1/deployments?orderby=namespace,cluster&#34;</span>
</code></pre></div><p>指定倒序字段时，在字段后添加 desc，以空格分隔</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis/apps/v1/deployments?orderby=namespace desc,cluster&#34;</span>
</code></pre></div></div></div>
</p>
<h3 id=分页>分页</h3>
<p>原生 Kubernetes 实际是支持分页的，<a href=https://pkg.go.dev/k8s.io/apimachinery/pkg/apis/meta/v1#ListOptions>ListOptions</a> 中便已经存在用于分页查询的字段。</p>
<p>Clusterpedia 复用 <code>ListOptions.Limit</code> 和 <code>ListOptions.Continue</code> 字段作为分页的 <code>size</code> 和 <code>offset</code>。</p>
<ul class="nav nav-tabs" id=tabset-zh-cndocsusagesearchmulti-cluster-7 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tabset-zh-cndocsusagesearchmulti-cluster-7-0 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-7-0 aria-selected=true>kubectl</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#tabset-zh-cndocsusagesearchmulti-cluster-7-1 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-7-1>URL</a></li></ul>
<div class=tab-content id=tabset-zh-cndocsusagesearchmulti-cluster-7><div id=tabset-zh-cndocsusagesearchmulti-cluster-7-0 class="tab-pane show active" role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-7-0>
<p><p>kubectl 的 <code>--chunk-size</code> 实际通过设置 <code>limit</code> 来用于分片拉取。</p>
<p>原生的 Kubernetes APIServer 会在返回的响应中携带用于下一次拉取的 <code>continue</code>，
并根据 <code>--chunk-size</code> 和 <code>conintue</code> 进行下一次拉取，直到相应的数据中 Conintue 为空。</p>
<p>Clusterpedia 为了保证在 kubectl 中实现分页检索，默认并不会在响应中返回 <code>continue</code> 字段，这样避免了 kubectl 使用分片拉取全部数据</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster cluster-1 get pods --chunk-size <span style=color:#0000cf;font-weight:700>10</span>
</code></pre></div><p>需要注意 kubectl 在不设置 <code>--chunk-size</code> 的情况下，<code>limit</code> 会被设置成默认值 <code>500</code>，
也就是说 <code>search.clusterpedia.io/size</code> 实际是无法生效的，只是用于和 <code>search.clusterpedia.io/offset</code> 形成对应关系</p>
<blockquote>
<p>URL Query 的优先级大于 Search Label</p>
</blockquote>
<p>在 kubectl 中 continue 是没有 flag 可以设置的。所以还是要使用 <a href=../#%E5%88%86%E9%A1%B5>Search Label</a> 来传递。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster clusterpedia get pods --chunk-size <span style=color:#0000cf;font-weight:700>10</span> -l <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    <span style=color:#4e9a06>&#34;search.clusterpedia.io/offset=10&#34;</span>
</code></pre></div></div>
<div id=tabset-zh-cndocsusagesearchmulti-cluster-7-1 class=tab-pane role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-7-1>
<p><p>对资源进行分页检索，只需要在 URL 中设置 <code>limit</code> 和 <code>continue</code> 即可</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis/apps/v1/deployments?limit=10&amp;continue=5&#34;</span>
</code></pre></div></div></div>
<h3 id=响应携带-continue-信息>响应携带 Continue 信息</h3>
<p>响应数据的 <a href=https://pkg.go.dev/k8s.io/apimachinery/pkg/apis/meta/v1#ListMeta>ListMeta.Continue</a> 可以用于 <a href=https://pkg.go.dev/k8s.io/apimachinery/pkg/apis/meta/v1#ListOptions>ListOptions.Continue</a> 中作为下一次拉取的 offset</p>
<p>分页功能中我们提到，为了避免 kubectl 进行对全量数据的分片拉取，Clusterepdia 不会在响应中携带 Continue 信息。</p>
<p>不过如果用户有需求那么可以要求响应中携带 Continue 信息
<ul class="nav nav-tabs" id=tabset-zh-cndocsusagesearchmulti-cluster-8 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tabset-zh-cndocsusagesearchmulti-cluster-8-0 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-8-0 aria-selected=true>URL</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#tabset-zh-cndocsusagesearchmulti-cluster-8-1 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-8-1>kubectl</a></li></ul>
<div class=tab-content id=tabset-zh-cndocsusagesearchmulti-cluster-8><div id=tabset-zh-cndocsusagesearchmulti-cluster-8-0 class="tab-pane show active" role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-8-0>
<p><p>在使用 URL 访问 Clusterepdia 时，响应的 Continue 可以作为下一次请求的 offset</p>
<blockquote>
<p>搭配分页功能使用</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis/apps/v1/deployments?withContinue=true&amp;limit=1&#34;</span> <span style=color:#000;font-weight:700>|</span> jq
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;kind&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;DeploymentList&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;apiVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps/v1&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;metadata&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;continue&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;1&#34;</span>
  <span style=color:#000;font-weight:700>},</span>
  <span style=color:#204a87;font-weight:700>&#34;items&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#a40000>...</span>
  <span style=color:#000;font-weight:700>]</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div></div>
<div id=tabset-zh-cndocsusagesearchmulti-cluster-8-1 class=tab-pane role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-8-1>
<p><p><strong>在 kubectl 设置 <code>search.clusterpedia.io/with-continue</code> 会导致以分片拉取的形式拉取全量资源。</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster clusterpedia get deploy -l <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    <span style=color:#4e9a06>&#34;search.clusterpedia.io/with-continue=true&#34;</span>
</code></pre></div></div></div>
</p>
<h3 id=响应携带剩余资源数量信息>响应携带剩余资源数量信息</h3>
<p><strong>在一些 UI 场景下，往往会需要获取到当前检索条件下的资源总量。</strong></p>
<p>Kubernetes List 响应的 <a href=https://pkg.go.dev/k8s.io/apimachinery/pkg/apis/meta/v1#ListMeta>ListMeta</a> 中存在 <code>RemainingItemCount</code> 字段，</p>
<p>通过复用该字段，便可在兼容 Kubernetes OpenAPI 的基础下计算出资源总量：</p>
<p><strong><code>offset + len(list.items) + list.metadata.remainingItemCount</code></strong></p>
<blockquote>
<p>在 offset 过大时，<code>remainingItemCount</code> 可能为负数，保证总是可以计算出资源总量</p>
</blockquote>
<ul class="nav nav-tabs" id=tabset-zh-cndocsusagesearchmulti-cluster-9 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tabset-zh-cndocsusagesearchmulti-cluster-9-0 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-9-0 aria-selected=true>URL</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#tabset-zh-cndocsusagesearchmulti-cluster-9-1 role=tab aria-controls=tabset-zh-cndocsusagesearchmulti-cluster-9-1>kubectl</a></li></ul>
<div class=tab-content id=tabset-zh-cndocsusagesearchmulti-cluster-9><div id=tabset-zh-cndocsusagesearchmulti-cluster-9-0 class="tab-pane show active" role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-9-0>
<p><p>在 <a href=../#%E5%88%86%E9%A1%B5>URL Query</a> 设置 <code>withRemainingCount</code> 即可要求响应携带剩余资源数量</p>
<blockquote>
<p>搭配<a href=#%E5%88%86%E9%A1%B5>分页</a>功能使用</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis/apps/v1/deployments?withRemainingCount&amp;limit=1&#34;</span> <span style=color:#000;font-weight:700>|</span> jq
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;kind&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;DeploymentList&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;apiVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps/v1&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;metadata&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;remainingItemCount&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>23</span>
  <span style=color:#000;font-weight:700>},</span>
  <span style=color:#204a87;font-weight:700>&#34;items&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#a40000>...</span>
  <span style=color:#000;font-weight:700>]</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div></div>
<div id=tabset-zh-cndocsusagesearchmulti-cluster-9-1 class=tab-pane role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchmulti-cluster-9-1>
<p><p>需要以 URL 的方式使用该功能</p>
</div></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d30ab8cb55be590100ae14cd7d8c1d47>3.5.2 - 指定集群检索</h1>
<p>Clusterpedia 除了支持多个集群的混合检索，还可以指定集群来检索资源。</p>
<blockquote>
<p>在性能上使用 <a href=../#%E5%85%83%E4%BF%A1%E6%81%AF%E6%A3%80%E7%B4%A2>Search Label</a> 或者 <a href=../#%E5%85%83%E4%BF%A1%E6%81%AF%E6%A3%80%E7%B4%A2>URL Query</a> 来指定单个集群和在 URL Path 中指定集群并无区别</p>
<p>本文主要讲述在 URL Path 中指定集群</p>
</blockquote>
<p>在以指定集群的方式使用 kubectl 前，需要先<a href=../../access-clusterpedia#%E4%B8%BA-kubectl-%E7%94%9F%E6%88%90%E9%9B%86%E7%BE%A4%E8%AE%BF%E9%97%AE%E7%9A%84%E5%BF%AB%E6%8D%B7%E9%85%8D%E7%BD%AE>配置 kubectl 的集群快捷方式</a></p>
<ul class="nav nav-tabs" id=tabset-zh-cndocsusagesearchspecified-cluster-1 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tabset-zh-cndocsusagesearchspecified-cluster-1-0 role=tab aria-controls=tabset-zh-cndocsusagesearchspecified-cluster-1-0 aria-selected=true>kubectl</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#tabset-zh-cndocsusagesearchspecified-cluster-1-1 role=tab aria-controls=tabset-zh-cndocsusagesearchspecified-cluster-1-1>URL</a></li></ul>
<div class=tab-content id=tabset-zh-cndocsusagesearchspecified-cluster-1><div id=tabset-zh-cndocsusagesearchspecified-cluster-1-0 class="tab-pane show active" role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchspecified-cluster-1-0>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster cluster-1 get deployments -n kube-system
</code></pre></div><pre tabindex=0><code># 输出：
NAMESPACE     CLUSTER     NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
kube-system   cluster-1   coredns                   2/2     2            2           68d
</code></pre></div>
<div id=tabset-zh-cndocsusagesearchspecified-cluster-1-1 class=tab-pane role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchspecified-cluster-1-1>
<p><p>将 cluster name 放到 URL 路径中来指定集群</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/clusters/cluster-1/apis/apps/v1/deployments&#34;</span>
</code></pre></div><p>也可以通过 <code>URL Query</code> 来指定单个集群</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis/apps/v1/deployments?clusters=cluster-1&#34;</span>
</code></pre></div></div></div>
<p>指定集群支持的功能和<a href=../multi-cluster>多集群检索</a>的作用基本相同，而且在 Owner 检索上更加方便，
另外在<strong>获取单个资源时也只能使用在 URL Path 中指定集群的方式</strong>。</p>
<h2 id=根据父辈或者祖辈-owner-进行检索>根据父辈或者祖辈 Owner 进行检索</h2>
<p>Owner 查询必须指定单个集群，可以使用 <a href=../#%E5%85%83%E4%BF%A1%E6%81%AF%E6%A3%80%E7%B4%A2>Search Label</a> 或者 <a href=../#%E5%85%83%E4%BF%A1%E6%81%AF%E6%A3%80%E7%B4%A2>URL Query</a> 来指定，也可以在 URL Path 中指定集群名称</p>
<p><strong>通过 <code>Owenr UID</code> 或者 <code>Owner Name</code>, 并且配合用于 Owner 辈分提升的 <code>Owenr Senirority</code> 可以完成基于祖辈 Owner 的资源检索。</strong></p>
<blockquote>
<p>关于具体的查询参数，可以参考 <a href=../#owner-%E6%A3%80%E7%B4%A2>Owner 检索</a></p>
</blockquote>
<p>通过这种方式，可以直接查询到 Deployment 相应的 Pods，无需查询有哪些 <code>ReplicaSet</code> 属于该 <code>Deployment</code>。</p>
<h3 id=指定-owner--的-uid>指定 Owner 的 UID</h3>
<p><strong>在指定 <code>Owenr UID</code> 后，<code>Owner Name</code> 和 <code>Owenr Group Resource</code> 会被忽略</strong></p>
<p>首先使用 kubectl 获取 <code>Deployment</code> 的 UID</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster cluster-1 get deploy fake-deploy -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;{.metadata.uid}&#34;</span>
</code></pre></div><pre tabindex=0><code>#输出：
151ae265-28fe-4734-850e-b641266cd5da
</code></pre><blockquote>
<p>在 kubectl 下获取 uid 可能比较麻烦，但是在 UI 场景中通常已经更容易查看 <code>metadata.uid</code></p>
</blockquote>
<ul class="nav nav-tabs" id=tabset-zh-cndocsusagesearchspecified-cluster-2 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tabset-zh-cndocsusagesearchspecified-cluster-2-0 role=tab aria-controls=tabset-zh-cndocsusagesearchspecified-cluster-2-0 aria-selected=true>kubectl</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#tabset-zh-cndocsusagesearchspecified-cluster-2-1 role=tab aria-controls=tabset-zh-cndocsusagesearchspecified-cluster-2-1>URL</a></li></ul>
<div class=tab-content id=tabset-zh-cndocsusagesearchspecified-cluster-2><div id=tabset-zh-cndocsusagesearchspecified-cluster-2-0 class="tab-pane show active" role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchspecified-cluster-2-0>
<p><p>使用 <code>owner-uid</code> 来指定 Owner 的 UID, <code>owner-seniority</code> 对 Owner 进行辈分提升。</p>
<blockquote>
<p><em><code>owner-seniority</code> 默认为 0，表示 Owner 为父辈。设置为 1，提升 Owenr 辈分成为祖父 Owenr</em></p>
</blockquote>
<pre tabindex=0><code>kubectl --cluster cluster-1 get pods -l \
    &quot;search.clusterpedia.io/owner-uid=151ae265-28fe-4734-850e-b641266cd5da,\
     search.clusterpedia.io/owner-seniority=1&quot;
</code></pre></div>
<div id=tabset-zh-cndocsusagesearchspecified-cluster-2-1 class=tab-pane role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchspecified-cluster-2-1>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/clusters/cluster-1/api/v1/namespaces/default/pods?ownerUID=151ae265-28fe-4734-850e-b641266cd5da&amp;ownerSeniority=1&#34;</span>
</code></pre></div></div></div>
<h3 id=指定-owner-name>指定 Owner Name</h3>
<p>如果事先并不知道 Owner 的 UID，那么指定 <code>Owner UID</code> 是一种比较麻烦的方式。</p>
<p>我们可以通过 Owner 的名字来指定 Owner，同时还可以指定 <code>Owner Group Resource</code> 来限制 Owner 的 Group Resource。</p>
<p>同样，我们以获取 Deployment 下相应的 Pods 来举例
<ul class="nav nav-tabs" id=tabset-zh-cndocsusagesearchspecified-cluster-3 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tabset-zh-cndocsusagesearchspecified-cluster-3-0 role=tab aria-controls=tabset-zh-cndocsusagesearchspecified-cluster-3-0 aria-selected=true>kubectl</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#tabset-zh-cndocsusagesearchspecified-cluster-3-1 role=tab aria-controls=tabset-zh-cndocsusagesearchspecified-cluster-3-1>URL</a></li></ul>
<div class=tab-content id=tabset-zh-cndocsusagesearchspecified-cluster-3><div id=tabset-zh-cndocsusagesearchspecified-cluster-3-0 class="tab-pane show active" role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchspecified-cluster-3-0>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster cluster-1 get pods -l <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    <span style=color:#4e9a06>&#34;search.clusterpedia.io/owner-name=deploy-1,\
</span><span style=color:#4e9a06>     search.clusterpedia.io/owner-seniority=1&#34;</span>
</code></pre></div><p>另外为了避免某些情况下，owner 资源存在多种类型，我们可以使用 Owner Group Resource 来限制 Owner 的类型</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster cluster-1 get pods -l <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    <span style=color:#4e9a06>&#34;search.clusterpedia.io/owner-name=deploy-1,\
</span><span style=color:#4e9a06>     search.clusterpedia.io/owner-gr=deployments.apps,\
</span><span style=color:#4e9a06>     search.clusterpedia.io/owner-seniority=1&#34;</span>
</code></pre></div></div>
<div id=tabset-zh-cndocsusagesearchspecified-cluster-3-1 class=tab-pane role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchspecified-cluster-3-1>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/clusters/cluster-1/api/v1/namespaces/default/pods?ownerName=deploy-1&amp;ownerSeniority=1&#34;</span>
</code></pre></div></div></div>
</p>
<h2 id=获取单个资源>获取单个资源</h2>
<p>当我们想要使用资源名称获取（Get）一个资源时，就必须要以 URL Path 的方式将集群名称传递进去，就像 namespace 一样。</p>
<ul class="nav nav-tabs" id=tabset-zh-cndocsusagesearchspecified-cluster-4 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tabset-zh-cndocsusagesearchspecified-cluster-4-0 role=tab aria-controls=tabset-zh-cndocsusagesearchspecified-cluster-4-0 aria-selected=true>kubectl</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#tabset-zh-cndocsusagesearchspecified-cluster-4-1 role=tab aria-controls=tabset-zh-cndocsusagesearchspecified-cluster-4-1>URL</a></li></ul>
<div class=tab-content id=tabset-zh-cndocsusagesearchspecified-cluster-4><div id=tabset-zh-cndocsusagesearchspecified-cluster-4-0 class="tab-pane show active" role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchspecified-cluster-4-0>
<p><p>如果使用多集群方式传递一个资源名称会报错</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster cluster-1 get deploy fake-deploy 
</code></pre></div><pre tabindex=0><code># 输出：
CLUSTER     NAME        READY   UP-TO-DATE   AVAILABLE   AGE
cluster-1   fake-deploy 1/1     1            1           35d
</code></pre><p>当然在 kubectl 中也可以通过 <a href=../#%E5%85%83%E4%BF%A1%E6%81%AF%E6%A3%80%E7%B4%A2>Search Label</a> 来指定一个资源名称。</p>
<p>不过在 <code>-o yaml</code> 或者其他方式查看返回的源数据时，和使用 <code>kubectl --cluster &lt;cluster name></code> 是不一样的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 实际服务端返回 DeploymentList 的资源，由 kubectl 替换成 List 资源</span>
kubectl --cluster clusterpedia get deploy -l 
    <span style=color:#4e9a06>&#34;search.clusterpedia.io/clusters=cluster-1,\
</span><span style=color:#4e9a06>     search.clusterpedia.io/names=fake-deploy&#34;</span> -o yaml
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># 输出：</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>items</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>List</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resourceVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selfLink</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>实际返回的资源依然是一个 <code>KindList</code>，而 <code>kubectl --cluster &lt;clsuter name></code> 返回的便是具体的 <code>Kind</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --cluster cluster-1 get deploy fake-deploy -o yaml
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># 输出：</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>deployment.kubernetes.io/revision</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>shadow.clusterpedia.io/cluster-name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cluster-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2021-12-16T02:26:29Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>generation</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>fake-deploy</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resourceVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;38085769&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>151ae265-28fe-4734-850e-b641266cd5da</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></div>
<div id=tabset-zh-cndocsusagesearchspecified-cluster-4-1 class=tab-pane role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchspecified-cluster-4-1>
<p><p>获取指定资源的 URL 可以分为三部分</p>
<ul>
<li>资源检索前缀： <em>/apis/clusterpedia.io/v1beta1/resources</em></li>
<li>指定集群名称 <em>/clusters/&lt; cluster name ></em></li>
<li>原生 Kubernetes API 的资源 Path <em>/apis/apps/v1/namespaces/&lt; namespace >/deployments/&lt; resource name ></em></li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/clusters/cluster-1/apis/apps/v1/namespaces/default/deployments/fake-deploy&#34;</span>
</code></pre></div></div></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-83e3a820b19f3a40c674f197775a60c8>3.5.3 - 聚合资源检索</h1>
<p>关于聚合资源的概念可以查看 <a href=../../../concepts/collection-resource>什么是聚合资源 （Collection Resource）</a></p>
<p>由于 kubectl 的限制，我们无法通过 <code>Label Selector</code> 或者其他方式来传递检索参数，
所以<strong>建议以 URL 的方式来检索<code>聚合资源</code></strong>。</p>
<ul class="nav nav-tabs" id=tabset-zh-cndocsusagesearchcollection-resource-1 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tabset-zh-cndocsusagesearchcollection-resource-1-0 role=tab aria-controls=tabset-zh-cndocsusagesearchcollection-resource-1-0 aria-selected=true>URL</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#tabset-zh-cndocsusagesearchcollection-resource-1-1 role=tab aria-controls=tabset-zh-cndocsusagesearchcollection-resource-1-1>kubectl</a></li></ul>
<div class=tab-content id=tabset-zh-cndocsusagesearchcollection-resource-1><div id=tabset-zh-cndocsusagesearchcollection-resource-1-0 class="tab-pane show active" role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchcollection-resource-1-0>
<p><blockquote>
<p><strong>请求<code>聚合资源</code>时，由于资源数量可能会非常大，一定要搭配<a href=../#%E5%88%86%E9%A1%B5>分页功能</a>使用。</strong></p>
</blockquote>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/collectionresources/workloads?limit=1&#34;</span> <span style=color:#000;font-weight:700>|</span> jq
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a40000>#</span> <span style=color:#a40000>输出</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;kind&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;CollectionResource&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;apiVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;clusterpedia.io/v1beta1&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;metadata&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;workloads&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;creationTimestamp&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span>
  <span style=color:#000;font-weight:700>},</span>
  <span style=color:#204a87;font-weight:700>&#34;resourceTypes&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;group&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;kind&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Deployment&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;resource&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;deployments&#34;</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;group&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;resource&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;daemonsets&#34;</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;group&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;v1&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;resource&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;statefulsets&#34;</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>],</span>
  <span style=color:#204a87;font-weight:700>&#34;items&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;apiVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;apps/v1&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;kind&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Deployment&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#a40000>...</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>]</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p><code>聚合资源</code>的复杂检索和<a href=../multi-cluster>多集群资源检索</a> 功能基本相同，只有部分操作不支持：</p>
<ul>
<li>不支持根据 Owner 检索，如果需要进行根据 Owner 检索需要指定具体的资源类型，可以参考 <a href=../multi-cluster#%E6%A0%B9%E6%8D%AE%E7%88%B6%E8%BE%88%E4%BB%A5%E5%8F%8A%E7%A5%96%E8%BE%88-owner-%E6%9F%A5%E8%AF%A2>多集群检索</a> 和 <a href=../specified-cluster#%E6%A0%B9%E6%8D%AE%E7%88%B6%E8%BE%88%E6%88%96%E8%80%85%E7%A5%96%E8%BE%88-owner-%E8%BF%9B%E8%A1%8C%E6%A3%80%E7%B4%A2>指定集群检索</a></li>
<li>不支持在 Collection Resource 中获取具体的单个资源，因为具体资源需要指定集群和资源类型，可以使用 <a href>获取单个资源</a></li>
</ul>
</div>
<div id=tabset-zh-cndocsusagesearchcollection-resource-1-1 class=tab-pane role=tabpanel aria-labelledby=tabset-zh-cndocsusagesearchcollection-resource-1-1>
<p><p>尽管 kubectl 无法很好的检索<code>聚合资源</code>，但是可以简单的体验一下。</p>
<blockquote>
<p>由于无法传递分页以及其他检索条件，kubectl 会一次获取到所有的<code>聚合资源</code>，在接入了大量集群或者存在大量 <code>deployments</code>，<code>daemonsets</code>，<code>statefulsets</code> 资源时，不要使用 kubectl 来查看<code>聚合资源</code></p>
</blockquote>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get collectionresources workloads
</code></pre></div><pre tabindex=0><code># 输出
CLUSTER     GROUP   VERSION   KIND         NAMESPACE                     NAME                                          AGE
cluster-1   apps    v1        DaemonSet    kube-system                   vsphere-cloud-controller-manager              63d
cluster-2   apps    v1        Deployment   kube-system                   calico-kube-controllers                       109d
cluster-2   apps    v1        Deployment   kube-system                   coredns-coredns                               109d
...
</code></pre><p><strong>请使用 URL 来检索<code>聚合资源</code></strong></p>
</div></div>
<h2 id=only-metadata>Only Metadata</h2>
<p>我们在检索 CollectionResource 时，获取到的资源默认是全量的资源信息，但是我们通常只需要获取资源的 metadata 即可。</p>
<p>在检索时我们可以使用 url query —— <code>onlyMetadata</code> 来只获取资源 Metadata。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get --raw <span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/collectionresources/workloads?onlyMetadata=true&amp;limit=1&#34;</span> <span style=color:#000;font-weight:700>|</span> jq
<span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#4e9a06>&#34;kind&#34;</span>: <span style=color:#4e9a06>&#34;CollectionResource&#34;</span>,
  <span style=color:#4e9a06>&#34;apiVersion&#34;</span>: <span style=color:#4e9a06>&#34;clusterpedia.io/v1beta1&#34;</span>,
  <span style=color:#4e9a06>&#34;metadata&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#4e9a06>&#34;name&#34;</span>: <span style=color:#4e9a06>&#34;workloads&#34;</span>,
    <span style=color:#4e9a06>&#34;creationTimestamp&#34;</span>: null
  <span style=color:#ce5c00;font-weight:700>}</span>,
  <span style=color:#4e9a06>&#34;resourceTypes&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#4e9a06>&#34;group&#34;</span>: <span style=color:#4e9a06>&#34;apps&#34;</span>,
      <span style=color:#4e9a06>&#34;version&#34;</span>: <span style=color:#4e9a06>&#34;v1&#34;</span>,
      <span style=color:#4e9a06>&#34;kind&#34;</span>: <span style=color:#4e9a06>&#34;Deployment&#34;</span>,
      <span style=color:#4e9a06>&#34;resource&#34;</span>: <span style=color:#4e9a06>&#34;deployments&#34;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>]</span>,
  <span style=color:#4e9a06>&#34;items&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#4e9a06>&#34;apiVersion&#34;</span>: <span style=color:#4e9a06>&#34;apps/v1&#34;</span>,
      <span style=color:#4e9a06>&#34;kind&#34;</span>: <span style=color:#4e9a06>&#34;Deployment&#34;</span>,
      <span style=color:#4e9a06>&#34;metadata&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#4e9a06>&#34;annotations&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#4e9a06>&#34;deployment.kubernetes.io/revision&#34;</span>: <span style=color:#4e9a06>&#34;1&#34;</span>,
          <span style=color:#4e9a06>&#34;shadow.clusterpedia.io/cluster-name&#34;</span>: <span style=color:#4e9a06>&#34;cluster-example&#34;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>,
        <span style=color:#4e9a06>&#34;creationTimestamp&#34;</span>: <span style=color:#4e9a06>&#34;2021-09-24T10:19:19Z&#34;</span>,
        <span style=color:#4e9a06>&#34;generation&#34;</span>: 1,
        <span style=color:#4e9a06>&#34;labels&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#4e9a06>&#34;k8s-app&#34;</span>: <span style=color:#4e9a06>&#34;tigera-operator&#34;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>,
        <span style=color:#4e9a06>&#34;name&#34;</span>: <span style=color:#4e9a06>&#34;tigera-operator&#34;</span>,
        <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;tigera-operator&#34;</span>,
        <span style=color:#4e9a06>&#34;resourceVersion&#34;</span>: <span style=color:#4e9a06>&#34;125073610&#34;</span>,
        <span style=color:#4e9a06>&#34;uid&#34;</span>: <span style=color:#4e9a06>&#34;992f9d53-37cb-4184-a004-15b278b11f79&#34;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=any-collectionresource>Any CollectionResource</h2>
<blockquote>
<p><code>any collectionresource</code> 是用户自由组合资源类型的方式之一，可以通过 <a href=../../../concepts/collection-resource#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%81%9A%E5%90%88%E8%B5%84%E6%BA%90>自定义聚合资源</a> 来查看更多。</p>
</blockquote>
<p>clusterpedia 支持一种特殊的 CollectionResource —— <code>any</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get collectionresources
NAME            RESOURCES
any             *
</code></pre></div><p>在检索 any collectionresource 时，我们必须通过 url query 来指定一组资源类型，因此我们只能通过 <a href=https://github.com/clusterpedia-io/client-go/pull/43>clusterpedia-io/client-go</a> 或者 url 来访问 any collectionresource</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get collectionresources any
Error from server <span style=color:#ce5c00;font-weight:700>(</span>BadRequest<span style=color:#ce5c00;font-weight:700>)</span>: url query - <span style=color:#4e9a06>`</span>groups<span style=color:#4e9a06>`</span> or <span style=color:#4e9a06>`</span>resources<span style=color:#4e9a06>`</span> is required
</code></pre></div><p><code>any collectionresource</code> 支持两个 url query —— <code>groups</code> 和 <code>resources</code></p>
<p><strong><code>groups</code> 和 <code>resources</code> 可以同时指定，当前是取两者并集，并且不会进行去重处理，由调用者负责去重</strong>，未来对该行为有一些优化。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get --raw <span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/collectionresources/any?onlyMetadata=true&amp;groups=apps&amp;resources=batch/jobs,batch/cronjobs&#34;</span> <span style=color:#000;font-weight:700>|</span> jq
</code></pre></div><h4 id=groups>groups</h4>
<p><code>groups</code> 可以指定一组资源的组和版本，多个组版本使用 <code>,</code> 分隔，组版本格式为 <strong>&lt; group >/&lt; version ></strong>，也可以不指定版本 <strong>&lt; group ></strong>，<em>对于 /api 下的资源，可以直接使用空字符串</em></p>
<p>示例：<strong>groups=apps/v1,,batch</strong> 指定了三个组 apps/v1, core, batch。</p>
<h4 id=resources>resources</h4>
<p><code>resources</code> 可以指定具体的资源类型，多个资源类型使用 <code>,</code> 分隔，资源类型格式为 <strong>&lt; group >/&lt; version >/&lt; resource></strong>，通过也可以不指定版本 <strong>&lt; group >/&lt; resource ></strong>。</p>
<p>示例：<strong>resources=apps/v1/deployments,apps/daemonsets,/pods</strong> 指定了三种资源 deloyments，daemonsets 和 pods。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-0d0c1b75726c3db95b8a2a8ee29102a0>4 - 高级功能</h1>
</div>
<div class=td-content>
<h1 id=pg-749921d4b7631dc83a7704cfc21dd956>4.1 - 多集群 kube-state-metrics</h1>
<p>Clusterpedia 以极小的代价提供了多集群资源的 kube-state-metrics 功能，它提供的指标信息与 <a href=https://github.com/kubernetes/kube-state-metrics>kube-state-metrics</a> 一致，当然会额外增加了一个集群名称的 label.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>kube_deployment_created{cluster=&#34;test-14&#34;,namespace=&#34;clusterpedia-system&#34;,deployment=&#34;clusterpedia-apiserver&#34;} 1.676557618e+09
</code></pre></div><p>由于该功能处于试验阶段，所以使用该功能需要先额外通过<a href=https://github.com/clusterpedia-io/clusterpedia-helm/tree/main/charts/clusterpedia#clusterpedia>标准方式安装 Clusterpedia</a>.</p>
<p>Clusterpedia 安装完成后，我们需要更新 helm 来开启 <code>多集群 kube-state-metrics</code> 功能。</p>
<blockquote>
<p>当前 main 分支中已经合并 kube-state-metrics 功能，未来会包含在 <code>v0.8.0</code> 中。
ghcr.io/iceber/clusterpedia/clustersynchro-manager:v0.8.0-ksm.1 镜像中包含该功能呢</p>
</blockquote>
<h2 id=开启多集群-kube-state-metrics>开启多集群 kube-state-metrics</h2>
<h3 id=确保-clusterpedia-chart-版本--v180>确保 Clusterpedia Chart 版本 >= v1.8.0</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ helm repo update clusterpedia
$ helm search clusterpedia
 NAME                            CHART VERSION   APP VERSION     DESCRIPTION
 clusterpedia/clusterpedia       1.8.0           v0.7.0          A Helm chart <span style=color:#204a87;font-weight:700>for</span> Kubernetes
</code></pre></div><h3 id=获取当前-chart-values>获取当前 chart values</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ helm -n clusterpedia-system get values clusterpedia &gt; values.yaml
</code></pre></div><h3 id=创建-patch-values>创建 patch values</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#000>echo &#34;clustersynchroManager:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>repository</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>iceber/clusterpedia/clustersynchro-manager</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>tag</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v0.8.0-ksm.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kubeStateMetrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>&#34; &gt; patch.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=更新-clusterpedia-开启多集群-kube-state-metrics>更新 Clusterpedia 开启多集群 kube-state-metrics</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ helm -n clusterpedia-system upgrade -f values.yaml -f patch.yaml clusterpedia clusterpedia/clusterpedia
</code></pre></div><p>查看 clusterpedia kube-state-metrics services</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl -n clusterpedia-system get svc
NAME                                          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#ce5c00;font-weight:700>(</span>S<span style=color:#ce5c00;font-weight:700>)</span>    AGE
clusterpedia-apiserver                        ClusterIP   10.97.129.238   &lt;none&gt;        443/TCP    150d
clusterpedia-clustersynchro-manager-metrics   ClusterIP   10.108.129.32   &lt;none&gt;        8081/TCP   51m
clusterpedia-kube-state-metrics               ClusterIP   10.108.130.62   &lt;none&gt;        8080/TCP   43m
clusterpedia-mysql                            ClusterIP   10.102.38.225   &lt;none&gt;        3306/TCP   150d
clusterpedia-mysql-headless                   ClusterIP   None            &lt;none&gt;        3306/TCP   150d
</code></pre></div><p>For more information on importing clusters and using clusterpedia: <a href=../../usage/import-clusters>Import Clusters</a></p>
<h2 id=未来>未来</h2>
<p><code>多集群 kube-state-metrics</code> 是一个非常有趣的功能，它可以让你不再需要在每一个集群中安装单集群版本的 kube-state-metrics，并且它可以很好的处理资源版本不同的问题。</p>
<p>这里有很多关于该功能的讨论，欢迎评论</p>
<ul>
<li><a href=https://github.com/clusterpedia-io/clusterpedia/issues/544>The resource state metrics provide different metrics paths depending on the cluster</a></li>
<li><a href=https://github.com/clusterpedia-io/clusterpedia/issues/545>Support remote write to send resource metrics data</a></li>
<li><a href=https://github.com/clusterpedia-io/clusterpedia/issues/546>Support for filtering exposed resource state metrics based on namespace</a></li>
<li><a href=https://github.com/clusterpedia-io/clusterpedia/issues/547>Support for filtering exposed resource state metrics by cluster labels/annotations</a></li>
</ul>
<p>也欢迎创建<a href=https://github.com/clusterpedia-io/clusterpedia/issues/new/choose>新的 issue</a></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3f7581a2a6289f53ebfc75ee37b2d8d4>4.2 - 自定义存储层插件</h1>
<p>Clusterpedia 可以通过存储层来使用不同的存储组件，例如 MySQL/PostgreSQL, Memory, Elasticsearch</p>
<p>当前，Clusterpedia 内置了两个存储层：</p>
<ul>
<li>用于接入关系型数据库的 <a href=https://clusterpedia.io/zh-cn/docs/installation/configurate/configurate-internalstorage/>internalstorage</a> 存储层</li>
<li>基于内存的 <a href=https://github.com/clusterpedia-io/clusterpedia/tree/main/pkg/storage/memorystorage>memory</a> 存储层</li>
</ul>
<p>尽管 Clusterpedia 已经默认支持了关系型数据库和内存，但是用户的需求往往是多变和复杂的，固定的存储层可能无法满足不同用户对于存储组件和性能的要求，于是 Clusterpedia 支持通过插件的方式来接入用户自己实现的存储层，我们称这种方式为 <code>自定义存储层插件</code>，简称为 <code>存储插件</code>。</p>
<p>通过<code>存储插件</code>，用户可以做到以下事情：</p>
<ul>
<li><strong>使用任意的存储组件</strong>，例如 <code>Elasticsearch</code>，<code>RedisGraph</code>，<code>Etcd</code>，甚至是 <code>MessageQueue</code> 也没有问题</li>
<li>允许用户针对自己的业务来优化资源的存储格式和查询性能</li>
<li>针对存储组件的特性来实现更高级的检索功能</li>
</ul>
<p>Clusterpedia 也维护了一些<code>存储插件</code>，用户可以根据需求选用：</p>
<ul>
<li><a href=https://github.com/clusterpedia-io/sample-storage>Sample Storage</a>: 可以连接<strong>关系型数据库</strong>的存储插件示例</li>
<li><a href=https://github.com/clusterpedia-io/elasticsearch-storage>Elasticsearch Storage</a>: 用于连接 <strong>Elasticsearch</strong> 的存储插件</li>
</ul>
<p><code>存储插件</code>是通过 <strong>Go Plugin</strong> 的方式来让 Clusterpedia 组件加载，相比 RPC 或者其他方式，这种方式在没有任何损耗的前提下提供非常灵活的插件接入。</p>
<blockquote>
<p>关于 <strong>Go Plugin</strong> 对性能的影响可以简单参考 <a href=https://github.com/uberswe/goplugins>https://github.com/uberswe/goplugins</a></p>
</blockquote>
<p>众所周知，<strong>Go Plugin</strong> 在开发和使用上都比较繁琐，不过 Clusterpedia 通过一些机制来巧妙的优化了存储插件的使用和开发，并且提供了 <a href=https://github.com/clusterpedia-io/sample-storage>clusterpedia-io/sample-storage</a> 插件作为参考。</p>
<p>下面我们以 <a href=https://github.com/clusterpedia-io/sample-storage>clusterpedia-io/sample-storage</a> 为例，分别介绍：</p>
<ul>
<li><a href=#%E4%BD%BF%E7%94%A8-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%98%E5%82%A8%E5%B1%82%E6%8F%92%E4%BB%B6>如何使用 <code>自定义存储层插件</code></a></li>
<li><a href=#%E5%BC%80%E5%8F%91%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%98%E5%82%A8%E5%B1%82%E6%8F%92%E4%BB%B6>如何实现 <code>自定义存储层插件</code></a></li>
</ul>
<h2 id=使用-自定义存储层插件>使用 <code>自定义存储层插件</code></h2>
<p>存储插件的使用可以大致分为三种方式：</p>
<ol>
<li>运行 Clusterpedia 组件二进制并加载 <code>存储插件</code></li>
<li>使用基础 Chart —— clusterpedia-core 来设置<code>存储插件镜像</code>和配置存储层</li>
<li>使用 Clusterpedia <strong>高级 Chart</strong>，无需关心存储插件的设置</li>
</ol>
<p>通过本地运行组件二进制，我们可以更加了解 Cluserpedia 组件是如何加载和运行 <code>存储插件</code>，</p>
<p>用户在真正使用时通常是利用已经构建好的<code>存储插件镜像</code>，或者是直接部署 Clusterpedia <strong>高级 Chart</strong></p>
<h3 id=本地运行>本地运行</h3>
<h4 id=插件构建>插件构建</h4>
<p>存储插件实际是一个 <em>.so</em> 后缀的动态链接库，Clusterpedia 组件在启动时可以加载<code>存储插件</code>，并根据指定的存储层名称来使用具体的<code>存储插件</code>。</p>
<p>我们以 <a href=https://github.com/clusterpedia-io/sample-storage>clusterpedia-io/sample-storage</a> 为例，构建出一个<code>存储插件</code>二进制</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ git clone --recursive https://github.com/clusterpedia-io/sample-storage.git <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>cd</span> sample-storage
$ make build-plugin
</code></pre></div><p>使用 <strong>file</strong> 命令查看<code>存储插件</code>信息</p>
<pre tabindex=0><code>$ file ./plugins/sample-storage-layer.so
./plugins/sample-storage-layer.so: Mach-O 64-bit dynamically linked shared library x86_64
</code></pre><p>Clusterpedia 的 <code>ClusterSynchro Manager</code> 和 <code>APIServer</code> 组件可以通过环境变量和命令参数来加载和使用存储插件：</p>
<ul>
<li><code>STORAGE_PLUGINS=&lt;plugins dir></code> 环境变量设置插件所在目录，Clusterpedia 会将该目录下所有插件都加载到组件中</li>
<li><code>--storage-name=&lt;storage name></code> 插件命令参数，设置存储层名称</li>
<li><code>--storage-config=&lt;storage config path></code> 插件命令参数，设置存储层配置</li>
</ul>
<h4 id=组件构建>组件构建</h4>
<p>本地运行时，为了保证依赖一致，需要在本地通过 <code>make build-components</code> 命令构建 clusterpedia 组件</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ <span style=color:#8f5902;font-style:italic># 在 sample-storage 目录</span>
$ make build-components
$ ls -al ./bin
-rwxr-xr-x   <span style=color:#0000cf;font-weight:700>1</span> icebergu  staff  <span style=color:#0000cf;font-weight:700>90707488</span> <span style=color:#0000cf;font-weight:700>11</span>  <span style=color:#0000cf;font-weight:700>7</span> 11:15 apiserver
-rwxr-xr-x   <span style=color:#0000cf;font-weight:700>1</span> icebergu  staff  <span style=color:#0000cf;font-weight:700>91896016</span> <span style=color:#0000cf;font-weight:700>11</span>  <span style=color:#0000cf;font-weight:700>7</span> 11:16 binding-apiserver
-rwxr-xr-x   <span style=color:#0000cf;font-weight:700>1</span> icebergu  staff  <span style=color:#0000cf;font-weight:700>82769728</span> <span style=color:#0000cf;font-weight:700>11</span>  <span style=color:#0000cf;font-weight:700>7</span> 11:16 clustersynchro-manager
-rwxr-xr-x   <span style=color:#0000cf;font-weight:700>1</span> icebergu  staff  <span style=color:#0000cf;font-weight:700>45682000</span> <span style=color:#0000cf;font-weight:700>11</span>  <span style=color:#0000cf;font-weight:700>7</span> 11:17 controller-manager
</code></pre></div><blockquote>
<p>关于存储插件与 Clusterpedia 组件的构建可以查看 <a href=#%E6%9C%AC%E5%9C%B0%E5%BC%80%E5%8F%91%E8%BF%90%E8%A1%8C>开发自定义存储层插件</a></p>
</blockquote>
<h4 id=存储插件运行时的配置文件>存储插件运行时的配置文件</h4>
<p>在运行 clusterpedia 前还需要准备<code>存储插件</code>在运行时的配置文件，<em>sample-storage</em> 提供了它的配置示例 <a href=https://github.com/clusterpedia-io/sample-storage/blob/main/example-config.yaml>example-config.yaml</a></p>
<p>在运行时 clusterpedia 组件时，通过 <code>--storage-config=./config.yaml</code> 来指定运行时配置文件</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># example-config.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mysql</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>127.0.0.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;3306&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>root</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dangerous0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterpedia</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>log</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>stdout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>colorful</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>slowThreshold</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>100ms</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>用户需要根据选择的存储层来配置运行时配置</p>
<h4 id=运行-clusterpedia-clustersynchro-manager>运行 clusterpedia clustersynchro manager</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ <span style=color:#000>STORAGE_PLUGINS</span><span style=color:#ce5c00;font-weight:700>=</span>./plugins ./bin/clustersynchro-manager --kubeconfig ~/.kube/config <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --storage-name<span style=color:#ce5c00;font-weight:700>=</span>sample-storage-layer <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --storage-config ./config.yaml
</code></pre></div><h4 id=运行-clusterpedia-apiserver>运行 clusterpedia apiserver</h4>
<p>可以选择不使用自己生成的证书，这时需要在运行 apiserver 忽略掉 <code>--client-ca-file ca.crt</code> 参数</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ openssl req -nodes -new -x509 -keyout ca.key -out ca.crt
$ openssl req -out client.csr -new -newkey rsa:4096 -nodes -keyout client.key -subj <span style=color:#4e9a06>&#34;/CN=development/O=system:masters&#34;</span>
$ openssl x509 -req -days <span style=color:#0000cf;font-weight:700>365</span> -in client.csr -CA ca.crt -CAkey ca.key -set_serial <span style=color:#0000cf;font-weight:700>01</span> -sha256 -out client.crt
</code></pre></div><p>运行 apiserver</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ <span style=color:#000>STORAGE_PLUGINS</span><span style=color:#ce5c00;font-weight:700>=</span>./plugins ./bin/apiserver --client-ca-file ca.crt  --secure-port <span style=color:#0000cf;font-weight:700>8443</span> <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --kubeconfig ~/.kube/config <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --authentication-kubeconfig ~/.kube/config <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --authorization-kubeconfig ~/.kube/config <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --storage-name<span style=color:#ce5c00;font-weight:700>=</span>sample-storage-layer <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --storage-config ./config.yaml
</code></pre></div><h3 id=存储插件镜像--helm-charts>存储插件镜像 + Helm Charts</h3>
<p>Clusterpeida 已经提供了多个 Charts：</p>
<ul>
<li><a href=https://github.com/clusterpedia-io/clusterpedia-helm/tree/main/charts/clusterpedia>charts/clusterpedia</a> 使用 internalstorage 存储层的 Chart，可以选择部署 MySQL 或者 PostgreSQL，但是不支持设置存储插件</li>
<li><a href=https://github.com/clusterpedia-io/clusterpedia-helm/tree/main/charts/clusterpedia-core>charts/clusterpedia-core</a> 支持配置任意存储层的 Chart，通常作为子 Chart 来使用</li>
<li><a href=https://github.com/clusterpedia-io/clusterpedia-helm/tree/main/charts/clusterpedia-mysql>charts/clusterpedia-mysql</a> 使用 MySQL 作为存储组件的<strong>高级 Chart</strong>，基于 clusterpedia-core 实现</li>
<li><a href=https://github.com/clusterpedia-io/clusterpedia-helm/tree/main/charts/clusterpedia-postgresql>charts/clusterpedia-postgresql</a> 使用 PostgreSQL 作为存储组件的<strong>高级 Chart</strong>，基于 clusterpedia-core 实现</li>
<li><a href=https://github.com/clusterpedia-io/clusterpedia-helm/tree/main/charts/clusterpedia-elasticsearch>charts/clusterpedia-elasticsearch</a> 使用 Elasticsearch 作为存储组件的<strong>高级 Chart</strong>，基于 clusterpedia-core 实现</li>
</ul>
<p>如果用户没有<code>存储插件</code>需求，默认存储层和关系型数据库已经可以满足需求的话，可以直接选用 <a href=https://github.com/clusterpedia-io/clusterpedia-helm/tree/main/charts/clusterpedia>charts/clusterpedia</a>，开箱即用</p>
<p><a href=https://github.com/clusterpedia-io/clusterpedia-helm/tree/main/charts/clusterpedia-mysql>clusterpedia-mysql</a>，<a href=https://github.com/clusterpedia-io/clusterpedia-helm/tree/main/charts/clusterpedia-postgresql>clusterpedia-postgresql</a> 和 <a href=https://github.com/clusterpedia-io/clusterpedia-helm/tree/main/charts/clusterpedia-elasticsearch>clusterpedia-elasticsearch</a> 便是基于 <a href=https://github.com/clusterpedia-io/clusterpedia-helm/tree/main/charts/clusterpedia-core>clusterpedia-core</a> 实现的<strong>高级 Charts</strong>，在这些 Charts 中通过默认配置 clusterpedia-core 的<code>存储插件镜像</code>和存储层配置来为用户屏蔽掉<code>存储插件</code>的复杂概念，开箱即用</p>
<p>尽管我们在使用中通常会直接使用<strong>高级 Charts</strong>，但是知道如何使用 <a href=https://github.com/clusterpedia-io/clusterpedia-helm/tree/main/charts/clusterpedia-core>clusterpedia-core</a> 来设置<code>存储插件镜像</code>，可以让我们更好的理解<code>插件镜像</code>是如何工作的。</p>
<h4 id=clusterpedia-core>clusterpedia-core</h4>
<p>我们以 <a href=https://github.com/clusterpedia-io/sample-storage>clusterpedia-io/sample-storage</a> 为例，使用 <a href=https://github.com/clusterpedia-io/sample-storage/pkgs/container/clusterpedia%2Fsample-storage-layer>ghcr.io/clusterpedia-io/clusterpedia/sample-storage-layer</a> 插件镜像来部署 Clusterpedia。</p>
<p><em>clusterpedia-core</em> 不涉及任何存储组件的部署安装，所以用户需要根据已部署的存储组件来配置存储层</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># myvalues.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>storage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;sample-storage-layer&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>registry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ghcr.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>repository</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterpedia-io/clusterpedia/sample-storage-layer</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>tag</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v0.0.0-v0.6.0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;mysql&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;10.111.94.196&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3306</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>root</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dangerous0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterpedia</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><code>storage.name</code> 配置存储镜像插件的存储层名称</p>
<p>clusterpedia-core 会将 <code>storage.image</code> 定义的插件镜像中的<code>存储插件</code>复制到组件的插件目录下</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># helm template clusterpedia -n clusterpedia-system -f myvalues.yaml ./clusterpedia-core</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>initContainers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>copy-storage-plugin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ghcr.io/clusterpedia-io/clusterpedia/sample-storage-layer:v0.0.0-v0.6.0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>imagePullPolicy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>IfNotPresent</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>command</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#000>/bin/sh</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- -<span style=color:#000>ec</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#000>cp /plugins/* /var/lib/clusterpedia/plugins/</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>volumeMounts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage-plugins</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>mountPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/lib/clusterpedia/plugins</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterpedia-clusterpedia-core-apiserver</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ghcr.io/clusterpedia-io/clusterpedia/apiserver:v0.6.0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>imagePullPolicy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>IfNotPresent</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>command</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>/usr/local/bin/apiserver</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- --<span style=color:#000>secure-port=443</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- --<span style=color:#000>storage-name=sample-storage-layer</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- --<span style=color:#000>storage-config=/etc/clusterpedia/storage/config.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STORAGE_PLUGINS</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/lib/clusterpedia/plugins</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>volumeMounts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>mountPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/clusterpedia/storage</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>readOnly</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage-plugins</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>mountPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/lib/clusterpedia/plugins</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>readOnly</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>volumes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>configMap</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterpedia-clusterpedia-core-sample-storage-layer-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage-plugins</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>emptyDir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>除了使用 <code>storage.config</code> 定义存储层的运行时配置 config.yaml 外，还可以使用已有的 configmap 以及 secret</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># myvalues.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>storage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;sample-storage-layer&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>registry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ghcr.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>repository</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterpedia-io/clusterpedia/sample-storage-layer</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>tag</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v0.0.0-v0.6.0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>configMap</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;sample-storage-config&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>componentEnv</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DB_PASSWORD</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>secretKeyRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;sample-storage-password&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>password</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><em>clusterpedia-core</em> 为了能够作为子 Chart 被其他高级 Charts 引用，在存储层配置上是非常灵活的，但是用户实际在使用中并不一定需要直接使用 clusterpedia-core，只需要使用针对具体存储组件部署的<strong>高级 Charts</strong> 即可，例如 <em>clusterpedia-mysql</em> 和 <em>clusterpedia-postgresql</em></p>
<p>在下节我们也会介绍如何基于 <em>clusterpedia-core</em> 来针对具体存储组件实现<strong>高级 Chart</strong>。</p>
<h2 id=开发自定义存储层插件>开发<code>自定义存储层插件</code></h2>
<p><a href=https://github.com/clusterpedia-io/sample-storage>clusterpedia-io/sample-storage</a> 不仅仅是一个存储插件示例，也是一个模版仓库，其中项目结构和大部分构建工具都可以在其他存储插件项目中使用</p>
<p>我们首先 clone <em>sample-storage</em>，或者根据 <em>sample-storage</em> 生成一个新的存储插件仓库</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ git clone --recursive https://github.com/clusterpedia-io/sample-storage.git <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>cd</span> sample-storage
</code></pre></div><p>注意拉取仓库时，需要指定 <code>--recursive</code> 拉取子仓库</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ ls -al
...
-rw-r--r--   <span style=color:#0000cf;font-weight:700>1</span> icebergu  staff    <span style=color:#0000cf;font-weight:700>260</span> <span style=color:#0000cf;font-weight:700>12</span> <span style=color:#0000cf;font-weight:700>13</span> 15:14 Dockerfile
-rw-r--r--   <span style=color:#0000cf;font-weight:700>1</span> icebergu  staff   <span style=color:#0000cf;font-weight:700>1836</span> <span style=color:#0000cf;font-weight:700>12</span> <span style=color:#0000cf;font-weight:700>13</span> 16:03 Makefile
-rw-r--r--   <span style=color:#0000cf;font-weight:700>1</span> icebergu  staff   <span style=color:#0000cf;font-weight:700>2219</span> <span style=color:#0000cf;font-weight:700>11</span> <span style=color:#0000cf;font-weight:700>23</span> 10:25 README.md
drwxr-xr-x  <span style=color:#0000cf;font-weight:700>32</span> icebergu  staff   <span style=color:#0000cf;font-weight:700>1024</span> <span style=color:#0000cf;font-weight:700>11</span> <span style=color:#0000cf;font-weight:700>23</span> 10:30 clusterpedia
-rw-r--r--   <span style=color:#0000cf;font-weight:700>1</span> icebergu  staff    <span style=color:#0000cf;font-weight:700>156</span> <span style=color:#0000cf;font-weight:700>11</span> <span style=color:#0000cf;font-weight:700>23</span> 10:25 example-config.yaml
-rw-r--r--   <span style=color:#0000cf;font-weight:700>1</span> icebergu  staff   <span style=color:#0000cf;font-weight:700>2376</span> <span style=color:#0000cf;font-weight:700>12</span> <span style=color:#0000cf;font-weight:700>13</span> 15:33 go.mod
-rw-r--r--   <span style=color:#0000cf;font-weight:700>1</span> icebergu  staff  <span style=color:#0000cf;font-weight:700>46109</span> <span style=color:#0000cf;font-weight:700>12</span> <span style=color:#0000cf;font-weight:700>13</span> 15:33 go.sum
-rw-r--r--   <span style=color:#0000cf;font-weight:700>1</span> icebergu  staff    <span style=color:#0000cf;font-weight:700>139</span> <span style=color:#0000cf;font-weight:700>11</span> <span style=color:#0000cf;font-weight:700>23</span> 10:25 main.go
drwxr-xr-x  <span style=color:#0000cf;font-weight:700>16</span> icebergu  staff    <span style=color:#0000cf;font-weight:700>512</span> <span style=color:#0000cf;font-weight:700>12</span> <span style=color:#0000cf;font-weight:700>13</span> 15:33 storage
drwxr-xr-x   <span style=color:#0000cf;font-weight:700>9</span> icebergu  staff    <span style=color:#0000cf;font-weight:700>288</span> <span style=color:#0000cf;font-weight:700>12</span> <span style=color:#0000cf;font-weight:700>13</span> 15:33 vendor
</code></pre></div><p>整个项目结构分为三类</p>
<ul>
<li><code>main.go</code>, <code>storage</code> 包：<code>自定义存储层插件</code>的核心逻辑</li>
<li><code>clusterpedia</code> 主库，用于本地开发和测试</li>
<li><em>Dockerfile</em> 和 <em>Makefile</em> 用于项目构建和镜像打包，可以适用于任何存储插件项目</li>
</ul>
<h3 id=核心逻辑>核心逻辑</h3>
<p><em>main.go</em> 是存储插件的主文件，主要用来调用 storage 包中的注册函数 —— <code>RegisterStorageLayer</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
	<span style=color:#000>plugin</span> <span style=color:#4e9a06>&#34;github.com/clusterpedia-io/sample-storage-layer/storage&#34;</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>init</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>plugin</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RegisterStorageLayer</span><span style=color:#000;font-weight:700>()</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>storage 包中的是存储插件的核心逻辑：</p>
<ol>
<li>实现 clusterpedia 存储层接口 <a href=https://github.com/clusterpedia-io/clusterpedia/blob/4608c8d13101d82960525dfe39f51e4f64ed49b3/pkg/storage/storage.go#L13><code>storage.StorageFactory</code></a></li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
	<span style=color:#4e9a06>&#34;gorm.io/gorm&#34;</span>

	<span style=color:#4e9a06>&#34;github.com/clusterpedia-io/clusterpedia/pkg/storage&#34;</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>StorageFactory</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>db</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>gorm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DB</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>_</span> <span style=color:#000>storage</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StorageFactory</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>StorageFactory</span><span style=color:#000;font-weight:700>{}</span>
</code></pre></div><ol start=2>
<li><a href=https://github.com/clusterpedia-io/sample-storage/blob/main/storage/register.go#L33>NewStorageFactory</a> 函数来返回 <code>storage.StorageFactory</code> 实例</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>NewStorageFactory</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>configPath</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>storage</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StorageFactory</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><ol start=3>
<li>RegisterStorageLayer 函数将 NewStorageFactory 注册到 clusterpedia 中</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>StorageName</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;sample-storage-layer&#34;</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>RegisterStorageLayer</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>storage</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RegisterStorageFactoryFunc</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>StorageName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>NewStorageFactory</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>当用户通过 <code>--storage-name</code> 指定该存储层时，会自动调用注册的 <strong>NewStorageFactory</strong> 来创建 <code>storage.StorageFactory</code> 实例。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>./bin/apiserver --storage-name<span style=color:#ce5c00;font-weight:700>=</span>sample-storage-layer &lt;other flags&gt;
</code></pre></div><h3 id=本地开发运行>本地开发运行</h3>
<p>为了方便开发测试，我们在存储插件的仓库中添加了 clusterpedia 主库作为子库</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ git submodule status
+4608c8d13101d82960525dfe39f51e4f64ed49b3 clusterpedia <span style=color:#ce5c00;font-weight:700>(</span>v0.6.0<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>并且将 go.mod 中 clusterpedia 仓库 replace 为本地子库</p>
<pre tabindex=0><code># go.mod
replace (
        github.com/clusterpedia-io/api =&gt; ./clusterpedia/staging/src/github.com/clusterpedia-io/api
        github.com/clusterpedia-io/clusterpedia =&gt; ./clusterpedia
)
</code></pre><p>在构建存储层镜像时，不会使用本地 cluserpedia 子库</p>
<h4 id=存储插件构建>存储插件构建</h4>
<p>存储插件的构建分为两部分，分别是构建 clusterpedia 子库中组件和构建存储插件</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ make build-components
<span style=color:#000>OUTPUT_DIR</span><span style=color:#ce5c00;font-weight:700>=</span>/Users/icebergu/workspace/clusterpedia/sample-storage-layer <span style=color:#000>ON_PLUGINS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>                /Library/Developer/CommandLineTools/usr/bin/make -C clusterpedia all
hack/builder.sh apiserver
hack/builder.sh binding-apiserver
hack/builder.sh clustersynchro-manager
hack/builder-nocgo.sh controller-manager

$ ls -al ./bin
-rwxr-xr-x   <span style=color:#0000cf;font-weight:700>1</span> icebergu  staff  <span style=color:#0000cf;font-weight:700>90724968</span> <span style=color:#0000cf;font-weight:700>12</span> <span style=color:#0000cf;font-weight:700>15</span> 09:51 apiserver
-rwxr-xr-x   <span style=color:#0000cf;font-weight:700>1</span> icebergu  staff  <span style=color:#0000cf;font-weight:700>91936472</span> <span style=color:#0000cf;font-weight:700>12</span> <span style=color:#0000cf;font-weight:700>15</span> 09:52 binding-apiserver
-rwxr-xr-x   <span style=color:#0000cf;font-weight:700>1</span> icebergu  staff  <span style=color:#0000cf;font-weight:700>82826584</span> <span style=color:#0000cf;font-weight:700>12</span> <span style=color:#0000cf;font-weight:700>15</span> 09:52 clustersynchro-manager
-rwxr-xr-x   <span style=color:#0000cf;font-weight:700>1</span> icebergu  staff  <span style=color:#0000cf;font-weight:700>45677904</span> <span style=color:#0000cf;font-weight:700>12</span> <span style=color:#0000cf;font-weight:700>15</span> 09:52 controller-manager
</code></pre></div><p><code>make build-components</code> 命令会在调用 clusterpedia 库中的 <code>make all</code>，并将结果输出到存储插件项目的 ./bin 目录下</p>
<blockquote>
<p>如果 clusterpedia 子库未发生更改，那么只需要构建组件即可</p>
</blockquote>
<p>构建存储插件</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ make build-plugin
<span style=color:#000>CLUSTERPEDIA_REPO</span><span style=color:#ce5c00;font-weight:700>=</span>/Users/icebergu/workspace/clusterpedia/sample-storage/clusterpedia <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>                clusterpedia/hack/builder.sh plugins sample-storage-layer.so

$ ls -al ./plugins
-rw-r--r--   <span style=color:#0000cf;font-weight:700>1</span> icebergu  staff  <span style=color:#0000cf;font-weight:700>53354352</span> <span style=color:#0000cf;font-weight:700>12</span> <span style=color:#0000cf;font-weight:700>15</span> 09:47 sample-storage-layer.so
</code></pre></div><p>本地构建存储插件也是需要使用 clusterpedia 库的 <a href=https://github.com/clusterpedia-io/clusterpedia/blob/main/hack/builder.sh>builder.sh</a> 脚本来构建插件二进制</p>
<p>关于运行存储层插件可以参考 <a href=#%E6%9C%AC%E5%9C%B0%E8%BF%90%E8%A1%8C>本地运行存储插件</a></p>
<h3 id=存储插件镜像>存储插件镜像</h3>
<p>上文提到，存储插件在真正的部署中，是通过镜像的方式将存储插件共享给 clusterpedia。</p>
<p>Makefile 中提供 <code>make image-plugin</code> 来构建镜像，<code>make push-images</code> 来发布镜像</p>
<h4 id=构建镜像>构建镜像</h4>
<p>构建插件镜像时，我们需要使用 <a href=https://github.com/clusterpedia-io/clusterpedia/pkgs/container/clusterpedia%2Fbuilder>clusterpedia/builder</a> 镜像作为基础镜像来构建插件，builder 镜像的版本需要和使用插件的 clusterpedia 组件的版本一致</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ <span style=color:#000>BUILDER_IMAGE</span><span style=color:#ce5c00;font-weight:700>=</span>ghcr.io/clusterpedia-io/clusterpedia/builder:v0.6.0 make image-plugin
</code></pre></div><p>clusterpedia 中维护了已发布版本的 builder 镜像，用户也可以使用自己本地构建的 builder 镜像</p>
<p>本地构建 builder 镜像</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ <span style=color:#204a87>cd</span> clusterpedia
$ make image-builder
docker buildx build <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>                -t <span style=color:#4e9a06>&#34;ghcr.io/clusterpedia-io/clusterpedia&#34;</span>/builder-amd64:4608c8d13101d82960525dfe39f51e4f64ed49b3 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>                --platform<span style=color:#ce5c00;font-weight:700>=</span>linux/amd64 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>                --load <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>                -f builder.dockerfile . <span style=color:#000;font-weight:700>;</span> <span style=color:#4e9a06>\
</span></code></pre></div><p><code>存储插件镜像</code>的 tag 格式为 <storage-version>-&lt;clusterpedia-version/commit>，例如：
<em>ghcr.io/clusterpedia-io/clusterpedia/sample-storage-layer:v0.0.0-v0.6.0</em></p>
<p>存储插件镜像可以部署在 &lt;clusterpedia-version/commit> 版本的 Clusterpedia 中</p>
<h4 id=镜像推送>镜像推送</h4>
<p><code>make image-plugin</code> 根据手动设置的 builder 镜像来构建存储插件镜像</p>
<p>而使用 <code>make push-images</code> 推送镜像时会自动为所有兼容版本和架构构建镜像</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=color:#8f5902;font-style:italic># Makefile
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>CLUSTERPEDIA_VERSIONS</span> <span style=color:#ce5c00;font-weight:700>=</span> v0.6.0-beta.1 v0.6.0
<span style=color:#000>RELEASE_ARCHS</span> <span style=color:#ce5c00;font-weight:700>?=</span> amd64 arm64
</code></pre></div><p>镜像构建好后，可以<a href=#clusterpedia-core>通过 cluserpedia-core 来使用<code>存储插件镜像</code></a></p>
<h2 id=基于-clusterpeida-core-实现高级-chart>基于 clusterpeida-core 实现高级 Chart</h2>
<p>我们在实现自己的存储插件后，为了更加方便的使用，还是需要基于 clusterpedia-core Chart 来封装出<strong>高级 Chart</strong></p>
<p><strong>高级 Chart</strong> 需要提供以下能力：</p>
<ul>
<li>设置默认的<code>存储插件镜像</code></li>
<li>设置存储层名称</li>
<li>支持动态设置存储层的运行时配置</li>
<li>提供对存储组件的配置和安装</li>
</ul>
<p>创建一个使用 <em>sample-storage</em> 存储插件的新 Chart —— clusterpedia-sample-mysql，这个 Chart 会使用 mysql 作为存储组件。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># Chart.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>dependencies</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mysql</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>repository</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://charts.bitnami.com/bitnami</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9.</span><span style=color:#000>x.x</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>common</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>repository</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://charts.bitnami.com/bitnami</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1.</span><span style=color:#000>x.x</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterpedia-core</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>repository</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://clusterpedia-io.github.io/clusterpedia-helm/</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0.1</span><span style=color:#000>.x</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>我们需要覆盖 clusterpedia-core 中存储层相关的设置，clusterpedia-core 提供 <strong>values.yaml</strong> 和<strong>动态模版</strong>两种方式来设置存储插件和存储层信息</p>
<p>我们在 values.yaml 覆盖存储层的静态设置，例如<strong>插件镜像</strong>和<strong>存储层名称</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># values.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>clusterpedia-core</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>storage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;sample-storage-layer&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>registry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;ghcr.io&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>repository</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;clusterpedia-io/clusterpedia/sample-storage-layer&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>tag</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;v0.0.0-v0.6.0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>自定义存储层的 <em>config.yaml</em> 和一些环境变量的设置，一般需要引用 ConfigMap 和 Secret，而这些资源的名称会根据 Chart 的 Release 名字动态变化，所以我们需要使用 <strong>动态模版</strong> 的方式来设置</p>
<p>clusterpedia-core 提供了三个可以覆盖的命名模版</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># clusterpedia-core/templates/_storage_override.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>{{- <span style=color:#000>define &#34;clusterpedia.storage.override.initContainers&#34; -}}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>{{- <span style=color:#000>end -}}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>{{- <span style=color:#000>define &#34;clusterpedia.storage.override.configmap.name&#34; -}}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>{{- <span style=color:#000>end -}}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>{{- <span style=color:#000>define &#34;clusterpedia.storage.override.componentEnv&#34; -}}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>{{- <span style=color:#000>end -}}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>可以分别设置：</p>
<ul>
<li><code>apiserver</code>，<code>clustersynchro manager</code> 组件运行前的 init containers</li>
<li>保存存储插件需要读取的 config.yaml 配置的 ConfigMap 名称</li>
<li>存储插件需要使用的环境变量</li>
</ul>
<p>我们以 <a href=https://github.com/clusterpedia-io/clusterpedia-helm/blob/main/charts/clusterpedia-mysql/templates/_storage_override.yaml>clusterpedia-mysql</a> 为例，看看它的设置</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># _storage_override.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>{{- <span style=color:#000>define &#34;clusterpedia.storage.override.initContainers&#34; -}}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ensure-database</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>docker.io/bitnami/mysql:8.0.28-debian-10-r23</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>command</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>/bin/sh</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- -<span style=color:#000>ec</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>    if [ ${CREARE_DATABASE} = &#34;ture&#34; ]; then
</span><span style=color:#8f5902;font-style:italic>      until mysql -u${STORAGE_USER} -p${DB_PASSWORD} --host=${STORAGE_HOST} --port=${STORAGE_PORT} -e &#39;CREATE DATABASE IF NOT EXISTS ${STORAGE_DATABASE}&#39;; do
</span><span style=color:#8f5902;font-style:italic>      echo waiting for database check &amp;&amp; sleep 1;
</span><span style=color:#8f5902;font-style:italic>      done;
</span><span style=color:#8f5902;font-style:italic>      echo &#39;DataBase OK ✓&#39;
</span><span style=color:#8f5902;font-style:italic>    else
</span><span style=color:#8f5902;font-style:italic>      until mysqladmin status -u${STORAGE_USER} -p${DB_PASSWORD} --host=${STORAGE_HOST} --port=${STORAGE_PORT}; do sleep 1; done
</span><span style=color:#8f5902;font-style:italic>    fi</span><span style=color:#f8f8f8;text-decoration:underline>    
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DB_PASSWORD</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>secretKeyRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{{<span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>include &#34;clusterpedia.mysql.storage.fullname&#34; . }}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>password</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>configMapRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{{<span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>include &#34;clusterpedia.mysql.storage.initContainer.env.name&#34; . }}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>{{- <span style=color:#000>end -}}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>clusterpedia-mysql 在 <a href=https://github.com/clusterpedia-io/clusterpedia-helm/blob/main/charts/clusterpedia-mysql/templates/storage-initcontainer-env-configmap.yaml>storage-initcontainer-env-configmap.yaml</a> 中定义了 init container 需要的环境变量</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{{<span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>include &#34;clusterpedia.mysql.storage.initContainer.env.name&#34; . }}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{{<span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>.Release.Namespace }}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{{<span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>include &#34;common.labels.standard&#34; . | nindent 4 }}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>STORAGE_HOST</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{{<span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>include &#34;clusterpedia.mysql.storage.host&#34; . | quote }}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>STORAGE_PORT</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{{<span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>include &#34;clusterpedia.mysql.storage.port&#34; . | quote }}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>STORAGE_USER</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{{<span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>include &#34;clusterpedia.mysql.storage.user&#34; . | quote }}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>STORAGE_DATABASE</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{{<span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>include &#34;clusterpedia.mysql.storage.database&#34; . | quote }}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>CREARE_DATABASE</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{{<span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>.Values.externalStorage.createDatabase | quote }}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>通过 <code>clusterpedia.storage.override.initContainers</code> 命名模版动态设置的 init container 会被渲染到 Deployment 中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># helm template clusterpedia -n clusterpedia-system --set persistenceMatchNode=None .</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>initContainers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ensure-database</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>docker.io/bitnami/mysql:8.0.28-debian-10-r23</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>command</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>/bin/sh</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- -<span style=color:#000>ec</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          if [ ${CREARE_DATABASE} = &#34;ture&#34; ]; then
</span><span style=color:#8f5902;font-style:italic>            until mysql -u${STORAGE_USER} -p${DB_PASSWORD} --host=${STORAGE_HOST} --port=${STORAGE_PORT} -e &#39;CREATE DATABASE IF NOT EXISTS ${STORAGE_DATABASE}&#39;; do
</span><span style=color:#8f5902;font-style:italic>            echo waiting for database check &amp;&amp; sleep 1;
</span><span style=color:#8f5902;font-style:italic>            done;
</span><span style=color:#8f5902;font-style:italic>            echo &#39;DataBase OK ✓&#39;
</span><span style=color:#8f5902;font-style:italic>          else
</span><span style=color:#8f5902;font-style:italic>            until mysqladmin status -u${STORAGE_USER} -p${DB_PASSWORD} --host=${STORAGE_HOST} --port=${STORAGE_PORT}; do sleep 1; done
</span><span style=color:#8f5902;font-style:italic>          fi</span><span style=color:#f8f8f8;text-decoration:underline>          
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DB_PASSWORD</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>secretKeyRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterpedia-mysql-storage</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>password</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>envFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>configMapRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>clusterpedia-mysql-storage-initcontainer-env</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>保存<code>存储插件</code>运行时配置 <em>config.yaml</em> 的 ConfigMap 和环境变量也是在 clusterpedia-mysql 中动态配置</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># _storage_override.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>{{- <span style=color:#000>define &#34;clusterpedia.storage.override.configmap.name&#34; -}}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>{{- <span style=color:#000>printf &#34;%s-mysql-storage-config&#34; .Release.Name -}}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>{{- <span style=color:#000>end -}}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>{{- <span style=color:#000>define &#34;clusterpedia.storage.override.componentEnv&#34; -}}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DB_PASSWORD</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>secretKeyRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{{<span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>include &#34;clusterpedia.mysql.storage.fullname&#34; . }}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>password</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>{{- <span style=color:#000>end -}}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>通过 values 静态覆盖和 命名模版的动态设置，存储层配置会被设置到 APIServer 和 ClusterSynchro Manager 的 Deployment 中</p>
<p>通过类似 <em>clusterpedia-mysql</em> 的<strong>高级 Chart</strong> 可以为用户屏蔽掉底层存储插件的使用，达到开箱即用。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-56dc2b1c45b2c6b0983526530ba75d01>5 - 特性功能</h1>
<p>用户在使用特性功能时，需要开启相应的特性门控。
例如开启 clustersynchro manager 的 <code>SyncAllResources</code> 来允许使用 <code>全资源通配符</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 忽略其他参数</span>
./bin/clustersynchro-manager --feature-gates<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>SyncAllResources</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</code></pre></div><p>Clusterpedia APIServer 和 Clusterpedia ClusterSynchro Manager 分别具有不同的特性门控</p>
<h2 id=apiserver>APIServer</h2>
<table>
<thead>
<tr>
<th>作用</th>
<th>feature gate</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href=./remaining-item-count>设置默认返回剩余的资源数量</a></td>
<td><code>RemainingItemCount</code></td>
<td>false</td>
</tr>
<tr>
<td><a href=./raw-sql-query>原生 SQL 查询</a></td>
<td><code>AllowRawSQLQuery</code></td>
<td>false</td>
</tr>
</tbody>
</table>
<h2 id=clustersynchro-manager>ClusterSynchro Manager</h2>
<table>
<thead>
<tr>
<th>作用</th>
<th>feature gate</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>裁剪 <code>metadata.managedFields</code> 字段</td>
<td><code>PruneManagedFields</code></td>
<td>true</td>
</tr>
<tr>
<td>裁剪 <code>metadata.annotations['lastAppliedConfiguration']</code> 字段</td>
<td><code>PruneLastAppliedConfiguration</code></td>
<td>true</td>
</tr>
<tr>
<td>允许同步所有类型的自定义资源</td>
<td><code>AllowSyncCustomResources</code></td>
<td>false</td>
</tr>
<tr>
<td>允许同步所有类型的资源</td>
<td><code>AllowSyncAllResources</code></td>
<td>false</td>
</tr>
<tr>
<td>集群健康检查使用独立 TCP 连接</td>
<td><code>HealthCheckerWithStandaloneTCP</code></td>
<td>false</td>
</tr>
</tbody>
</table>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-95ce10af379e7ffb7ad12d9d7acb553b>5.1 - 返回剩余资源数量</h1>
<p>我们在查询时，可以通过 search label 或者 url query，要求在响应中携带剩余的资源数量。</p>
<table>
<thead>
<tr>
<th>search label</th>
<th>url query</th>
</tr>
</thead>
<tbody>
<tr>
<td>search.clusterpedia.io/with-continue</td>
<td>withContinue</td>
</tr>
</tbody>
</table>
<blockquote>
<p>详细使用可以参考 <a href=../search/multi-cluster/#%E5%93%8D%E5%BA%94%E6%90%BA%E5%B8%A6%E5%89%A9%E4%BD%99%E8%B5%84%E6%BA%90%E6%95%B0%E9%87%8F%E4%BF%A1%E6%81%AF>响应携带剩余资源数量信息</a></p>
</blockquote>
<p>可以通过 Feature Gates —— <code>RemainingItemCount</code> 来设置默认返回剩余的资源数量，这样用户就不需要在每次请求时使用 search label 或者 url query 来显示要求了。</p>
<p>在默认返回剩余资源数量时，用于依然可以通过 search label 或者 url quera 来不返回剩余的资源数量</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis/apps/v1/deployments?withRemainingCount=false&amp;limit=1&#34;</span> <span style=color:#000;font-weight:700>|</span> jq
</code></pre></div><p><strong>专属于 <code>clusterpedia apiserver</code> 的 Feature Gate</strong></p>
<table>
<thead>
<tr>
<th>作用</th>
<th>feature gate</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>设置是否默认返回剩余的资源数量</td>
<td><code>RemainingItemCount</code></td>
<td>false</td>
</tr>
</tbody>
</table>
<p>由于该功能可能会对存储层的行为或者性能有影响，所以默认关闭</p>
<blockquote>
<p>对于默认存储层，返回剩余资源数量会导致额外的 COUNT 查询</p>
</blockquote>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-e22aa1b93a45ad065cfcba03e6c25c76>5.2 - 原生 SQL 查询</h1>
<p>不同的用户的需求可能是不同的，尽管 clusterpedia 提供了很多简便的检索条件，例如指定一组命名空间或者资源名称，也可以指定 owner 进行查询，但是用户依然可能会有更加复杂的查询。</p>
<p>这时，用户可以使用默认存储层提供的 <code>原生 SQL 条件查询</code> 来传递更加复杂的检索条件</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>URL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/apis/clusterpedia.io/v1beta1/resources/apis/apps/v1/deployments&#34;</span>
kubectl get --raw<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#000>$URL</span><span style=color:#4e9a06>?whereSQL=(cluster=&#39;global&#39;) OR (namespace IN (&#39;kube-system&#39;,&#39;default&#39;))&#34;</span>
</code></pre></div><p>示例中，我们传递一个用于 <em>WHERE</em> 查询的 SQL 语句 —— <strong>(cluster=&lsquo;global&rsquo;) OR (namespace IN (&lsquo;kube-system&rsquo;,&lsquo;default&rsquo;))</strong>,</p>
<p>这个语句会检索 <em>global</em> 集群内所有命名空间下以及其他集群中 <em>kube-system</em> 和 <em>default</em> 命名空间下的 <code>deployments</code>。</p>
<p><strong>sql 语句需要符合具体的存储组件的 SQL 语法</strong></p>
<p>该特性门控专属于 <code>clusterpedia apiserver</code></p>
<table>
<thead>
<tr>
<th>作用</th>
<th>feature gates</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>允许使用原生 SQL 设置检索条件</td>
<td><code>AllowRawSQLQuery</code></td>
<td>false</td>
</tr>
</tbody>
</table>
<p>原生 SQL 查询当前还在 alpha 阶段，并且对 SQL 注入没有很好的防范，所以需要用户通过 Feature Gates 来开启该功能</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b7b57e793e57798cc9bab1005a83932a>5.3 - 独立健康检查连接</h1>
<p>在 client-go 中使用相同的配置连接一个集群时，会使用同一条 TCP 连接
<a href=https://github.com/kubernetes/kubernetes/blob/3f823c0daa002158b12bfb2d53bcfe433516659d/staging/src/k8s.io/client-go/transport/transport.go#L54>https://github.com/kubernetes/kubernetes/blob/3f823c0daa002158b12bfb2d53bcfe433516659d/staging/src/k8s.io/client-go/transport/transport.go#L54</a></p>
<p>这导致集群的健康检查会和资源同步的 Informer 使用相同的 TCP。在大量资源 Informer 启动时，由于 TCP 阻塞可能会导致健康检查的请求超时，这时即使集群是健康的也会导致健康检查失败。</p>
<p>我们现在允许健康检查使用单独的一条 TCP 连接，这样资源同步时的 TCP 拥堵并不会影响到健康检查的响应。该功能需要开启 Feature Gate —— <code>HealthCheckerWithStandaloneTCP</code></p>
<table>
<thead>
<tr>
<th>作用</th>
<th>feature gates</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>集群健康检查使用独立 TCP 连接</td>
<td><code>HealthCheckerWithStandaloneTCP</code></td>
<td>false</td>
</tr>
</tbody>
</table>
<p><strong>注意：开启该功能后，连接到成员集群的 TCP 长连接会从 1 变成 2</strong>，如果接入 1000 个集群，那么 ClusterSynchro Manager 会维持 2000 条 TCP 连接。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-13a0f1b8db8e55183af8d01c55d9e128>5.4 - 资源字段裁剪</h1>
<p>资源的 metadata 中有一些字段在实际搜索中通常没有太大用处，所以在同步时我们会默认裁剪这些字段。</p>
<p>我们使用特性门控来分别控制这些字段是否在资源同步时被裁剪，<strong>这些特性门控专属于 <code>clustersynchro manager</code> 组件</strong></p>
<table>
<thead>
<tr>
<th>field</th>
<th>feature gates</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>metadata.managedFields</em></td>
<td><code>PruneManagedFields</code></td>
<td>true</td>
</tr>
<tr>
<td><em>metadata.annotations[&lsquo;lastAppliedConfiguration&rsquo;]</em></td>
<td><code>PruneLastAppliedConfiguration</code></td>
<td>true</td>
</tr>
</tbody>
</table>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3c4a7ba07443cd53a3dd0494f5a0ac77>5.5 - 同步所有的自定义资源</h1>
<p>自定义资源不同于 kube 的内置资源，kube 的内置资源通常不会经常性变动(依然有两种情况会导致原生资源类型资源改变)，
而自定义资源的类型可能会被动态的创建和删除</p>
<p>用户如果想要根据被纳管集群中的 CRD 的变动来自动调节同步的资源类型,那么用户在 PediaCluster 中指定同步所有自定义资源。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncAllCustomResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>该功能可能会导致大量的长连接，所以需要在 <code>clustersynchro manager</code> 中开启 Feature Gate</p>
<table>
<thead>
<tr>
<th>作用</th>
<th>feature gate</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>允许同步所有的自定义资源</td>
<td><code>AllowSyncAllCustomResources</code></td>
<td>true</td>
</tr>
</tbody>
</table>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-9dba7c100e86bba867d7df2e6a4ae266>5.6 - 同步所有的资源</h1>
<p>用户可以通过 <code>全资源通配符</code> 来同步所有类型的资源，当被纳管集群中发生任意的资源类型变动(例如 kube 版本升级，group/version 被禁用，CRD 或者 APIService 变动)都会导致同步的资源类型发生修改。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>syncResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><strong>请谨慎使用该功能，该功能会创建大量的长连接，未来 Clusterpedia 添加 Agent 功能后，可以避免长连接的创建</strong></p>
<p>建议指定具体的资源类型，如果需要对自定义资源进行动态同步，可以使用 <a href=../sync-all-custom-resources>同步所有的自定义资源</a></p>
<p>使用<code>全资源通配符</code> 需要在 <code>clustersynchro manager</code> 中开启 Feature Gate</p>
<table>
<thead>
<tr>
<th>作用</th>
<th>feature gate</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>允许同步所有的资源</td>
<td><code>AllowSyncAllResources</code></td>
<td>true</td>
</tr>
</tbody>
</table>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c9da5865a77748e4db7d4db31200b34f>6 - 版本日志</h1>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel=noopener href=https://github.com/clusterpedia-io aria-label=GitHub>
<i class="fab fa-github"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack>
<a class=text-white target=_blank rel=noopener href=https://cloud-native.slack.com/messages/clusterpedia aria-label=Slack>
<i class="fab fa-slack"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list">
<a class=text-white target=_blank rel=noopener href=mailto:clusterpedia@googlegroups.com aria-label="Developer mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2024 The Clusterpedia Authors 保留所有权利</small>
<p class=mt-2><a href=/zh-cn/about/>关于 Clusterpedia</a></p>
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.8ab8f81ff7e1454d30024cd6f956d4d341c3a97e2a673f988065f2ee4e147922.js integrity="sha256-irj4H/fhRU0wAkzW+VbU00HDqX4qZz+YgGXy7k4UeSI=" crossorigin=anonymous></script>
<script src=https://cdn.bootcdn.net/ajax/libs/asciinema-player/2.6.1/asciinema-player.min.js></script>
</body>
</html>